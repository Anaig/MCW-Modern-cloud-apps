<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Modern Cloud Apps – includes</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cloudworkshop.blob.core.windows.net/styles/labstyles.css"></link>
</head>
<body>
<p><img src="images/HeaderPic.png" title="Microsoft Cloud Workshops" /></p>
<div class="MCWHeader1">
<p>Modern cloud apps</p>
</div>
<div class="MCWHeader2">
<p>Hands-on lab unguided</p>
</div>
<div class="MCWHeader3">
<p>March 2018</p>
</div>
<p>Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.</p>
<p>Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.</p>
<p>The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein. © 2018 Microsoft Corporation. All rights reserved.</p>
<p>Microsoft and the trademarks listed at https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.</p>
<p><strong>Contents</strong> <!-- TOC --></p>
<ul>
<li><a href="#modern-cloud-apps-hands-on-lab-unguided">Modern cloud apps hands-on lab unguided</a>
<ul>
<li><a href="#abstract-and-learning-objectives">Abstract and learning objectives</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#solution-architecture">Solution architecture</a></li>
<li><a href="#help-references">Help references</a></li>
<li><a href="#exercise-1-proof-of-concept-deployment">Exercise 1: Proof of concept deployment</a>
<ul>
<li><a href="#task-1-deploy-the-e-commerce-website-sql-database-and-storage">Task 1: Deploy the e-commerce website, SQL Database, and storage</a></li>
<li><a href="#task-2-setup-sql-database-geo-replication">Task 2: Setup SQL Database Geo-Replication</a></li>
<li><a href="#task-3-deploying-the-call-center-admin-website">Task 3: Deploying the call center admin website</a></li>
<li><a href="#task-4-deploying-the-payment-gateway">Task 4: Deploying the payment gateway</a></li>
<li><a href="#task-5-deploying-the-offers-web-api">Task 5: Deploying the offers Web API</a></li>
<li><a href="#task-6-update-and-deploy-the-e-commerce-website">Task 6: Update and deploy the e-commerce website</a></li>
</ul></li>
<li><a href="#exercise-2-identity-and-security">Exercise 2: Identity and security</a>
<ul>
<li><a href="#task-1-enable-azure-ad-premium-trial">Task 1: Enable Azure AD Premium Trial</a></li>
<li><a href="#task-2-create-a-new-contoso-user">Task 2: Create a new Contoso user</a></li>
<li><a href="#task-3-configure-access-control-for-the-call-center-administration-web-application">Task 3: Configure access control for the call center administration Web Application</a></li>
<li><a href="#task-4-apply-custom-branding-for-the-azure-active-directory-logon-page">Task 4: Apply custom branding for the Azure Active Directory logon page</a></li>
<li><a href="#task-5-verify-the-user-can-successfully-login-to-the-admin-site">Task 5: Verify the user can successfully login to the admin site</a></li>
</ul></li>
<li><a href="#exercise-3-enable-azure-b2c-for-customer-site">Exercise 3: Enable Azure B2C for customer site</a>
<ul>
<li><a href="#task-1-create-a-new-directory">Task 1: Create a new directory</a></li>
<li><a href="#task-2-add-a-new-application">Task 2: Add a new application</a></li>
<li><a href="#task-3-create-policies-sign-up">Task 3: Create Policies, Sign up</a></li>
<li><a href="#task-4-create-a-sign-in-policy">Task 4: Create a sign-in policy</a></li>
<li><a href="#task-5-create-a-profile-editing-policy">Task 5: Create a profile editing policy</a></li>
<li><a href="#task-6-modify-the-contosoappsportsleagueweb">Task 6: Modify the Contoso.App.SportsLeague.Web</a></li>
<li><a href="#task-7-send-authentication-requests-to-azure-ad">Task 7: Send authentication requests to Azure AD</a></li>
<li><a href="#task-8-display-user-information">Task 8: Display user information</a></li>
<li><a href="#task-9-run-the-sample-app">Task 9: Run the sample app</a></li>
</ul></li>
<li><a href="#exercise-4-enabling-telemetry-with-application-insights">Exercise 4: Enabling Telemetry with Application Insights</a>
<ul>
<li><a href="#task-1-configure-the-application-for-telemetry">Task 1: Configure the application for telemetry</a> - <a href="#tasks-to-complete">Tasks to complete</a></li>
<li><a href="#task-2-creating-the-web-performance-test-and-load-test">Task 2: Creating the web performance test and load test</a> - <a href="#tasks-to-complete-1">Tasks to complete</a></li>
</ul></li>
<li><a href="#exercise-5-automating-backend-processes">Exercise 5: Automating backend processes</a>
<ul>
<li><a href="#task-1-create-an-azure-function-to-generate-pdf-receipts">Task 1: Create an Azure Function to Generate PDF Receipts</a> - <a href="#tasks-to-complete">Tasks to Complete</a></li>
<li><a href="#task-2-create-an-azure-logic-app-to-process-orders">Task 2: Create an Azure Logic App to Process Orders</a> - <a href="#tasks-to-complete-1">Tasks to Complete</a></li>
<li><a href="#task-3-use-twilio-to-send-sms-order-notifications">Task 3: Use Twilio to send SMS Order Notifications</a>
<ul>
<li><a href="#subtask-1-configure-your-twilio-trial-account">Subtask 1: Configure your Twilio trial account</a></li>
<li><a href="#subtask-2-create-a-new-logic-app">Subtask 2: Create a new logic app</a></li>
</ul></li>
</ul></li>
<li><a href="#after-the-hands-on-lab">After the hands-on lab</a>
<ul>
<li><a href="#task-1-delete-resources">Task 1: Delete resources</a></li>
</ul></li>
</ul></li>
</ul>
<!-- /TOC -->
<h1 id="modern-cloud-apps-hands-on-lab-unguided">Modern cloud apps hands-on lab unguided</h1>
<h2 id="abstract-and-learning-objectives">Abstract and learning objectives</h2>
<p>In this Microsoft Cloud Workshop, attendees will implement an end-to-end solution for e-commerce that is based on Azure App Services, Azure Active Directory, and Visual Studio Team Services. Attendees will ensure that appropriate security measures are put into place for both on-premises and public access scenarios.</p>
<p>Attendees will be better able to deploy and configure Azure Web Apps and associated services. In addition,</p>
<ul>
<li><p>Configure Web Apps for authentication with Azure AD</p></li>
<li><p>Instrument and load-test the application with App Insights</p></li>
<li><p>Automate backend services using Azure Functions and Logic Apps</p></li>
</ul>
<h2 id="overview">Overview</h2>
<p>The Modern cloud apps Hackathon is a hands-on exercise that will challenge you to implement an end-to-end scenario using a supplied sample that is based on Microsoft Azure App Services and related services. The scenario will include implementing compute, storage, security, and scale using various components of Microsoft Azure. The Hackathon can be implemented on your own, but it is highly recommended to pair up with other members at the Hackathon to model a real-world experience much closer and to allow each member to share their expertise for the overall solution.</p>
<h2 id="requirements">Requirements</h2>
<ol type="1">
<li><p>Microsoft Azure subscription</p></li>
<li><p>Local machine or a virtual machine configured with:</p>
<ol type="a">
<li>Visual Studio 2017 Community Edition</li>
</ol></li>
</ol>
<h2 id="solution-architecture">Solution architecture</h2>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image2.png" title="Solution Architecture Diagram" alt="A diagram that depicts the various Azure PaaS services for the solution. Azure AD Org is used for authentication to the call center app. Azure AD B2C for authentication is used for authentication to the client app. SQL Database for the backend customer data. Azure App Services for the web and API apps. Order processing includes using Functions, Logic Apps, Queues and Storage. Azure App Insights is used for telemetry capture." /><figcaption>A diagram that depicts the various Azure PaaS services for the solution. Azure AD Org is used for authentication to the call center app. Azure AD B2C for authentication is used for authentication to the client app. SQL Database for the backend customer data. Azure App Services for the web and API apps. Order processing includes using Functions, Logic Apps, Queues and Storage. Azure App Insights is used for telemetry capture.</figcaption>
</figure>
<h2 id="help-references">Help references</h2>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Description</strong></td>
<td style="text-align: center;"><strong>Links</strong></td>
</tr>
<tr class="even">
<td>SQL firewall</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-configure-firewall-settings/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/sql-database-configure-firewall-settings/</a></td>
</tr>
<tr class="odd">
<td>Deploying a Web App</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/web-sites-deploy/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/web-sites-deploy/</a></td>
</tr>
<tr class="even">
<td>Deploying an API app</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-dotnet-deploy-api-app/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-dotnet-deploy-api-app/</a></td>
</tr>
<tr class="odd">
<td>Accessing an API app from a JavaScript client</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-api-javascript-client/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-api-javascript-client/</a></td>
</tr>
<tr class="even">
<td>SQL Database Geo-Replication overview</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-geo-replication-overview/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/sql-database-geo-replication-overview/</a></td>
</tr>
<tr class="odd">
<td>What is Azure AD?</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/active-directory-whatis/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/active-directory-whatis/</a></td>
</tr>
<tr class="even">
<td>Azure Web Apps authentication</td>
<td style="text-align: center;"><a href="http://azure.microsoft.com/blog/2014/11/13/azure-websites-authentication-authorization/" class="uri">http://azure.microsoft.com/blog/2014/11/13/azure-websites-authentication-authorization/</a></td>
</tr>
<tr class="odd">
<td>View your access and usage reports</td>
<td style="text-align: center;"><a href="https://msdn.microsoft.com/en-us/library/azure/dn283934.aspx" class="uri">https://msdn.microsoft.com/en-us/library/azure/dn283934.aspx</a></td>
</tr>
<tr class="even">
<td>Custom branding an Azure AD Tenant</td>
<td style="text-align: center;"><a href="https://msdn.microsoft.com/en-us/library/azure/Dn532270.aspx" class="uri">https://msdn.microsoft.com/en-us/library/azure/Dn532270.aspx</a></td>
</tr>
<tr class="odd">
<td>Service Principal Authentication</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/app-service-api/app-service-api-dotnet-service-principal-auth" class="uri">https://docs.microsoft.com/en-us/azure/app-service-api/app-service-api-dotnet-service-principal-auth</a></td>
</tr>
<tr class="even">
<td>Consumer Site B2C</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-devquickstarts-web-dotnet" class="uri">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-devquickstarts-web-dotnet</a></td>
</tr>
<tr class="odd">
<td>Getting Started with Active Directory B2C</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/trial/get-started-active-directory-b2c/" class="uri">https://azure.microsoft.com/en-us/trial/get-started-active-directory-b2c/</a></td>
</tr>
<tr class="even">
<td>How to Delete an Azure Active Directory</td>
<td style="text-align: center;"><a href="https://blog.nicholasrogoff.com/2017/01/20/how-to-delete-an-azure-active-directory-add-tenant/" class="uri">https://blog.nicholasrogoff.com/2017/01/20/how-to-delete-an-azure-active-directory-add-tenant/</a></td>
</tr>
<tr class="odd">
<td>Run performance tests on your app</td>
<td style="text-align: center;"><a href="http://blogs.msdn.com/b/visualstudioalm/archive/2015/09/15/announcing-public-preview-for-performance-load-testing-of-azure-webapp.aspx" class="uri">http://blogs.msdn.com/b/visualstudioalm/archive/2015/09/15/announcing-public-preview-for-performance-load-testing-of-azure-webapp.aspx</a></td>
</tr>
<tr class="even">
<td>Application Insights Custom Events</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-api-custom-events-metrics/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-api-custom-events-metrics/</a></td>
</tr>
<tr class="odd">
<td>Enabling Application Insights</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-start-monitoring-app-health-usage/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-start-monitoring-app-health-usage/</a></td>
</tr>
<tr class="even">
<td>Detect failures</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-asp-net-exceptions/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-asp-net-exceptions/</a></td>
</tr>
<tr class="odd">
<td>Monitor performance problems</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-web-monitor-performance/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-web-monitor-performance/</a></td>
</tr>
<tr class="even">
<td>Creating a Logic App</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-create-a-logic-app/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-create-a-logic-app/</a></td>
</tr>
<tr class="odd">
<td>Logic app connectors</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-connectors-list/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-connectors-list/</a></td>
</tr>
<tr class="even">
<td>Logic Apps Docs</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-what-are-logic-apps" class="uri">https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-what-are-logic-apps</a></td>
</tr>
<tr class="odd">
<td>Azure Functions – create first function</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function" class="uri">https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function</a></td>
</tr>
<tr class="even">
<td>Azure Functions docs</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-azure-functions" class="uri">https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-azure-functions</a></td>
</tr>
</tbody>
</table>
<h2 id="exercise-1-proof-of-concept-deployment">Exercise 1: Proof of concept deployment</h2>
<p>Duration: 60 minutes</p>
<p>Contoso has asked you to create a proof of concept deployment in Microsoft Azure by deploying the web, database, and API applications for the solution as well as validating that the core functionality of the solution works. Ensure all resources use the same resource group previously created for the App Service Environment.</p>
<h3 id="task-1-deploy-the-e-commerce-website-sql-database-and-storage">Task 1: Deploy the e-commerce website, SQL Database, and storage</h3>
<p>In this exercise, you will provision a website via the Azure Web App + SQL template using the Microsoft Azure Portal. You will then edit the necessary configuration files in the starter project and deploy the e-commerce website.</p>
<p><em>Tasks to complete</em></p>
<ul>
<li><p>Create the resources in Microsoft Azure needed to deploy the e-commerce web app, database, and storage.</p></li>
<li><p>Specify the configuration settings to connect to the resources in the e-commerce Web App’s Application Settings in Azure.</p></li>
<li><p>Deploy the e-commerce application to Microsoft Azure.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li><p>The web application should display locally. (Right-click the project and click <strong>view in browser</strong>.)</p></li>
<li><p>The web application should display in Microsoft Azure by navigating to its [web app name]<strong>.azurewebsites.net</strong> URL.</p></li>
<li><p>Click the <strong>STORE</strong> link to ensure that connectivity to the database is successful.</p></li>
</ul>
<h3 id="task-2-setup-sql-database-geo-replication">Task 2: Setup SQL Database Geo-Replication</h3>
<p>In this exercise, the attendee will provision a secondary SQL Database and configure Geo-Replication using the Microsoft Azure Portal.</p>
<p><em>Tasks to complete</em></p>
<ul>
<li><p>Configure Readable Geo-Replication for the SQL Database created in Task 1 by setting up a Secondary database in the other Azure Region in the pair.</p></li>
<li><p>Force Failover to the Secondary database</p></li>
<li><p>Specify the connection string for the Secondary database in the e-commerce Web App’s Application Settings in Azure, and test the Web App</p></li>
<li><p>Revert the Failover test so the original database is Primary</p></li>
</ul>
<p>Manually forcing the Failover to the Secondary database is optional. The process of performing the Failover, testing it, then reverting back to the Primary database can take up to 30 minutes to complete. If you have time, it is recommended that you complete these steps.</p>
<p><em>Exit criteria</em></p>
<ul>
<li><p>The web application should display locally when connected to the Secondary database in the Failover test (Right-click the project and click <strong>view in browser</strong>.)</p></li>
<li><p>Click the <strong>STORE</strong> link to ensure that connectivity to the Secondary database is successful.</p></li>
<li><p>The web application should display locally when connected to the Primary database after the Failover test has been reverted.</p></li>
<li><p>Click the <strong>STORE</strong> link to ensure that connectivity to the Primary database is successful.</p></li>
</ul>
<h3 id="task-3-deploying-the-call-center-admin-website">Task 3: Deploying the call center admin website</h3>
<p>In this exercise, you will provision a website via the Azure Web App template using the Microsoft Azure Portal. You will then edit the necessary configuration files in the Starter Project and deploy the call center admin website.</p>
<p><em>Tasks to complete</em></p>
<ul>
<li><p>Create the resources in Microsoft Azure needs to deploy the call center admin website.</p></li>
<li><p>Specify the configuration settings to connect to the resources in the call center admin Web App’s Application Settings in Azure.</p></li>
<li><p>Deploy the call center admin website application to Microsoft Azure.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li><p>The web application should display locally. (Right-click the project and click <strong>view in browser</strong>.)</p></li>
<li><p>The web application should display in Microsoft Azure by navigating to its [web app name]<strong>.azurewebsites.net</strong> URL.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image11.png" title="Contoso Sports League Admin webpage" alt="The Contoso Sports League Admin webpage displays. Under Completed Orders, no orders display." /><figcaption>The Contoso Sports League Admin webpage displays. Under Completed Orders, no orders display.</figcaption>
</figure></li>
</ul>
<h3 id="task-4-deploying-the-payment-gateway">Task 4: Deploying the payment gateway</h3>
<p>In this exercise, the attendee will provision an Azure API app template using the Microsoft Azure Portal. The attendee will then deploy the payment gateway API to the API app.</p>
<p><em>Tasks to complete</em></p>
<ul>
<li>Create the resources in Microsoft Azure and deploy the payment gateway API application.</li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>Please note the URL of the deployed API app for future reference.</li>
</ul>
<h3 id="task-5-deploying-the-offers-web-api">Task 5: Deploying the offers Web API</h3>
<p>In this exercise, the attendee will provision an Azure API app template using the Microsoft Azure Portal. The attendee will then deploy the offers Web API.</p>
<p><em>Tasks to complete</em></p>
<ul>
<li><p>Create the resources in Microsoft Azure and deploy the offers API application.</p></li>
<li><p>Specify the configuration settings to connect to the created resources in the Web Apps Application Settings in Azure.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>Please note the URL of the deployed API app for future reference.</li>
</ul>
<h3 id="task-6-update-and-deploy-the-e-commerce-website">Task 6: Update and deploy the e-commerce website</h3>
<p>In this exercise, you will deploy the e-commerce web app and ensure all of the configuration to connect to the other services is correct.</p>
<p><em>Tasks to complete</em></p>
<ul>
<li><p>Update the e-commerce application to reference the new API applications.</p></li>
<li><p>Deploy the updated e-commerce site to the Azure website.</p></li>
<li><p>Verify the configuration by placing a test order on the e-commerce site and ensure the order appears on the admin site.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li><p>The web application should display locally.</p></li>
<li><p>The web application should display in Microsoft Azure by navigating to its [web app name]<strong>.azurewebsites.net</strong> URL.</p></li>
<li><p>The home page should render a list of products with images underneath the Today’s Offers heading.</p></li>
<li><p>The e-commerce application should render the products catalog without errors.</p></li>
<li><p>A test order should be rendered in the call center admin application after being submitted through the e-commerce site.</p></li>
</ul>
<h2 id="exercise-2-identity-and-security">Exercise 2: Identity and security</h2>
<p>Duration: 75 Minutes</p>
<p>The Contoso call center admin application will only be accessible by users of the Contoso Active Directory environment. You have been asked to create a new Azure AD Tenant and secure the application so only users from the tenant can log on.</p>
<p>Note: Tasks 1, 2, and 4 are optional and require global admin permissions on the Azure AD Tenant. Task 3 is also optional but does require the permission to create an app in the Azure AD tenant.</p>
<h3 id="task-1-enable-azure-ad-premium-trial">Task 1: Enable Azure AD Premium Trial</h3>
<p><em>Tasks to complete</em></p>
<ul>
<li>Enable Azure AD Premium on your existing Azure AD Tenant</li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>The Azure AD Premium SKU should be enabled on your subscription.</li>
</ul>
<h3 id="task-2-create-a-new-contoso-user">Task 2: Create a new Contoso user</h3>
<p><em>Tasks to complete</em></p>
<ul>
<li>Create a new user in your Azure AD tenant</li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>A new users to test your web application should be present in Azure AD</li>
</ul>
<h3 id="task-3-configure-access-control-for-the-call-center-administration-web-application">Task 3: Configure access control for the call center administration Web Application</h3>
<p><em>Tasks to complete</em></p>
<ul>
<li>Enable Azure AD authentication with your existing Azure AD tenant on the call center admin web app and validate you can log in with the new user within that tenant.</li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>The call center application should only allow users that log in through the customized Azure AD form access to the application.</li>
</ul>
<h3 id="task-4-apply-custom-branding-for-the-azure-active-directory-logon-page">Task 4: Apply custom branding for the Azure Active Directory logon page</h3>
<p><em>Tasks to complete</em></p>
<ul>
<li>Customize the branding by providing a banner and tile logo, a large illustration, and custom text, and then validate the branding is applied. The logo files can be found in the folder you extracted the starter files to.</li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>The custom branding should be displayed on the logon page.</li>
</ul>
<h3 id="task-5-verify-the-user-can-successfully-login-to-the-admin-site">Task 5: Verify the user can successfully login to the admin site</h3>
<p><em>Tasks to complete</em></p>
<ul>
<li>Login to the site using the new user created in Azure AD</li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>The new user should be able to login to the Call Center Admin site.</li>
</ul>
<h2 id="exercise-3-enable-azure-b2c-for-customer-site">Exercise 3: Enable Azure B2C for customer site</h2>
<p>Duration: 75 minutes</p>
<p>In this exercise, you will configure an Azure AD Business to Consumer (B2C) instance to enable authentication and policies for sign-in, sign-out and profile policies for the Contoso E-Commerce site.</p>
<p>Note: This portion of the hands-on lab is written in a lab format due to the complexity of the configuration.</p>
<h3 id="task-1-create-a-new-directory">Task 1: Create a new directory</h3>
<ol type="1">
<li><p>Log in to the Azure portal by using your existing Azure subscription or by starting a free trial. At the left bottom of the screen, click <strong>New</strong> <strong>&gt;</strong> <strong>Azure Active Directory B2C</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image12.png" title="Azure Portal" alt="In the Azure Portal, under New, in the search field is active directory B2C." /><figcaption>In the Azure Portal, under New, in the search field is active directory B2C.</figcaption>
</figure>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image13.png" title="Everything blade" alt="In the Everything blade, the active directory B2C text is in the Search field, and under Results, Azure Active Directory B2C displays." /><figcaption>In the Everything blade, the active directory B2C text is in the Search field, and under Results, Azure Active Directory B2C displays.</figcaption>
</figure></li>
<li><p>Enter for the name, <strong>ContosoB2C</strong> and a unique domain name and region. Click <strong>Create a new Azure AD B2C Tenant</strong>, and it will take a minute to complete. Click the link to manage your new B2C Directory.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image14.png" title="Azure Portal" alt="In the Azure Portal, under Create new B2C Tenant or Link to existing Tenant, Create a new Azure AD B2C Tenant is selected. On the right, the word &quot;here,&quot; whick is a link, is circled in the Click here to manage your new directory message." /><figcaption>In the Azure Portal, under Create new B2C Tenant or Link to existing Tenant, Create a new Azure AD B2C Tenant is selected. On the right, the word &quot;here,&quot; whick is a link, is circled in the Click here to manage your new directory message.</figcaption>
</figure></li>
<li><p>Click on the orange No Subscription message for instructions on how to link to an active subscription.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image15.png" title="Azure Portal" alt="In the Azure Portal, on the left, the &quot;No subscription linked to this B2C tenant or the Subscription needs your attention&quot; message is selected. On the right, under Subscription reminder, the three steps to link the B2C tenant to an Azure subscription are circled." /><figcaption>In the Azure Portal, on the left, the &quot;No subscription linked to this B2C tenant or the Subscription needs your attention&quot; message is selected. On the right, under Subscription reminder, the three steps to link the B2C tenant to an Azure subscription are circled.</figcaption>
</figure></li>
</ol>
<p>Note: Essentially, you will need to switch back to your previous Azure AD tenant, and then launch the Azure AD B2C creation wizard again.</p>
<ol start="4" type="1">
<li><p>Click on <strong>Link an existing Azure AD B2C Tenant to my Azure subscription,</strong> and select the Tenant you just created in the dropdown list and existing resource group. Press <strong>Create</strong>. <img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image16.png" title="Create new B2C Tenant or Link to existing Tenant" alt="In the Create new B2C Tenant or Link to existing Tenant blade, on the left, Link an existing Azure AD B2C Tenant to my Azure subscription is selected. On the right, in the Azure AD B2C Resource blade, the Azure AD B2C Tenant drop-down field is contosob2cdemo123.onmicrosoft.com. The Resource group is using the existing contososports." /></p></li>
<li><p>Open the new Azure AD B2C tenant.</p></li>
<li><p>Click on <strong>All Settings &gt; Applications &gt; +Add</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image17.png" title="Azure AD B2C Settings window" alt="In the Azure AD B2C Settings window, on the left, All Settings is selected. In the middle, under Settings, under Manage, Applications is selected. On the right, under Applications, the Add button is selected." /><figcaption>In the Azure AD B2C Settings window, on the left, All Settings is selected. In the middle, under Settings, under Manage, Applications is selected. On the right, under Applications, the Add button is selected.</figcaption>
</figure></li>
</ol>
<h3 id="task-2-add-a-new-application">Task 2: Add a new application</h3>
<ol type="1">
<li><p>Specify the following configuration options for the Web App:</p>
<ul>
<li><p>Name: Contoso B2C Application</p></li>
<li><p>Reply URL: https://[your web url].azurewebsites.net &lt;- this should be the HTTPS URL to the Contoso E-Commerce Site.</p></li>
<li><p>Include Web App / web API: Yes</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image18.png" title="New application" alt="The New application fields are set to the previously defined values." /><figcaption>The New application fields are set to the previously defined values.</figcaption>
</figure></li>
</ul></li>
<li><p>Click <strong>Create.</strong></p></li>
<li><p>Click the application you just created, and copy down the globally unique <strong>Application ID</strong> you will use later in your code.</p></li>
</ol>
<h3 id="task-3-create-policies-sign-up">Task 3: Create Policies, Sign up</h3>
<ol type="1">
<li><p>Open your Azure AD B2C Tenant in the Azure management portal.</p></li>
<li><p>To enable sign-up on your application, you will need to create a sign-up policy. This policy describes the experiences consumers will go through during sign-up and the contents of tokens the application will receive on successful sign-ups. Click <strong>Sign-up or sign-in policies</strong> as well as <strong>+Add</strong> at the top of the blade.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image19.png" title="Azure Portal" alt="In the Azure Portal, on the left, under Policies, Sign-up or sign-in policies is selected. On the right, the Add button is circled." /><figcaption>In the Azure Portal, on the left, under Policies, Sign-up or sign-in policies is selected. On the right, the Add button is circled.</figcaption>
</figure></li>
<li><p>The <strong>Name</strong> determines the sign-up policy name used by your application. For example, enter &quot;SiUp.&quot;</p></li>
<li><p>Click <strong>Identity providers</strong>, and select &quot;Email signup.&quot; Optionally, you can also select social identity providers (if previously configured for the tenant). Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image20.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade, Identity providers is selected. In the Select identity providers blade, Email signup is selected." /><figcaption>In the Add policy blade, Identity providers is selected. In the Select identity providers blade, Email signup is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Sign-up attributes</strong>. Here, you choose attributes you want to collect from the consumer during sign-up. For example, select &quot;Country/Region,&quot; &quot;Display Name&quot; and &quot;Postal Code.&quot; Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image21.png" title="Add policy and Select sign-up attributes blades" alt="In the Add policy blade, Sign-up attributes, with the message &quot;3 selected&quot; is selected. In the Select sign-up attributes blade, the following strings are selected: Country / Region, Display Name, and Postal Code." /><figcaption>In the Add policy blade, Sign-up attributes, with the message &quot;3 selected&quot; is selected. In the Select sign-up attributes blade, the following strings are selected: Country / Region, Display Name, and Postal Code.</figcaption>
</figure></li>
<li><p>Click <strong>Application claims</strong>. Here, you choose claims you want returned in the tokens sent back to your application after a successful sign-up experience. For example, select &quot;Display Name,&quot; &quot;Identity Provider,&quot; &quot;Postal Code,&quot; &quot;User is new&quot; and &quot;User's Object ID.&quot;</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image22.png" title="Add policy and Select application claims blades" alt="In the Add policy blade, Application claims with the message &quot;5 Selected&quot; is selected. In the Select application claims blade, the following five strings are selected: Display Name, Identity Provider, Postal Code, User is new, and User&#39;s Object ID." /><figcaption>In the Add policy blade, Application claims with the message &quot;5 Selected&quot; is selected. In the Select application claims blade, the following five strings are selected: Display Name, Identity Provider, Postal Code, User is new, and User's Object ID.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong>. Observe the policy just created appears as &quot;<strong>B2C_1_SiUp</strong>&quot; (the <strong>B2C_1_</strong> fragment is automatically added) in the <strong>Sign-up policies</strong> blade.</p></li>
<li><p>Open the policy by clicking &quot;<strong>B2C_1_SiUp</strong>.&quot;</p></li>
<li><p>Select <strong>&quot;Contoso B2C app&quot;</strong> in the <strong>Applications</strong> drop-down.</p></li>
<li><p>Click <strong>Run now</strong>. A new browser tab opens, and you can run through the consumer experience of signing up for your application.</p></li>
</ol>
<h3 id="task-4-create-a-sign-in-policy">Task 4: Create a sign-in policy</h3>
<p>To enable sign-in on your application, you will need to create a sign-in policy. This policy describes the experiences consumers will go through during sign-in and the contents of tokens the application will receive on successful sign-ins.</p>
<ol type="1">
<li><p>Click <strong>Sign-in policies</strong>.</p>
<p><img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image23.png" title="Policies section" alt="In the Policies section, Sign-in policies is selected." />s</p></li>
<li><p>Click <strong>+Add</strong> at the top of the blade.</p></li>
<li><p>The <strong>Name</strong> determines the sign-in policy name used by your application. For example, enter &quot;<strong>SiIn</strong>&quot; &lt;the 3<sup>rd</sup> letter is an upper case i&gt;.</p></li>
<li><p>Click <strong>Identity providers</strong> and select &quot;<strong>Local Account SignIn</strong>.&quot; Optionally, you can also select social identity providers, if already configured. Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image24.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade, Identity providers with the message &quot;1 Selected&quot; is selected. In the Select identity providers blade, Local Account SignIn is selected." /><figcaption>In the Add policy blade, Identity providers with the message &quot;1 Selected&quot; is selected. In the Select identity providers blade, Local Account SignIn is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Application claims</strong>. Here you choose claims that you want returned in the tokens sent back to your application after a successful sign-in experience. For example, select &quot;Display Name,&quot; &quot;Identity Provider,&quot; &quot;Postal Code,&quot; and &quot;User's Object ID.&quot; Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image25.png" title="Add policy and Select application claims blades" alt="In the Add policy blade, Application claims (4 Selected) is selected. In the Select application claims blade, the following five application claims are selected: Display Name, Identity Provider, Postal Code, and User&#39;s Object ID." /><figcaption>In the Add policy blade, Application claims (4 Selected) is selected. In the Select application claims blade, the following five application claims are selected: Display Name, Identity Provider, Postal Code, and User's Object ID.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong>. Observe the policy just created appears as &quot;<strong>B2C_1_SiIn</strong>&quot; (the <strong>B2C_1_</strong> fragment is automatically added) in the <strong>Sign-in policies</strong> blade.</p></li>
<li><p>Open the policy by clicking &quot;<strong>B2C_1_SiIn</strong>.&quot;</p></li>
<li><p>Select &quot;Contoso B2C app&quot; in the <strong>Applications</strong> drop-down.</p></li>
<li><p>Click <strong>Run now</strong>. A new browser tab opens, and you can run through the consumer experience of signing into your application.</p></li>
</ol>
<h3 id="task-5-create-a-profile-editing-policy">Task 5: Create a profile editing policy</h3>
<p>To enable profile editing on your application, you will need to create a profile editing policy. This policy describes the experiences that consumers will go through during profile editing and the contents of tokens that the application will receive on successful completion.</p>
<ol type="1">
<li><p>Click <strong>Profile editing policies</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image26.png" title="Policies section" alt="In the Policies section, Profile editing policies is selected." /><figcaption>In the Policies section, Profile editing policies is selected.</figcaption>
</figure></li>
<li><p>Click <strong>+Add</strong> at the top of the blade.</p></li>
<li><p>The Name determines the profile editing policy name used by your application. For example, enter &quot;SiPe.&quot;</p></li>
<li><p>Click Identity providers, and select &quot;<strong>Local Account SignIn</strong>.&quot; Optionally, you can also select social identity providers, if already configured. Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image27.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade, Identity providers (1 Selected) is selected. In the Select identity providers blade, Local Account SignIn is selected." /><figcaption>In the Add policy blade, Identity providers (1 Selected) is selected. In the Select identity providers blade, Local Account SignIn is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Profile attributes</strong>. Here, you choose attributes the consumer can view and edit. For example, select &quot;Country/Region,&quot; &quot;Display Name,&quot; “Job Title,&quot; &quot;Postal Code,&quot;”State/Province,&quot; and “Street Address.” Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image28.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade,Profile attributes (6 Selected) is selected. In the Profile attributes blade, the following six profile attributes are selected: Country / Region, Display Name, Job Title, Postal Code, State / Province, and Street Address." /><figcaption>In the Add policy blade,Profile attributes (6 Selected) is selected. In the Profile attributes blade, the following six profile attributes are selected: Country / Region, Display Name, Job Title, Postal Code, State / Province, and Street Address.</figcaption>
</figure></li>
<li><p>Click <strong>Application claims</strong>. Here, you choose claims you want returned in the tokens sent back to your application after a successful profile editing experience. For example, select &quot;Display Name&quot; and &quot;Postal Code.&quot;</p></li>
<li><p>Click <strong>Create</strong>. Observe the policy just created appears as &quot;<strong>B2C_1_SiPe</strong>&quot; (the <strong>B2C_1_</strong> fragment is automatically added) in the <strong>Profile editing policies</strong> blade.</p></li>
<li><p>Open the policy by clicking &quot;<strong>B2C_1_SiPe</strong>.&quot;</p></li>
<li><p>Select &quot;Contoso B2C app&quot; in the <strong>Applications</strong> drop-down.</p></li>
<li><p>Click <strong>Run now</strong>. A new browser tab opens, and you can run through the profile editing consumer experience in your application.</p></li>
</ol>
<h3 id="task-6-modify-the-contoso.app.sportsleague.web">Task 6: Modify the Contoso.App.SportsLeague.Web</h3>
<ol type="1">
<li><p>Within Visual Studio, click on <strong>View -&gt; Other Windows -&gt; Package Manager Console</strong>. Execute the following commands to install these the required NuGet Packages.</p>
<pre><code>Install-Package Microsoft.Owin.Security.OpenIdConnect -Version 3.0.1
Install-Package Microsoft.Owin.Security.Cookies -Version 3.0.1
Install-Package Microsoft.Owin.Host.SystemWeb -Version 3.0.1
Install-Package Microsoft.IdentityModel.Protocol.Extensions -Version 1.0.4.403061554</code></pre></li>
<li><p>Next, using the Azure Management Portal, open the Contoso E-Commerce Site, and click on App Settings.</p></li>
<li><p>Add the following settings:</p>
<ul>
<li><p>ida:Tenant - [your Azure AD B2C name].onmicrosoft.com</p></li>
<li><p>ida:ClientId – [the client/app ID from your app]</p></li>
<li><p>ida:RedirectUri - https://[your web url].azurewebsites.net</p></li>
<li><p>ida:SignupPolicyId – B2C_1_SiUp</p></li>
<li><p>ida:SignInPolicyId – B2C_1_SiIn &lt;the 3<sup>rd</sup> letter is an upper case i&gt;</p></li>
<li><p>ida:UserProfilePolicyId – B2C_1_SiPe</p></li>
<li><p>ida:AadInstance - https://login.microsoftonline.com/{0}/v2.0/.well-known/openid-configuration?p={1}</p></li>
</ul>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image29.png" title="App settings" alt="In the App settings section, the previously mentioned settings are circled." /><figcaption>In the App settings section, the previously mentioned settings are circled.</figcaption>
</figure></li>
<li><p>Click <strong>Save</strong> when you are complete.</p></li>
<li><p>Within Visual Studio, <strong>right</strong> click on the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and click <strong>Add -&gt; New Item.</strong></p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image30.png" title="Solution Explorer" alt="In Solution Explorer, the Web folder is expanded, and Contoso.Apps.SportsLeague.Web is selected. From its right-click menu, Add is selected, and from its menu, New item is selected." /><figcaption>In Solution Explorer, the Web folder is expanded, and Contoso.Apps.SportsLeague.Web is selected. From its right-click menu, Add is selected, and from its menu, New item is selected.</figcaption>
</figure></li>
<li><p>In the Search Installed Templates search box search for OWIN. Click the OWIN Startup class, change the name to <strong>Startup.cs,</strong> and then click <strong>Add</strong>.</p></li>
<li><p>In the new class, insert the word partial in between public and class to make this a partial class.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image31.png" title="New class section" alt="In the New class section, the word &quot;partial&quot; is circled in the line, &quot;public partial class Startup&quot;." /><figcaption>In the New class section, the word &quot;partial&quot; is circled in the line, &quot;public partial class Startup&quot;.</figcaption>
</figure></li>
<li><p>Add the following code between the brackets of the Configuration method.</p>
<pre><code>ConfigureAuth(app);

// Startup.cs

public partial class Startup

{

public void Configuration(IAppBuilder app)

{

ConfigureAuth(app);

}

}</code></pre></li>
</ol>
<p>Note: The OWIN middleware will invoke the Configuration(...) method when your app starts.</p>
<ol start="9" type="1">
<li><p>Right click on the <strong>App_Start</strong> folder, and click <strong>Add -&gt; Class</strong>.<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image32.png" title="Solution Explorer" alt="In Solution Explorer, on the App Start folder&#39;s right-click menu, Add is selected, and from its menu, Class is selected." /></p></li>
<li><p>Select <strong>Visual C# and Class,</strong> and name the new file <strong>Startup.Auth.cs</strong>.<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image33.png" title="Installed and Sort by fields" alt="In the Installed field, Visual C# is selected. In the Sort by field, Class is selected." /></p></li>
<li><p>Replace the entire contents of Startup.Auth.cs with the following code:</p>
<pre><code>// App\_Start\\Startup.Auth.cs

using System;

using Owin;

using Microsoft.Owin.Security;

using Microsoft.Owin.Security.Cookies;

using Microsoft.Owin.Security.OpenIdConnect;

using System.Threading.Tasks;

using Microsoft.Owin.Security.Notifications;

using Microsoft.IdentityModel.Protocols;

using System.Configuration;

using System.IdentityModel.Tokens;

using System.Web.Helpers;

using System.IdentityModel.Claims;

namespace Contoso.Apps.SportsLeague.Web

{

public partial class Startup

{

// App config settings

private static string clientId = ConfigurationManager.AppSettings\[\&quot;ida:ClientId\&quot;\];

private static string aadInstance = ConfigurationManager.AppSettings\[\&quot;ida:AadInstance\&quot;\];

private static string tenant = ConfigurationManager.AppSettings\[\&quot;ida:Tenant\&quot;\];

private static string redirectUri = ConfigurationManager.AppSettings\[\&quot;ida:RedirectUri\&quot;\];

// B2C policy identifiers

public static string SignUpPolicyId = ConfigurationManager.AppSettings\[\&quot;ida:SignUpPolicyId\&quot;\];

public static string SignInPolicyId = ConfigurationManager.AppSettings\[\&quot;ida:SignInPolicyId\&quot;\];

public static string ProfilePolicyId = ConfigurationManager.AppSettings\[\&quot;ida:UserProfilePolicyId\&quot;\];

public void ConfigureAuth(IAppBuilder app)

{

app.SetDefaultSignInAsAuthenticationType(CookieAuthenticationDefaults.AuthenticationType);

app.UseCookieAuthentication(new CookieAuthenticationOptions());

// Configure OpenID Connect middleware for each policy

app.UseOpenIdConnectAuthentication(CreateOptionsFromPolicy(SignUpPolicyId));

app.UseOpenIdConnectAuthentication(CreateOptionsFromPolicy(ProfilePolicyId));

app.UseOpenIdConnectAuthentication(CreateOptionsFromPolicy(SignInPolicyId));

AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;

}

// Used for avoiding yellow-screen-of-death

private Task AuthenticationFailed(AuthenticationFailedNotification\&lt;OpenIdConnectMessage, OpenIdConnectAuthenticationOptions\&gt; notification)

{

notification.HandleResponse();

if (notification.Exception.Message == \&quot;access\_denied\&quot;)

{

notification.Response.Redirect(\&quot;/\&quot;);

}

else

{

notification.Response.Redirect(\&quot;/Home/Error?message=\&quot; + notification.Exception.Message);

}

return Task.FromResult(0);

}

private OpenIdConnectAuthenticationOptions CreateOptionsFromPolicy(string policy)

{

return new OpenIdConnectAuthenticationOptions

{

// For each policy, give OWIN the policy-specific metadata address, and

// set the authentication type to the id of the policy

MetadataAddress = String.Format(aadInstance, tenant, policy),

AuthenticationType = policy,

// These are standard OpenID Connect parameters, with values pulled from web.config

ClientId = clientId,

RedirectUri = redirectUri,

PostLogoutRedirectUri = redirectUri,

Notifications = new OpenIdConnectAuthenticationNotifications

{

AuthenticationFailed = AuthenticationFailed,

},

Scope = \&quot;openid\&quot;,

ResponseType = \&quot;id\_token\&quot;,

// This piece is optional - it is used for displaying the user\&#39;s name in the navigation bar.

TokenValidationParameters = new TokenValidationParameters

{

NameClaimType = \&quot;name\&quot;,

},

};

}

}

}</code></pre></li>
</ol>
<p>Note: The parameters you provide in OpenIdConnectAuthenticationOptions serve as coordinates for your app to communicate with Azure AD. You also need to set up cookie authentication. The OpenID Connect middleware uses cookies to maintain user sessions, among other things.</p>
<h3 id="task-7-send-authentication-requests-to-azure-ad">Task 7: Send authentication requests to Azure AD</h3>
<p>Your app is now properly configured to communicate with Azure AD B2C by using the OpenID Connect authentication protocol. OWIN has taken care of all of the details of crafting authentication messages, validating tokens from Azure AD, and maintaining user session. All that remains is to initiate each user's flow.</p>
<ol type="1">
<li><p>Right click on the <strong>Controllers</strong> folder, and click <strong>Add</strong> -&gt; <strong>Controller</strong>. <img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image34.png" title="Solution Explorer" alt="In Solution Explorer, in the right-click menu for the Controllers folder, Add is selected, and from its menu, Controller is selected." /></p></li>
<li><p>Select <strong>MVC 5 Controller – Empty, and click Add.</strong> Replace <strong>Default</strong> with <strong>Account</strong> for the controller name.<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image35.png" title="Add Scaffold window" alt="On the left of the Add Scaffold window, Installed / Controller is selected. In the center of the window, MVC 5 Controller - Empty is selected." /></p></li>
<li><p>Add the following using statement to the top of the controller:</p>
<pre><code>using Microsoft.Owin.Security;</code></pre></li>
<li><p>Replace the default controller method Index</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image36.png" title="Default controller method Index" alt="The Default controller method Index is circled." /><figcaption>The Default controller method Index is circled.</figcaption>
</figure>
<p>With the following code:</p>
<pre><code>// Controllers\\AccountController.cs

public void SignIn()

{

if (!Request.IsAuthenticated)

{

// To execute a policy, you simply need to trigger an OWIN challenge.

// You can indicate which policy to use by specifying the policy id as the AuthenticationType

HttpContext.GetOwinContext().Authentication.Challenge(

new AuthenticationProperties () { RedirectUri = \&quot;/\&quot; }, Startup.SignInPolicyId);

}

}

public void SignUp()

{

if (!Request.IsAuthenticated)

{

HttpContext.GetOwinContext().Authentication.Challenge(

new AuthenticationProperties() { RedirectUri = \&quot;/\&quot; }, Startup.SignUpPolicyId);

}

}

public void Profile()

{

if (Request.IsAuthenticated)

{

HttpContext.GetOwinContext().Authentication.Challenge(

new AuthenticationProperties() { RedirectUri = \&quot;/\&quot; }, Startup.ProfilePolicyId);

}

}</code></pre></li>
<li><p>You can also use OWIN to sign out the user from the app. Add the following method to the account controller (<strong>Controllers\AccountController.cs</strong>):</p>
<pre><code>C\# Copy</code></pre>
<pre><code>// Controllers\\AccountController.cs

public void SignOut()

{

// To sign out the user, you should issue an OpenIDConnect sign out request

if (Request.IsAuthenticated)

{

IEnumerable\&lt;AuthenticationDescription\&gt; authTypes = HttpContext.GetOwinContext().Authentication.GetAuthenticationTypes();

HttpContext.GetOwinContext().Authentication.SignOut(authTypes.Select(t =\&gt; t.AuthenticationType).ToArray());

Request.GetOwinContext().Authentication.GetAuthenticationTypes();

}

}</code></pre></li>
</ol>
<h3 id="task-8-display-user-information">Task 8: Display user information</h3>
<p>When you authenticate users by using OpenID Connect, Azure AD returns an ID token to the app that contains <strong>claims</strong>. These are assertions about the user. You can use claims to personalize your app. You can access user claims in your controllers via the ClaimsPrincipal.Current security principal object.</p>
<ol type="1">
<li><p>Open the <strong>Controllers\HomeController.cs file</strong> and add the following using statements at the end of the other using statements.</p>
<pre><code>using System.Linq;

using System.Security.Claims;</code></pre></li>
<li><p>Open the <strong>Controllers\HomeController.cs</strong> file and add the following method:</p>
<pre><code>\[Authorize\]

public ActionResult Claims()

{

Claim displayName = ClaimsPrincipal.Current.FindFirst(ClaimsPrincipal.Current.Identities.First().NameClaimType);

ViewBag.DisplayName = displayName != null ? displayName.Value : string.Empty;

return View();

}</code></pre></li>
<li><p>You can access any claim that your application receives in the same way. A list of all the claims the app receives is available for you on the <strong>Claims</strong> page. Right click on <strong>Views -&gt; Home,</strong> click <strong>Add -&gt; MVC 5 View Page (Razor)</strong> and name it <strong>Claims.</strong> <img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image37.png" title="Solution Explorer" alt="In Solution Explorer, on the right-click menu for Views\Home, Add is selected, and from its menu, MVC 5 View Page (Razor) is selected." /></p></li>
<li><p>Open the <strong>Claims.cshtml</strong> file and replace the code with the following:</p>
<pre><code>\@using System.Security.Claims

@{

ViewBag.Title = \&quot;Claims\&quot;;

}

\&lt;h2\&gt;\@ViewBag.Title\&lt;/h2\&gt;

\&lt;h4\&gt;Claims Present in the Claims Identity: \@ViewBag.DisplayName\&lt;/h4\&gt;

\&lt;table class=\&quot;table-hover claim-table\&quot;\&gt;

\&lt;tr\&gt;

\&lt;th class=\&quot;claim-type claim-data claim-head\&quot;\&gt;Claim Type\&lt;/th\&gt;

\&lt;th class=\&quot;claim-data claim-head\&quot;\&gt;Claim Value\&lt;/th\&gt;

\&lt;/tr\&gt;

\@foreach (Claim claim in ClaimsPrincipal.Current.Claims)

{

\&lt;tr\&gt;

\&lt;td class=\&quot;claim-type claim-data\&quot;\&gt;\@claim.Type\&lt;/td\&gt;

\&lt;td class=\&quot;claim-data\&quot;\&gt;\@claim.Value\&lt;/td\&gt;

\&lt;/tr\&gt;

}

\&lt;/table\&gt;</code></pre></li>
<li><p>Right click on the <strong>Views -&gt; Shared</strong> folder, click <strong>Add</strong>, and add a new <strong>MVC 5 Partial Page (Razor)</strong>. Specify <strong>_LoginPartial</strong> for the name.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image38.png" title="Solution Explorer" alt="In Solution Explorer, on the right-click menu for Views\Shared, Add is selected, and from its menu, MVC 5 Partial Page (Razor) is selected." /><figcaption>In Solution Explorer, on the right-click menu for Views\Shared, Add is selected, and from its menu, MVC 5 Partial Page (Razor) is selected.</figcaption>
</figure></li>
<li><p>Add the following code to the razor partial view to provide a sign-in and sign-out link as well as a link to edit the user’s profile.</p>
<pre><code>\@if (Request.IsAuthenticated)

{

\&lt;text\&gt;

\&lt;ul class=\&quot;nav navbar-nav navbar-right\&quot;\&gt;

\&lt;li\&gt;

\&lt;a id=\&quot;profile-link\&quot;\&gt;\@User.Identity.Name\&lt;/a\&gt;

\&lt;div id=\&quot;profile-options\&quot; class=\&quot;nav navbar-nav navbar-right\&quot;\&gt;

\&lt;ul class=\&quot;profile-links\&quot;\&gt;

\&lt;li class=\&quot;profile-link\&quot;\&gt;

\@Html.ActionLink(\&quot;Edit Profile\&quot;, \&quot;Profile\&quot;, \&quot;Account\&quot;)

\&lt;/li\&gt;

\&lt;/ul\&gt;

\&lt;/div\&gt;

\&lt;/li\&gt;

\&lt;li\&gt;

\@Html.ActionLink(\&quot;Sign out\&quot;, \&quot;SignOut\&quot;, \&quot;Account\&quot;)

\&lt;/li\&gt;

\&lt;/ul\&gt;

\&lt;/text\&gt;

}

else

{

\&lt;ul class=\&quot;nav navbar-nav navbar-right\&quot;\&gt;

\&lt;li\&gt;\@Html.ActionLink(\&quot;Sign up\&quot;, \&quot;SignUp\&quot;, \&quot;Account\&quot;, routeValues: null, htmlAttributes: new { id = \&quot;signUpLink\&quot; })\&lt;/li\&gt;

\&lt;li\&gt;\@Html.ActionLink(\&quot;Sign in\&quot;, \&quot;SignIn\&quot;, \&quot;Account\&quot;, routeValues: null, htmlAttributes: new { id = \&quot;loginLink\&quot; })\&lt;/li\&gt;

\&lt;/ul\&gt;

}</code></pre></li>
<li><p>Open Views\Shared\_Layout.cshtml in Visual Studio. Locate the header-tap div. and add the two lines highlighted.</p>
<pre><code>\&lt;div class=\&quot;header-top\&quot;\&gt;

\&lt;div class=\&quot;container\&quot;\&gt;

\&lt;div class=\&quot;row\&quot;\&gt;

\&lt;div class=\&quot;header-top-left\&quot;\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-twitter\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-facebook\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-linkedin\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-instagram\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;/div\&gt;

\&lt;div class=\&quot;header-top-right\&quot;\&gt;

\&lt;a href=\&quot;\#\&quot; class=\&quot;top-wrap\&quot;\&gt;\&lt;span class=\&quot;icon-phone\&quot;\&gt;Call today: \&lt;/span\&gt; (555) 555-8000\&lt;/a\&gt;

\@Html.ActionLink(\&quot;Claims\&quot;, \&quot;Claims\&quot;, \&quot;Home\&quot;)

\&lt;/div\&gt;

\@Html.Partial(\&quot;\_LoginPartial\&quot;)

\&lt;/div\&gt;

\&lt;/div\&gt;

\&lt;/div\&gt;</code></pre></li>
</ol>
<h3 id="task-9-run-the-sample-app">Task 9: Run the sample app</h3>
<ol type="1">
<li>Right click on the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and click <strong>Publish</strong>. Follow the steps to deploy the updated application to the Microsoft Azure Web App.</li>
</ol>
<p>Launch a browser outside of Visual Studio for testing if the page loads in Visual Studio.</p>
<ol start="2" type="1">
<li><p>Test out Sign up. Next, test Sign out.</p></li>
<li><p>When you click on Claims and are not signed in, it will bring you to the sign-in page and then display the claim information. Sign in, and test Edit Profile.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image39.png" title="Contoso website" alt="On the Contoso website, the following links are circled: Claims, Sign up, and Sign in." /><figcaption>On the Contoso website, the following links are circled: Claims, Sign up, and Sign in.</figcaption>
</figure>
<p>Claims information page<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image40.png" title="Contoso website, Claims information page" alt="On the Contoso website, the following links are circled: Russell, Sign out, and Edit Profile." /></p></li>
</ol>
<h2 id="exercise-4-enabling-telemetry-with-application-insights">Exercise 4: Enabling Telemetry with Application Insights</h2>
<p>To validate the scalability of the application and to configure telemetry, you have been asked to configure Microsoft Azure Application Insights and perform a web load test using Visual Studio Online.</p>
<h3 id="task-1-configure-the-application-for-telemetry">Task 1: Configure the application for telemetry</h3>
<h5 id="tasks-to-complete">Tasks to complete</h5>
<ul>
<li><p>Configure a method to capture telemetry information for the application for the server and client side.</p></li>
<li><p>Complete the implementation of the TrackException and TrackEvent method in Helpers\TelemetryHelper.cs.</p></li>
<li><p>Republish the web application with telemetry enabled.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>Verify that when you browse to the website, the telemetry data appears.</li>
</ul>
<h3 id="task-2-creating-the-web-performance-test-and-load-test">Task 2: Creating the web performance test and load test</h3>
<h5 id="tasks-to-complete-1">Tasks to complete</h5>
<ul>
<li><p>Submit several test orders to verify that telemetry is capturing custom events.</p></li>
<li><p>Simulate a load test of at least 250 users browsing the home page over a 5-minute time frame.</p></li>
<li><p>Use the monitoring capabilities of your telemetry solution to identify failures from the test (if any).</p></li>
<li><p>Use the monitoring capabilities of your telemetry solution to identify performance issues from the test.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li><p>You should be able to view the average response time for the simulated load test.</p></li>
<li><p>The telemetry solution should show custom events captured by the application such as new orders.</p></li>
<li><p>The telemetry solution should show performance numbers such as the number of sessions and average response time.</p></li>
</ul>
<h2 id="exercise-5-automating-backend-processes">Exercise 5: Automating backend processes</h2>
<p>Contoso wants to automate the process of generating receipts in PDF format and alerting users when their orders have been processed.</p>
<h3 id="task-1-create-an-azure-function-to-generate-pdf-receipts">Task 1: Create an Azure Function to Generate PDF Receipts</h3>
<h5 id="tasks-to-complete-2">Tasks to Complete</h5>
<ul>
<li><p>Create an Azure Function in the contososports resource group using the assets in C:\Hackathon\Contoso Sports League\Contoso.CreatePDFReport</p></li>
<li><p>Execute the function using the example data in Sample.dat to validate it generates a PDF in your storage account.</p></li>
<li><p>Use Storage Explorer or Visual Studio to view the generated PDF file.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li>You should have a function that accepts the format specified in Sample.dat and generates a PDF file in the storage account for the Contoso Sports solution.</li>
</ul>
<h3 id="task-2-create-an-azure-logic-app-to-process-orders">Task 2: Create an Azure Logic App to Process Orders</h3>
<h5 id="tasks-to-complete-3">Tasks to Complete</h5>
<ul>
<li><p>Create an Azure Logic App that listens for new orders on the receiptgenerator storage queue.</p></li>
<li><p>When a new message is received pass it to the Azure Function using the same syntax as the sample.dat file.</p>
<ul>
<li>Hint: the following can be used to base64 encode the data</li>
</ul>
<pre><code>\&quot;Order\&quot;: \&quot;@{base64(triggerBody()?\[\&#39;MessageText\&#39;\])}\&quot;</code></pre></li>
<li><p>After the receipt is generated the order row should be updated HasBeenShipped value and the link to the receipt so the admin app can display it correctly.</p>
<ul>
<li>Hint the following values will need to be updated in SQL:</li>
</ul>
<pre><code>\&quot;OrderDate\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;OrderDate\&#39;\]}\&quot;,

\&quot;FirstName\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;FirstName\&#39;\]}\&quot;,

\&quot;LastName\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;LastName\&#39;\]}\&quot;,

\&quot;Address\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Address\&#39;\]}\&quot;,

\&quot;City\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;City\&#39;\]}\&quot;,

\&quot;State\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;State\&#39;\]}\&quot;,

\&quot;PostalCode\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;PostalCode\&#39;\]}\&quot;,

\&quot;Country\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Country\&#39;\]}\&quot;,

\&quot;Phone\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Phone\&#39;\]}\&quot;,

\&quot;SMSOptIn\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;SMSOptIn\&#39;\]}\&quot;,

\&quot;SMSStatus\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;SMSStatus\&#39;\]}\&quot;,

\&quot;Email\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Email\&#39;\]}\&quot;,

\&quot;ReceiptUrl\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;ReceiptUrl\&#39;\]}\&quot;,

\&quot;Total\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Total\&#39;\]}\&quot;,

\&quot;PaymentTransactionId\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;PaymentTransactionId\&#39;\]}\&quot;,

\&quot;HasBeenShipped\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;HasBeenShipped\&#39;\]}\&quot;</code></pre>
<pre><code>\&quot;path\&quot;: \&quot;/datasets/default/tables/@{encodeURIComponent(encodeURIComponent(\&#39;\[dbo\].\[Orders\]\&#39;))}/items/@{encodeURIComponent(encodeURIComponent(body(\&#39;ContosoMakePDF\&#39;)\[\&#39;OrderId\&#39;\]))}\&quot;</code></pre></li>
<li><p>An action will need to be added to remove the message from the queue so it is not processed multiple times.</p></li>
</ul>
<p><em>Exit criteria</em></p>
<ul>
<li><p>A PDF receipt should be generated each time an order is created on the website.</p></li>
<li><p>The order should only be processed once.</p></li>
<li><p>The receipt should be downloadable from the admin website.</p></li>
</ul>
<h3 id="task-3-use-twilio-to-send-sms-order-notifications">Task 3: Use Twilio to send SMS Order Notifications</h3>
<p>Note: This portion of the task is added inline due to the complexity involved.</p>
<h4 id="subtask-1-configure-your-twilio-trial-account">Subtask 1: Configure your Twilio trial account</h4>
<ol type="1">
<li><p>If you do not have a Twilio account, sign up for one for free at the following URL:??<br />
<a href="https://www.twilio.com/try-twilio"><strong>https://www.twilio.com/try-twilio</strong></a>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image41.png" title="Twilio account Sign up webpage" alt="Screenshot of the Twilio account Sign up for free webpage." /><figcaption>Screenshot of the Twilio account Sign up for free webpage.</figcaption>
</figure></li>
<li><p>When you sign up for a free Twilio trial, you will be asked to verify your personal phone number. This is an important security step that is mandatory for trying Twilio.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image42.png" title="Verification prompt" alt="On the Verification prompt, the &quot;We need to verify you&#39;re a human&quot; message displays. Under that is a phone number field, and a Verify via SMS button." /><figcaption>On the Verification prompt, the &quot;We need to verify you're a human&quot; message displays. Under that is a phone number field, and a Verify via SMS button.</figcaption>
</figure></li>
<li><p>Click <strong>All Products &amp; Services</strong>.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image43.png" title="Console" alt="In the Console, under Home, the All Products and Services (ellipses) button is selected." /></p></li>
<li><p>Click on <strong>Phone Numbers</strong>.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image44.png" title="Console" alt="On the Console, under Numbers, Phone Numbers is selected." /></p></li>
<li><p>Click <strong>Get Started</strong>.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image45.png" title="Console" alt="On the Console, under Phone Nunbers, the Get Started button is selected." /></p></li>
<li><p>Click the <strong>Get your first Twilio phone number</strong> button.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image46.png" title="Get Started with Phone Numbers prompt" alt="On the Get Started with Phone Numbers prompt, the Get your first Twilio phone number button displays." /></p></li>
<li><p>Record the <strong>Phone Number</strong>, click the <strong>Choose this Number</strong> button on the <strong>Your first Twilio Phone Number</strong> prompt, and click <strong>Done.</strong><br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image47.png" title="Your first Twilio Phone Number prompt" alt="On the Your first Twilio Phone Number prompt, the number is obscured." /></p></li>
<li><p>Click on <strong>Home</strong>, record the <strong>Account SID</strong> and <strong>Auth Token</strong> for use when configuring the Twilio Connector.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image48.png" title="Console" alt="On the Console, on the left, the Home button is selected. On the right, under Account Summary, Account SID and Auth Token are circled." /></p></li>
</ol>
<h4 id="subtask-2-create-a-new-logic-app">Subtask 2: Create a new logic app</h4>
<ol type="1">
<li><p>Open <strong>SQL Server Management Studio</strong> and connect to the SQL Database for the <strong>ContosoSportsDB</strong> database.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image49.png" title="Object Explorer" alt="In Object Explorer, ContosoSportsDBserver1234.database is selected." /></p></li>
<li><p>Under the <strong>ContosoSportsDB</strong> database, expand <strong>Programmability</strong>, right-click on <strong>Stored Procedures</strong>, click <strong>New</strong>, followed by <strong>Stored Procedure…</strong><br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image50.png" title="Object Explorer" alt="In Object Explorer, the following path is expanded: ContosoSportsDBserver1234.database\Databases\ContosoSportsDB\Programmability\Stored Procedures. From the right-click menu for the Stored Procedures, New / Stored Procedure is selected." /></p></li>
<li><p>Replace the Stored Procedure Template code with the following:</p>
<pre><code>CREATE PROCEDURE \[dbo\].\[GetUnprocessedOrders\]

AS

declare \@returnCode int

SELECT \@returnCode = COUNT(\*) FROM \[dbo\].\[Orders\] WHERE PaymentTransactionId is not null AND PaymentTransactionId \&lt;\&gt; \&#39;\&#39; AND Phone is not null AND Phone \&lt;\&gt; \&#39;\&#39; AND SMSOptIn = \&#39;1\&#39; AND SMSStatus is null

return \@returnCode

GO</code></pre></li>
<li><p>Click on <strong>Execute</strong> in the toolbar, or press the F5 key.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image51.png" title="Execute button" alt="Screenshot of the Execute button." /></p></li>
<li><p>Delete the SQL script for the Stored Procedure from the code editor, and replace it with the following:</p>
<pre><code>CREATE PROCEDURE \[dbo\].\[ProcessOrders\]

AS

SELECT \* FROM \[dbo\].\[Orders\] WHERE PaymentTransactionId is not null AND PaymentTransactionId \&lt;\&gt; \&#39;\&#39; AND Phone is not null AND Phone \&lt;\&gt; \&#39;\&#39; AND SMSOptIn = \&#39;1\&#39; AND SMSStatus is null;

UPDATE \[dbo\].\[Orders\] SET SMSStatus = \&#39;sent\&#39; WHERE PaymentTransactionId is not null AND PaymentTransactionId \&lt;\&gt; \&#39;\&#39; AND Phone is not null AND Phone \&lt;\&gt; \&#39;\&#39; AND SMSOptIn = \&#39;1\&#39; AND SMSStatus is null;</code></pre></li>
<li><p>Click on <strong>Execute</strong> in the toolbar, or press the F5 key.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image51.png" title="Execute button" alt="Screenshot of the Execute button." /></p></li>
<li><p>Open the Azure Management Portal (<a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>), and click <strong>+New</strong> <strong>&gt; Web + Mobile &gt; Logic App</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image52.png" title="Azure Portal" alt="On the left side of the Azure Portal, the New button is selected. In the middle, under New, under Marketplace, Web + Mobile is selected. On the right, under Web + Mobile, Logic App is selected." /><figcaption>On the left side of the Azure Portal, the New button is selected. In the middle, under New, under Marketplace, Web + Mobile is selected. On the right, under Web + Mobile, Logic App is selected.</figcaption>
</figure></li>
<li><p>On the <strong>Create logic app</strong> blade, assign a value for <strong>Name</strong>, and set the Resource Group to <strong>contososports</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image53.png" title="Create logic app blade" alt="In the Create logic app blade, the Name field is set to contososportssms. Under Resource group, Use existing is selected, and contososports is selected." /><figcaption>In the Create logic app blade, the Name field is set to contososportssms. Under Resource group, Use existing is selected, and contososports is selected.</figcaption>
</figure></li>
<li><p>Open the Logic App by clicking <strong>More services -&gt; Logic Apps</strong>, and click on the Logic App just created.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image54.png" title="Azure Portal" alt="In the Azure Portal on the left, More services is selected, and Logic Apps displays on the right." /><figcaption>In the Azure Portal on the left, More services is selected, and Logic Apps displays on the right.</figcaption>
</figure></li>
<li><p>Select the <strong>Blank LogicApp</strong> Template.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image55.png" title="Logic Apps Designer" alt="In the Logic Apps Designer, the Blank Logic App tile is selected." /></p></li>
<li><p>On the <strong>Logic Apps Designer</strong>, click <strong>Schedule</strong>.</p></li>
</ol>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image56.png" title="Logic Apps Designer" alt="In the Logic Apps Designer, the Schedule tile is selected." /><figcaption>In the Logic Apps Designer, the Schedule tile is selected.</figcaption>
</figure>
<ol start="12" type="1">
<li><p>Set the <strong>FREQUENCY</strong> to <strong>MINUTE</strong>, and <strong>INTERVAL</strong> to 1.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image57.png" title="Recurrence section" alt="Under Recurrence, the Frequency field is Minute, and the Interval field is 1." /><figcaption>Under Recurrence, the Frequency field is Minute, and the Interval field is 1.</figcaption>
</figure></li>
<li><p>Click the <strong>New Step</strong> followed by <strong>Add an action</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image58.png" title="Recurrence section" alt="Under Recurrence, the New step button and Add an action buttons are selected." /><figcaption>Under Recurrence, the New step button and Add an action buttons are selected.</figcaption>
</figure></li>
<li><p>Type <strong>SQL Server</strong> into the filter box, and click the SQL <strong>Server – Execute stored procedure</strong> action.</p></li>
</ol>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image59.png" title="Choose an action section" alt="Under Choose an action, sql server is typed in the search field. On the Actions tab, SQL Server (Execute stored procedure) is selected." /><figcaption>Under Choose an action, sql server is typed in the search field. On the Actions tab, SQL Server (Execute stored procedure) is selected.</figcaption>
</figure>
<ol start="15" type="1">
<li><p>The first time you add a SQL action, you will be prompted for the connection information. Name the connection <strong>ContosoDB</strong>, input the server and database details used earlier, and click <strong>Create</strong>.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image60.png" title="SQL Server - Execute stored procedure section" alt="In the SQL Server - Execute stored procedure section, the Connection Name is contosoDB. Server and database details are the same as used earlier." /></p></li>
<li><p>Select the <strong>[dbo].[GetUnprocessedOrders]</strong> stored procedure from the drop-down on the Procedure Name field.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image61.png" title="Execute stored procedure section" alt="In the Execute stored procedure section, the Procedure name is [dbo].[GetUnprocessedOrders]." /><figcaption>In the Execute stored procedure section, the Procedure name is [dbo].[GetUnprocessedOrders].</figcaption>
</figure></li>
<li><p>Click on <strong>New Step</strong>, and click the <strong>Add a condition</strong> link.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image62.png" title="Buttons" alt="The New step and Add a condition buttons are selected." /><figcaption>The New step and Add a condition buttons are selected.</figcaption>
</figure></li>
<li><p>Specify <strong>ReturnCode</strong> for the OBJECT NAME, set the RELATIONSHIP to <strong>is greater than</strong>, and set the VALUE to <strong>0</strong>.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image63.png" title="Condition section" alt="Under Condition, Object Name is ReturnCode, Relationship is is greater than, and Value is 0." /><figcaption>Under Condition, Object Name is ReturnCode, Relationship is is greater than, and Value is 0.</figcaption>
</figure></li>
<li><p>Click the <strong>Add an action</strong> link on the <strong>If yes</strong> condition.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image64.png" title="If yes section" alt="Under If yes, do nothing, the Add an action button is selected." /><figcaption>Under If yes, do nothing, the Add an action button is selected.</figcaption>
</figure></li>
<li><p>Type <strong>SQL Server</strong> into the filter box, and click the <strong>SQL Server – Execute stored procedure</strong> action.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image65.png" title="If yes section" alt="Under If Yes, SQL Server - Execute stored procedure is circled." /><figcaption>Under If Yes, SQL Server - Execute stored procedure is circled.</figcaption>
</figure></li>
<li><p>Select the <strong>ProcessOrders</strong> stored procedure in the Procedure name dropdown.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image66.png" title="If yes section" alt="Under If Yes, Execute stored procedure 2 is selected, and the Procedure name is [dbo].[ProcessOrders]." /><figcaption>Under If Yes, Execute stored procedure 2 is selected, and the Procedure name is [dbo].[ProcessOrders].</figcaption>
</figure></li>
<li><p>Click the <strong>Add an action</strong> link.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image67.png" title="Add an action button" alt="The Add an action button is selected." /><figcaption>The Add an action button is selected.</figcaption>
</figure></li>
<li><p>Type <strong>Twilio</strong> in the filter box, and click the <strong>Twilio – Send Text Message (SMS)</strong> connector.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image68.png" title="Show Microsoft managed APIs" alt="Under Show Microsoft managed APIs, the Search box is set to Twilio, and below, Twilio - Send Text Message (SMS) is selected." /><figcaption>Under Show Microsoft managed APIs, the Search box is set to Twilio, and below, Twilio - Send Text Message (SMS) is selected.</figcaption>
</figure></li>
<li><p>Set the Connection Name to Twilio, specify your Twilio <strong>Account SID</strong> and <strong>Authentication Token</strong>, then click the <strong>Create</strong> button.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image69.png" title="Twilio - Send Text Message (SMS)" alt="In the Twilio - Send Text Message (SMS) section, fields are set to the previously defined settings." /><figcaption>In the Twilio - Send Text Message (SMS) section, fields are set to the previously defined settings.</figcaption>
</figure></li>
<li><p>Using the drop-down, select your Twilio number for the <strong>FROM PHONE NUMBER</strong> field. Specify a place holder phone number in the <strong>TO PHONE NUMBER</strong>, and a <strong>TEXT</strong> message.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image70.png" title="Send Text Message (SMS)" alt="Under Send Text Message (SMS), the From Phone Number and To Phone Number fields are circled, and in the Text field is the message, Hello, your order has shipped!" /></p></li>
<li><p>On the Logic App tool bar click the <strong>Code View</strong> button.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image71.png" title="Logic App toolbar" alt="The code view button is selected on the Logic App toolbar." /><figcaption>The code view button is selected on the Logic App toolbar.</figcaption>
</figure></li>
<li><p>Find the <strong>Send_Text_Message_(SMS)</strong> action, and modify the body property of the Twilio action:</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image72.png" title="Code view" alt="The Code view displays the text message, and the from and to phone numbers." /><figcaption>The Code view displays the text message, and the from and to phone numbers.</figcaption>
</figure>
<p>Add the following code between Hello and the comma.</p>
<p><strong>@{item()['FirstName']}</strong></p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image73.png" title="Code view" alt="The Code view now displays the added code in the text message." /><figcaption>The Code view now displays the added code in the text message.</figcaption>
</figure></li>
<li><p>Modify the <strong>to</strong> property to pull the phone number from the item.</p>
<p><strong>@{item()['Phone']}</strong></p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image74.png" title="Code view" alt="The to phone number code now displays the updated line of code." /><figcaption>The to phone number code now displays the updated line of code.</figcaption>
</figure></li>
<li><p>Immediately before the <strong>Send_Text_Message_(SMS)</strong>, create a new line, and add the following code:</p>
<pre><code>\&quot;forEach\_email\&quot;: {

\&quot;type\&quot;: \&quot;Foreach\&quot;,

\&quot;foreach\&quot;: \&quot;\@body(\&#39;Execute\_stored\_procedure\_2\&#39;)\[\&#39;ResultSets\&#39;\]\[\&#39;Table1\&#39;\]\&quot;,

\&quot;actions\&quot;: {</code></pre></li>
<li><p>Remove the <strong>runAfter</strong> block from the <strong>Send_Text_Message_(SMS)</strong> action.<br />
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image75.png" title="Code view" alt="The runAfter block of code displays." /></p></li>
<li><p>Locate the closing bracket of the <strong>Send_Text_Message_(SMS)</strong> action, create a new line after it, and add the following code:</p>
<pre><code>},

\&quot;runAfter\&quot;: {

\&quot;Execute\_stored\_procedure\_2\&quot;: \[

\&quot;Succeeded\&quot;

\]

}

}</code></pre></li>
<li><p>After the code for the <strong>Send_Text_Message_(SMS)</strong> has been modified to be contained within the <strong>forEach_email</strong> action, it should look like the following:</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image76.png" title="Code view" alt="The Code view displays the code from &quot;Foreach&quot; to &quot;Execute stored procedure.&quot;" /><figcaption>The Code view displays the code from &quot;Foreach&quot; to &quot;Execute stored procedure.&quot;</figcaption>
</figure></li>
<li><p>Click <strong>Save</strong> on the toolbar to enable the logic app.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image77.png" title="Logic Apps Designer toolbar" alt="On the Logic Apps Designer toolbar, the Save button is selected." /><figcaption>On the Logic Apps Designer toolbar, the Save button is selected.</figcaption>
</figure></li>
<li><p>Your workflow should look like below, and you should receive a text for each order you have placed.</p>
<figure>
<img src="images/Hands-onlabunguided-Moderncloudappsimages/media/image78.png" title="Workflow diagram" alt="The Workflow diagram begins with Recurrence, then flows to Execute stored procedure, then to Condition. The Condition fields are as follows: Object Name, ReturnCode; Relationship, is greater than; Value, 0. Below the Workflow diagram is an If Yes box, with a workflow that begins wtih Execute stored procedure 2, and flows to forEach email. There is also an If No, Do Nothing box." /><figcaption>The Workflow diagram begins with Recurrence, then flows to Execute stored procedure, then to Condition. The Condition fields are as follows: Object Name, ReturnCode; Relationship, is greater than; Value, 0. Below the Workflow diagram is an If Yes box, with a workflow that begins wtih Execute stored procedure 2, and flows to forEach email. There is also an If No, Do Nothing box.</figcaption>
</figure></li>
</ol>
<h2 id="after-the-hands-on-lab">After the hands-on lab</h2>
<p>Duration: 10 Minutes</p>
<h3 id="task-1-delete-resources">Task 1: Delete resources</h3>
<ol type="1">
<li>Since the HOL is now complete, go ahead and delete all of the Resource Groups that were created for this HOL. You will no longer need those resources and it will be beneficial to clean up your Azure Subscription.</li>
</ol>
<p>You should follow all steps provided <em>after</em> attending the hands-on lab.</p>
</body>
</html>
