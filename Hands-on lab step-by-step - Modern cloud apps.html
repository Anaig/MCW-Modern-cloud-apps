<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Modern Cloud Apps – includes</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cloudworkshop.blob.core.windows.net/styles/labstyles.css"></link>
</head>
<body>
<p><img src="images/HeaderPic.png" title="Microsoft Cloud Workshops" /></p>
<div class="MCWHeader1">
<p>Modern cloud apps</p>
</div>
<div class="MCWHeader2">
<p>Hands-on lab step-by-step</p>
</div>
<div class="MCWHeader3">
<p>March 2018</p>
</div>
<p>Information in this document, including URL and other Internet Web site references, is subject to change without notice. Unless otherwise noted, the example companies, organizations, products, domain names, e-mail addresses, logos, people, places, and events depicted herein are fictitious, and no association with any real company, organization, product, domain name, e-mail address, logo, person, place or event is intended or should be inferred. Complying with all applicable copyright laws is the responsibility of the user. Without limiting the rights under copyright, no part of this document may be reproduced, stored in or introduced into a retrieval system, or transmitted in any form or by any means (electronic, mechanical, photocopying, recording, or otherwise), or for any purpose, without the express written permission of Microsoft Corporation.</p>
<p>Microsoft may have patents, patent applications, trademarks, copyrights, or other intellectual property rights covering subject matter in this document. Except as expressly provided in any written license agreement from Microsoft, the furnishing of this document does not give you any license to these patents, trademarks, copyrights, or other intellectual property.</p>
<p>The names of manufacturers, products, or URLs are provided for informational purposes only and Microsoft makes no representations and warranties, either expressed, implied, or statutory, regarding these manufacturers or the use of the products with any Microsoft technologies. The inclusion of a manufacturer or product does not imply endorsement of Microsoft of the manufacturer or product. Links may be provided to third party sites. Such sites are not under the control of Microsoft and Microsoft is not responsible for the contents of any linked site or any link contained in a linked site, or any changes or updates to such sites. Microsoft is not responsible for webcasting or any other form of transmission received from any linked site. Microsoft is providing these links to you only as a convenience, and the inclusion of any link does not imply endorsement of Microsoft of the site or the products contained therein. © 2018 Microsoft Corporation. All rights reserved.</p>
<p>Microsoft and the trademarks listed at https://www.microsoft.com/en-us/legal/intellectualproperty/Trademarks/Usage/General.aspx are trademarks of the Microsoft group of companies. All other trademarks are property of their respective owners.</p>
<p><strong>Contents</strong></p>
<!-- TOC -->
<ul>
<li><a href="#modern-cloud-apps-hands-on-lab-step-by-step">Modern cloud apps hands-on lab step-by-step</a>
<ul>
<li><a href="#abstract-and-learning-objectives">Abstract and learning objectives</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#requirements">Requirements</a></li>
<li><a href="#solution-architecture">Solution architecture</a></li>
<li><a href="#help-references">Help references</a></li>
<li><a href="#exercise-1-proof-of-concept-deployment">Exercise 1: Proof of concept deployment</a>
<ul>
<li><a href="#task-1-deploy-the-e-commerce-website-sql-database-and-storage">Task 1: Deploy the e-commerce website, SQL Database, and storage</a>
<ul>
<li><a href="#subtask-1-create-the-web-app-and-sql-database-instance">Subtask 1: Create the Web App and SQL database instance</a></li>
<li><a href="#subtask-2-provision-the-storage-account">Subtask 2: Provision the storage account</a></li>
<li><a href="#subtask-3-update-the-configuration-in-the-starter-project">Subtask 3: Update the configuration in the starter project</a></li>
<li><a href="#subtask-4-deploy-the-e-commerce-web-app-from-visual-studio">Subtask 4: Deploy the e-commerce Web App from Visual Studio</a></li>
</ul></li>
<li><a href="#task-2-setup-sql-database-geo-replication">Task 2: Setup SQL Database Geo-Replication</a>
<ul>
<li><a href="#subtask-1-add-secondary-database">Subtask 1: Add secondary database</a></li>
<li><a href="#subtask-2-failover-secondary-sql-database----optional">Subtask 2: Failover secondary SQL database – OPTIONAL</a></li>
<li><a href="#subtask-3-test-e-commerce-web-app-after-failover">Subtask 3: Test e-commerce Web App after Failover</a></li>
<li><a href="#subtask-4-revert-failover-back-to-primary-database">Subtask 4: Revert Failover back to Primary database</a></li>
<li><a href="#subtask-5-test-e-commerce-web-app-after-reverting-failover">Subtask 5: Test e-commerce Web App after reverting Failover</a></li>
</ul></li>
<li><a href="#task-3-deploying-the-call-center-admin-website">Task 3: Deploying the call center admin website</a>
<ul>
<li><a href="#subtask-1-provision-the-call-center-admin-web-app">Subtask 1: Provision the call center admin Web App</a></li>
<li><a href="#subtask-2-update-the-configuration-in-the-starter-project">Subtask 2: Update the configuration in the starter project</a></li>
<li><a href="#subtask-3-deploy-the-call-center-admin-web-app-from-visual-studio">Subtask 3: Deploy the call center admin Web App from Visual Studio</a></li>
</ul></li>
<li><a href="#task-4-deploying-the-payment-gateway">Task 4: Deploying the payment gateway</a>
<ul>
<li><a href="#subtask-1-provision-the-payment-gateway-api-app">Subtask 1: Provision the payment gateway API app</a></li>
<li><a href="#subtask-2-deploy-the-contosoappspaymentgateway-project-in-visual-studio">Subtask 2: Deploy the Contoso.Apps.PaymentGateway project in Visual Studio</a></li>
</ul></li>
<li><a href="#task-5-deploying-the-offers-web-api">Task 5: Deploying the offers Web API</a>
<ul>
<li><a href="#subtask-1-provision-the-offers-web-api-app">Subtask 1: Provision the offers Web API app</a></li>
<li><a href="#subtask-2-configure-cross-origin-resource-sharing-cors">Subtask 2: Configure cross-origin resource sharing (CORS)</a></li>
<li><a href="#subtask-3-update-the-configuration-in-the-starter-project-1">Subtask 3: Update the configuration in the starter project</a></li>
<li><a href="#subtask-4-deploy-the-contosoappssportsleagueoffers-project-in-visual-studio">Subtask 4: Deploy the Contoso.Apps.SportsLeague.Offers project in Visual Studio</a></li>
</ul></li>
<li><a href="#task-6-update-and-deploy-the-e-commerce-website">Task 6: Update and deploy the e-commerce website</a>
<ul>
<li><a href="#subtask-1-update-the-application-settings-for-the-web-app-that-hosts-the-contosoappssportsleagueweb-project">Subtask 1: Update the Application Settings for the Web App that hosts the Contoso.Apps.SportsLeague.Web project</a></li>
<li><a href="#subtask-2-validate-app-settings-are-correct">Subtask 2: Validate App Settings are correct</a></li>
</ul></li>
</ul></li>
<li><a href="#exercise-2-identity-and-security">Exercise 2: Identity and security</a>
<ul>
<li><a href="#task-1-enable-azure-ad-premium-trial">Task 1: Enable Azure AD Premium Trial</a></li>
<li><a href="#task-2-create-a-new-contoso-user">Task 2: Create a new Contoso user</a></li>
<li><a href="#task-3-configure-access-control-for-the-call-center-administration-web-application">Task 3: Configure access control for the call center administration Web Application</a>
<ul>
<li><a href="#subtask-1-enable-azure-ad-authentication">Subtask 1: Enable Azure AD Authentication</a></li>
<li><a href="#subtask-2-verify-the-call-center-administration-website-uses-the-access-control-logon">Subtask 2: Verify the call center administration website uses the access control logon</a></li>
</ul></li>
<li><a href="#task-4-apply-custom-branding-for-the-azure-active-directory-logon-page">Task 4: Apply custom branding for the Azure Active Directory logon page</a></li>
<li><a href="#task-5-verify-the-branding-has-been-successfully-applied-to-the-azure-active-directory-logon-page">Task 5: Verify the branding has been successfully applied to the Azure Active Directory logon page</a></li>
</ul></li>
<li><a href="#exercise-3-enable-azure-b2c-for-customer-site">Exercise 3: Enable Azure B2C for customer site</a>
<ul>
<li><a href="#task-1-create-a-new-directory">Task 1: Create a new directory</a></li>
<li><a href="#task-2-add-a-new-application">Task 2: Add a new application</a></li>
<li><a href="#task-3-create-policies-sign-up">Task 3: Create Policies, Sign up</a></li>
<li><a href="#task-4-create-a-sign-in-policy">Task 4: Create a sign-in policy</a></li>
<li><a href="#task-5-create-a-profile-editing-policy">Task 5: Create a profile editing policy</a></li>
<li><a href="#task-6-modify-the-contosoappsportsleagueweb">Task 6: Modify the Contoso.App.SportsLeague.Web</a></li>
<li><a href="#task-7-send-authentication-requests-to-azure-ad">Task 7: Send authentication requests to Azure AD</a></li>
<li><a href="#task-8-display-user-information">Task 8: Display user information</a></li>
<li><a href="#task-9-run-the-sample-app">Task 9: Run the sample app</a></li>
</ul></li>
<li><a href="#exercise-4-enabling-telemetry-with-application-insights">Exercise 4: Enabling Telemetry with Application Insights</a>
<ul>
<li><a href="#task-1-configure-the-application-for-telemetry">Task 1: Configure the application for telemetry</a>
<ul>
<li><a href="#subtask-1-add-application-insights-telemetry-to-the-e-commerce-website-project">Subtask 1: Add Application Insights Telemetry to the e-commerce website project</a></li>
<li><a href="#subtask-2-enable-client-side-telemetry">Subtask 2: Enable client side telemetry</a></li>
<li><a href="#subtask-3-deploy-the-e-commerce-web-app-from-visual-studio">Subtask 3: Deploy the e-commerce Web App from Visual Studio</a></li>
</ul></li>
<li><a href="#task-2-creating-the-web-performance-test-and-load-test">Task 2: Creating the web performance test and load test</a>
<ul>
<li><a href="#subtask-1-create-the-load-test">Subtask 1: Create the load test</a></li>
<li><a href="#subtask-2-view-the-application-insights-logs">Subtask 2: View the Application Insights logs</a></li>
</ul></li>
</ul></li>
<li><a href="#exercise-5-automating-backend-processes-with-azure-functions-and-logic-apps">Exercise 5: Automating backend processes with Azure Functions and Logic Apps</a>
<ul>
<li><a href="#task-1-create-an-azure-function-to-generate-pdf-receipts">Task 1: Create an Azure Function to Generate PDF Receipts</a></li>
<li><a href="#task-2-create-an-azure-logic-app-to-process-orders">Task 2: Create an Azure Logic App to Process Orders</a></li>
<li><a href="#task-3-use-twilio-to-send-sms-order-notifications">Task 3: Use Twilio to send SMS Order Notifications</a>
<ul>
<li><a href="#subtask-1-configure-your-twilio-trial-account">Subtask 1: Configure your Twilio trial account</a></li>
<li><a href="#subtask-2-create-a-new-logic-app">Subtask 2: Create a new logic app</a></li>
</ul></li>
</ul></li>
<li><a href="#after-the-hands-on-lab">After the hands-on lab</a>
<ul>
<li><a href="#task-1-delete-resources">Task 1: Delete resources</a></li>
</ul></li>
</ul></li>
</ul>
<!-- /TOC -->
<h1 id="modern-cloud-apps-hands-on-lab-step-by-step">Modern cloud apps hands-on lab step-by-step</h1>
<h2 id="abstract-and-learning-objectives">Abstract and learning objectives</h2>
<p>In this Microsoft Cloud Workshop, attendees will implement an end-to-end solution for e-commerce that is based on Azure App Services, Azure Active Directory, and Visual Studio Online. Attendees will ensure the solution is PCI-compliant, and appropriate security measures are put into place for both on-prem and public access scenarios.</p>
<p>Attendees will be better able to deploy and configure Azure Web Apps and associated services. In addition,</p>
<ul>
<li><p>Configure Web Apps for authentication with Azure AD</p></li>
<li><p>Instrument and load-test the application with App Insights</p></li>
<li><p>Automate backend services using Cloud Services and Logic Apps</p></li>
</ul>
<h2 id="overview">Overview</h2>
<p>The Modern cloud apps Hackathon is a hands-on exercise that will challenge you to implement an end-to-end scenario using a supplied sample that is based on Microsoft Azure App Services and related services. The scenario will include implementing compute, storage, security, and scale using various components of Microsoft Azure. The Hackathon can be implemented on your own, but it is highly recommended to pair up with other members at the Hackathon to model a real-world experience much closer and to allow each member to share their expertise for the overall solution.</p>
<h2 id="requirements">Requirements</h2>
<ol type="1">
<li><p>Microsoft Azure subscription</p></li>
<li><p>Local machine or a virtual machine configured with:</p>
<ol type="a">
<li>Visual Studio 2017 Community Edition</li>
</ol></li>
</ol>
<h2 id="solution-architecture">Solution architecture</h2>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image2.png" title="Solution Architecture Diagram" alt="A diagram that depicts the various Azure PaaS services for the solution. Azure AD Org is used for authentication to the call center app. Azure AD B2C for authentication is used for authentication to the client app. SQL Database for the backend customer data. Azure App Services for the web and API apps. Order processing includes using Functions, Logic Apps, Queues and Storage. Azure App Insights is used for telemetry capture." /><figcaption>A diagram that depicts the various Azure PaaS services for the solution. Azure AD Org is used for authentication to the call center app. Azure AD B2C for authentication is used for authentication to the client app. SQL Database for the backend customer data. Azure App Services for the web and API apps. Order processing includes using Functions, Logic Apps, Queues and Storage. Azure App Insights is used for telemetry capture.</figcaption>
</figure>
<h2 id="help-references">Help references</h2>
<table>
<colgroup>
<col style="width: 40%" />
<col style="width: 60%" />
</colgroup>
<tbody>
<tr class="odd">
<td><strong>Description</strong></td>
<td style="text-align: center;"><strong>Links</strong></td>
</tr>
<tr class="even">
<td>SQL firewall</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-configure-firewall-settings/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/sql-database-configure-firewall-settings/</a></td>
</tr>
<tr class="odd">
<td>Deploying a Web App</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/web-sites-deploy/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/web-sites-deploy/</a></td>
</tr>
<tr class="even">
<td>Deploying an API app</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-dotnet-deploy-api-app/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-dotnet-deploy-api-app/</a></td>
</tr>
<tr class="odd">
<td>Accessing an API app from a JavaScript client</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-api-javascript-client/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-api-javascript-client/</a></td>
</tr>
<tr class="even">
<td>SQL Database Geo-Replication overview</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/sql-database-geo-replication-overview/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/sql-database-geo-replication-overview/</a></td>
</tr>
<tr class="odd">
<td>What is Azure AD?</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/active-directory-whatis/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/active-directory-whatis/</a></td>
</tr>
<tr class="even">
<td>Azure Web Apps authentication</td>
<td style="text-align: center;"><a href="http://azure.microsoft.com/blog/2014/11/13/azure-websites-authentication-authorization/" class="uri">http://azure.microsoft.com/blog/2014/11/13/azure-websites-authentication-authorization/</a></td>
</tr>
<tr class="odd">
<td>View your access and usage reports</td>
<td style="text-align: center;"><a href="https://msdn.microsoft.com/en-us/library/azure/dn283934.aspx" class="uri">https://msdn.microsoft.com/en-us/library/azure/dn283934.aspx</a></td>
</tr>
<tr class="even">
<td>Custom branding an Azure AD Tenant</td>
<td style="text-align: center;"><a href="https://msdn.microsoft.com/en-us/library/azure/Dn532270.aspx" class="uri">https://msdn.microsoft.com/en-us/library/azure/Dn532270.aspx</a></td>
</tr>
<tr class="odd">
<td>Service Principal Authentication</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/app-service-api/app-service-api-dotnet-service-principal-auth" class="uri">https://docs.microsoft.com/en-us/azure/app-service-api/app-service-api-dotnet-service-principal-auth</a></td>
</tr>
<tr class="even">
<td>Consumer Site B2C</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-devquickstarts-web-dotnet" class="uri">https://docs.microsoft.com/en-us/azure/active-directory-b2c/active-directory-b2c-devquickstarts-web-dotnet</a></td>
</tr>
<tr class="odd">
<td>Getting Started with Active Directory B2C</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/trial/get-started-active-directory-b2c/" class="uri">https://azure.microsoft.com/en-us/trial/get-started-active-directory-b2c/</a></td>
</tr>
<tr class="even">
<td>How to Delete an Azure Active Directory</td>
<td style="text-align: center;"><a href="https://blog.nicholasrogoff.com/2017/01/20/how-to-delete-an-azure-active-directory-add-tenant/" class="uri">https://blog.nicholasrogoff.com/2017/01/20/how-to-delete-an-azure-active-directory-add-tenant/</a></td>
</tr>
<tr class="odd">
<td>Run performance tests on your app</td>
<td style="text-align: center;"><a href="http://blogs.msdn.com/b/visualstudioalm/archive/2015/09/15/announcing-public-preview-for-performance-load-testing-of-azure-webapp.aspx" class="uri">http://blogs.msdn.com/b/visualstudioalm/archive/2015/09/15/announcing-public-preview-for-performance-load-testing-of-azure-webapp.aspx</a></td>
</tr>
<tr class="even">
<td>Application Insights Custom Events</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-api-custom-events-metrics/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-api-custom-events-metrics/</a></td>
</tr>
<tr class="odd">
<td>Enabling Application Insights</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-start-monitoring-app-health-usage/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-start-monitoring-app-health-usage/</a></td>
</tr>
<tr class="even">
<td>Detect failures</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-asp-net-exceptions/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-asp-net-exceptions/</a></td>
</tr>
<tr class="odd">
<td>Monitor performance problems</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-insights-web-monitor-performance/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-insights-web-monitor-performance/</a></td>
</tr>
<tr class="even">
<td>Creating a Logic App</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-create-a-logic-app/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-create-a-logic-app/</a></td>
</tr>
<tr class="odd">
<td>Logic app connectors</td>
<td style="text-align: center;"><a href="https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-connectors-list/" class="uri">https://azure.microsoft.com/en-us/documentation/articles/app-service-logic-connectors-list/</a></td>
</tr>
<tr class="even">
<td>Logic Apps Docs</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-what-are-logic-apps" class="uri">https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-what-are-logic-apps</a></td>
</tr>
<tr class="odd">
<td>Azure Functions – create first function</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function" class="uri">https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-first-azure-function</a></td>
</tr>
<tr class="even">
<td>Azure Functions docs</td>
<td style="text-align: center;"><a href="https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-azure-functions" class="uri">https://docs.microsoft.com/en-us/azure/logic-apps/logic-apps-azure-functions</a></td>
</tr>
</tbody>
</table>
<h2 id="exercise-1-proof-of-concept-deployment">Exercise 1: Proof of concept deployment</h2>
<p>Duration: 60 minutes</p>
<p>Contoso has asked you to create a proof of concept deployment in Microsoft Azure by deploying the web, database, and API applications for the solution as well as validating that the core functionality of the solution works. Ensure all resources use the same resource group previously created for the App Service Environment.</p>
<h3 id="task-1-deploy-the-e-commerce-website-sql-database-and-storage">Task 1: Deploy the e-commerce website, SQL Database, and storage</h3>
<p>In this exercise, you will provision a website via the Azure Web App + SQL template using the Microsoft Azure Portal. You will then edit the necessary configuration files in the starter project and deploy the e-commerce website.</p>
<h4 id="subtask-1-create-the-web-app-and-sql-database-instance">Subtask 1: Create the Web App and SQL database instance</h4>
<ol type="1">
<li><p>Navigate to the Azure Management portal, <a href="http://portal.azure.com/">http://portal.azure.com</a>, using a new tab or instance, navigate to create <strong>Web App + SQL</strong>.</p></li>
<li><p>Click <strong>New</strong>, and in the Marketplace search text box, enter <strong>“Web App + S.”</strong> Click the <strong>Web App + SQL</strong> item in the search results.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image11.png" title="Azure Portal" alt="In the Azure Portal on the left, New is called out with a 1. In the New pane, the search field is called out with a 2, and displays Web App + S. In the results below, Web App + SQL is called out with a 3." /><figcaption>In the Azure Portal on the left, New is called out with a 1. In the New pane, the search field is called out with a 2, and displays Web App + S. In the results below, Web App + SQL is called out with a 3.</figcaption>
</figure></li>
<li><p>On the <strong>Everything</strong> blade, select <strong>Web App + SQL</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image12.png" title="Everything blade, Results section" alt="In the Everything blade, Results section, Web App + SQL is circled." /><figcaption>In the Everything blade, Results section, Web App + SQL is circled.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image13.png" title="Web App + SQL blade" alt="On the Web App + SQL blade, the Create button is circled." /><figcaption>On the Web App + SQL blade, the Create button is circled.</figcaption>
</figure></li>
<li><p>On the <strong>Web App + SQL</strong> blade, select <strong>App Service plan/Location, <em>Configure required settings</em></strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image14.png" title="App Service plan/Location option" alt="Screenshot of the App Service plan/Location option." /><figcaption>Screenshot of the App Service plan/Location option.</figcaption>
</figure></li>
<li><p>Create a new App Service plan called <strong>ContosoSportsPlan</strong> in the same region and with the <strong>S1 Standard</strong> pricing tier.</p></li>
<li><p>On the Web App blade, specify the following configuration:</p>
<ol type="a">
<li><p>Specify a unique and valid name (until the green check mark appears)</p></li>
<li><p>Specify the <strong>contososports</strong> resource group.</p></li>
<li><p>Specify the name <strong>ContosoSportsPlan</strong> as the App Service plan and choose the same location as the Resource Group.</p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image15.png" title="Web App + SQL blade" alt="The Web App + SQL blade, and App Service plan blade display, with fields set to the previously defined settings. In the Web App + SQ:L blade, the App name field is selected, and is set to contososportsweb3. Resource group is selected, as is the App Service plan/location. In the App Service plan blade, on the left the Create New button is selected. In the App Service plan blade, the App Service plan field is set to ContosoSportsPlan, and the Location field is set to West US." /><figcaption>The Web App + SQL blade, and App Service plan blade display, with fields set to the previously defined settings. In the Web App + SQ:L blade, the App name field is selected, and is set to contososportsweb3. Resource group is selected, as is the App Service plan/location. In the App Service plan blade, on the left the Create New button is selected. In the App Service plan blade, the App Service plan field is set to ContosoSportsPlan, and the Location field is set to West US.</figcaption>
</figure></li>
<li><p>Select <strong>SQL Database <em>Configure required settings</em></strong>, and click <strong>Create a new database</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image16.png" title="Web App + SQL blade, and App Service plan blade" alt="In the Web App + SQL blade, the SQL Database (Configure required settings) option is selected. In the App Service plan blade, the Create a new database option is selected." /><figcaption>In the Web App + SQL blade, the SQL Database (Configure required settings) option is selected. In the App Service plan blade, the Create a new database option is selected.</figcaption>
</figure></li>
<li><p>On the <strong>SQL Database</strong> blade, specify <strong>ContosSportsDB</strong> as the database name.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image17.png" title="SQL Database blade" alt="On the SQL Database blade, the Name field is set to ContosoSportsDB." /><figcaption>On the SQL Database blade, the Name field is set to ContosoSportsDB.</figcaption>
</figure></li>
<li><p>On the <strong>SQL Database</strong> blade, select <strong>Target</strong> <strong>Server <em>Configure required settings</em></strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image18.png" title="Target Server Configure required settings option" alt="Screenshot of the Target Server Configure required settings option." /><figcaption>Screenshot of the Target Server Configure required settings option.</figcaption>
</figure></li>
<li><p>On the <strong>New server</strong> blade, specify the following configuration:</p>
<ol type="a">
<li><p>Server name: a unique value (ensure the green checkmark appears)</p></li>
<li><p>Server admin login: <strong>demouser</strong></p></li>
<li><p><strong>Password</strong> and <strong>Confirm Password</strong>: demo@pass123</p></li>
<li><p>Ensure the <strong>Location</strong> is the same region as the Web App.</p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image19.png" title="New server blade" alt="Fields in the New server blade are circled and set to the previously defined settings." /><figcaption>Fields in the New server blade are circled and set to the previously defined settings.</figcaption>
</figure></li>
<li><p>Once the values are accepted in the <strong>New server</strong> blade, click <strong>Select</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image20.png" title="Select button" alt="Screenshot of the Select button." /><figcaption>Screenshot of the Select button.</figcaption>
</figure></li>
<li><p>On the <strong>SQL Database</strong> blade, click <strong>Select</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image20.png" title="Select button" alt="Screenshot of the Select button." /><figcaption>Screenshot of the Select button.</figcaption>
</figure></li>
<li><p>After the values are accepted, click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image21.png" title="Create button" alt="Screenshot of the Create button." /><figcaption>Screenshot of the Create button.</figcaption>
</figure></li>
</ol>
<p>This may take a couple minutes to provision the Web App and SQL Database resources.</p>
<ol start="15" type="1">
<li><p>After the Web App and SQL Database are provisioned, click <strong>More services</strong> <strong>&gt;</strong> <strong>SQL databases</strong> followed by the name of the SQL Database you just created.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image22.png" title="Azure Portal" alt="In the Azure Portal, on the left side More services is selected. Under Databases, SQL databases displays." /><figcaption>In the Azure Portal, on the left side More services is selected. Under Databases, SQL databases displays.</figcaption>
</figure></li>
<li><p>On the <strong>SQL Database</strong> blade, click the <strong>Show database connection strings</strong> link.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image23.png" title="SQL Database blade" alt="On the SQL Database blade, in the left pane, Overview is selected. In the right pane, under Essentials, the Connection strings (Show database connection strings) link is circled." /><figcaption>On the SQL Database blade, in the left pane, Overview is selected. In the right pane, under Essentials, the Connection strings (Show database connection strings) link is circled.</figcaption>
</figure></li>
<li><p>On the <strong>Database connection strings</strong> blade, select and copy the <strong>ADO.NET</strong> connection string. Then, save it in Notepad for use later.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image24.png" title="Database connection strings blade" alt="In the Database connection strings blade, the ADO.NET connection string is circled." /></p></li>
<li><p>Click the SQL Database server name link.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image25.png" title="SQL Server Blade, Essentials section" alt="In the SQL Server Blade, Essentials section, the Server name contososqlserver.database.windows.net link is circled." /><figcaption>In the SQL Server Blade, Essentials section, the Server name contososqlserver.database.windows.net link is circled.</figcaption>
</figure></li>
<li><p>On the <strong>SQL Server</strong> blade, under <strong>Firewall</strong>, click <strong>Show firewall settings</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image26.png" title="SQL Server Blade, Essentials section" alt="In the SQL Server Blade, Essentials section, the Firewall (Show firewall settings) link is circled." /><figcaption>In the SQL Server Blade, Essentials section, the Firewall (Show firewall settings) link is circled.</figcaption>
</figure></li>
<li><p>On the <strong>Firewall Settings</strong> blade, specify a new rule named <strong>ALL</strong>, with START IP <strong>0.0.0.0</strong>, and END IP <strong>255.255.255.255</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image27.png" title="Firewall Settings blade" alt="Screenshot of the Rule name, Start IP. and End IP fields on the Firewall Settings blade." /><figcaption>Screenshot of the Rule name, Start IP. and End IP fields on the Firewall Settings blade.</figcaption>
</figure></li>
</ol>
<p>This is only done to make the lab easier to do. In Production, you do NOT want to open up your SQL Database to all IP Addresses this way. In Production you will want to specify just the IP Addresses you wish to allow through the Firewall.</p>
<ol start="21" type="1">
<li><p>Click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image28.png" title="Firewall settings Save button" alt="Screenshot of the Firewall settings Save button." /><figcaption>Screenshot of the Firewall settings Save button.</figcaption>
</figure></li>
<li><p>On the <strong>Success!</strong> dialog box, click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image29.png" title="Success dialog box" alt="Screenshot of the Success dialog box, which says that the server firewall rules have been successfully updated." /><figcaption>Screenshot of the Success dialog box, which says that the server firewall rules have been successfully updated.</figcaption>
</figure></li>
<li><p>Close all configuration blades.</p></li>
</ol>
<h4 id="subtask-2-provision-the-storage-account">Subtask 2: Provision the storage account</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>Click <strong>+New, Storage,</strong> and <strong>Storage account.</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image30.png" title="Azure Portal" alt="In the Azure Portal, in the left menu, the New button is marked with a 1. In the New blade, Storage is marked with a 2. In the Storage blade, under Featured Apps, Storage account - blob, file, table, queue is marked with a 3." /><figcaption>In the Azure Portal, in the left menu, the New button is marked with a 1. In the New blade, Storage is marked with a 2. In the Storage blade, under Featured Apps, Storage account - blob, file, table, queue is marked with a 3.</figcaption>
</figure></li>
<li><p>On the Create storage account blade specify the following configuration options:</p>
<ol type="a">
<li><p>Name: unique value for the storage account (ensure the green check mark appears)</p></li>
<li><p>Specify the Resource Group <strong>contososports</strong></p></li>
<li><p>Specify the same <strong>Location</strong> as the resource group.</p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image31.png" title="Create Storage Account blade" alt="The fields in the Create Storage Account blade are set to the previously defined settings. In addition, the Name field set to contososportsstorage011, Deployment model is Resource Manager, Account kind is General purpose, and Performance is standard." /><figcaption>The fields in the Create Storage Account blade are set to the previously defined settings. In addition, the Name field set to contososportsstorage011, Deployment model is Resource Manager, Account kind is General purpose, and Performance is standard.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image32.png" title="Create button" alt="Screenshot of the Create button." /><figcaption>Screenshot of the Create button.</figcaption>
</figure></li>
<li><p>Once the storage account has completed provisioning, open the storage account by clicking <strong>More services &gt;</strong> <strong>Storage accounts</strong> and clicking on the storage account name.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image33.png" title="Azure Portal, More services" alt="In the Azure Portal, More services is selected, and under Storage, Storage accounts displays." /><figcaption>In the Azure Portal, More services is selected, and under Storage, Storage accounts displays.</figcaption>
</figure></li>
<li><p>On the <strong>Storage account</strong> blade, click <strong>All</strong> <strong>settings</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image34.png" title="Settings button" alt="Screenshot of the Storage account blade Settings button." /><figcaption>Screenshot of the Storage account blade Settings button.</figcaption>
</figure></li>
<li><p>On the <strong>Storage</strong> account blade, scroll down, and select the <strong>Access keys</strong> option.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image35.png" title="Storage account blade" alt="In the Storage account blade, under Settings, Access keys is circled." /><figcaption>In the Storage account blade, under Settings, Access keys is circled.</figcaption>
</figure></li>
<li><p>On the <strong>Access keys</strong> blade, click the copy button by <strong>key1</strong> on the Connection string. Put the value in notepad for later reference.</p>
<p>contoso<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image36.png" title="Access keys blade, default keys section" alt="In the Access keys blade default keys section, the copy button for the key1 connection string is circled." /></p></li>
</ol>
<h4 id="subtask-3-update-the-configuration-in-the-starter-project">Subtask 3: Update the configuration in the starter project</h4>
<ol type="1">
<li><p>In the Azure Portal, click on <strong>Resource Groups</strong>. Then, click on the <strong>contososports</strong> resource group.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image37.png" title="Azure Portal" alt="In the Azure Portal left menu, Resource groups selected. In the Resource groups blade, under Name, contososports is selected." /></p></li>
<li><p>Click on the <strong>Web App</strong> just created in a previous step.</p></li>
<li><p>On the <strong>App Service</strong> blade, scroll down in the left pane, and click on <strong>Application settings</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image38.png" title="App Service blade" alt="In the App Service blade, under Settings, Application settings is selected." /></p></li>
<li><p>Scroll down, and locate the <strong>App settings</strong> section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image39.png" title="App Service blade" alt="The App settings section from the App Service blade displays." /></p></li>
<li><p>Add a new <strong>App setting</strong> with the following values:</p>
<ol type="a">
<li><p>Key: <strong>AzureQueueConnectionString</strong></p></li>
<li><p>Value: <strong>enter the Connection String for the Azure Account just created</strong> <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image40.png" title="App settings section" alt="In the App settings section for the App Service blade, the new entry for AzureQueueConnectionString is selected." /></p></li>
</ol></li>
<li><p>Locate <strong>Connection Strings</strong> below App settings.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image41.png" title="Connection Strings section" alt="The Connection Strings section for the App Service blade displays." /></p></li>
<li><p>Add a new <strong>Connection String</strong> with the following values:</p>
<ol type="a">
<li><p>Name: <strong>ContosoSportsLeague</strong></p></li>
<li><p>Value: <strong>enter the Connection String for the SQL Database just created</strong></p></li>
<li><p>Type: <strong><em>SQL Database</em></strong></p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image42.png" title="Connection Strings section" alt="In the Connection Strings section for the App Service blade, the new connection string with the previously defined values displays." /><figcaption>In the Connection Strings section for the App Service blade, the new connection string with the previously defined values displays.</figcaption>
</figure></li>
</ol>
<p>Ensure you replace the string placeholder values <strong>{your_username}</strong> <strong>{your_password_here}</strong> with the username and password you respectively setup during creation (demouser AND demo@pass123). <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image43.png" title="String placeholder value" alt="The password string placeholder value displays: Password={your_password_here};" /></p>
<ol start="8" type="1">
<li>Click Save.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image44.png" title="App Service blade" alt="On the App Service blade, the Save button selected." /></li>
</ol>
<h4 id="subtask-4-deploy-the-e-commerce-web-app-from-visual-studio">Subtask 4: Deploy the e-commerce Web App from Visual Studio</h4>
<ol type="1">
<li><p>Navigate to the <strong>Contoso.Apps.SportsLeague.Web</strong> project located in the <strong>Web</strong> folder using the <strong>Solution Explorer</strong> of Visual Studio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image45.png" title="Solution Explorer" alt="In Solution Explorer, under Solution &#39;Contoso.Apps.SportsLeague&#39; (7 projects), Web is expanded, and under Web, Contoso.Apps.SportsLeague.Web is selected." /><figcaption>In Solution Explorer, under Solution 'Contoso.Apps.SportsLeague' (7 projects), Web is expanded, and under Web, Contoso.Apps.SportsLeague.Web is selected.</figcaption>
</figure></li>
<li><p>Right-click the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and click <strong>Publish</strong>.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image46.png" title="Solution Explorer" alt="In Solution Explorer, Contoso.Apps.SportsLeague.Web is selected, and from its right-click menu, Publish is selected." /></p></li>
<li><p>Choose <strong>Microsoft Azure App Service</strong> as the publish target, and choose <strong>Select Existing</strong>.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image47.png" title="Publish tab" alt="On the Publish tab, the Microsoft Azure App Service tile is selected, as is the radio button for Select Existing." /></p></li>
<li><p>If prompted, log on with your credentials, and ensure the subscription you published earlier are selected.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image48.png" title="Microsoft account tile" alt="Screenshot of the Microsoft account subscriptions tile." /><figcaption>Screenshot of the Microsoft account subscriptions tile.</figcaption>
</figure></li>
<li><p>Select the Contoso Sports Web App.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image49.png" title="Subscriptions" alt="Under Subscriptions, under contososports, contososportsweb0 is selected." /><figcaption>Under Subscriptions, under contososports, contososportsweb0 is selected.</figcaption>
</figure></li>
<li><p>Click <strong>OK</strong>, and click <strong>Publish</strong> to publish the Web Application.</p></li>
<li><p>In the Visual Studio <strong>Output</strong> view, you will see a status that indicates the Web App was published successfully.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image50.png" title="Visual Studio Output view" alt="Screenshot of the Visual Studio Output view, with the Publish Succeeded message circled." /><figcaption>Screenshot of the Visual Studio Output view, with the Publish Succeeded message circled.</figcaption>
</figure></li>
<li><p>Validate the website by clicking the <strong>Store</strong> link on the menu. As long as products return, the connection to the database is successful.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image51.png" title="Store link" alt="Screenshot of the Store link." /><figcaption>Screenshot of the Store link.</figcaption>
</figure></li>
</ol>
<h3 id="task-2-setup-sql-database-geo-replication">Task 2: Setup SQL Database Geo-Replication</h3>
<p>In this exercise, the attendee will provision a secondary SQL Database and configure Geo-Replication using the Microsoft Azure Portal.</p>
<h4 id="subtask-1-add-secondary-database">Subtask 1: Add secondary database</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management Portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a></p></li>
<li><p>Click <strong>More services &gt; SQL databases</strong>, and click the name of the SQL Database you created previously.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image52.png" title="Azure Portal" alt="In the Azure Portal, More services is selected, and under Databases, SQL Databases displays." /></p></li>
<li><p>Under <strong>Settings</strong>, click on <strong>Geo-Replication</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image53.png" title="Settings section" alt="In the Settings section, Geo-Replication is selected." /></p></li>
<li><p>Select the Azure Region to place the Secondary within.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image54.png" title="Geo-Replication blade" alt="The Geo-Replication blade has a map of the world with locations marked on it. Under the map, Primary is set to West US, which on the map has a blue checkmark. Under Target Regions, East US is circled." /></p></li>
</ol>
<p>The Secondary Azure Region should be the Region Pair for the region the SQL Database is hosted in. The portal suggests the Region Pair to use by labeling it as “Recommended.”</p>
<ol start="5" type="1">
<li><p>On the <strong>Create secondary</strong> blade, select <strong>Secondary Type</strong> as <strong>Readable</strong>.</p></li>
<li><p>Select <strong>Target server</strong> <strong><em>Configure required settings</em></strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image55.png" title="Target server option" alt="the Target server Configure required settings option is selected." /><figcaption>the Target server Configure required settings option is selected.</figcaption>
</figure></li>
<li><p>On the <strong>New server</strong> blade, specify the following configuration:</p>
<ol type="a">
<li><p>Server name: a unique value (ensure the green checkmark appears)</p></li>
<li><p>Server admin login: <strong>demouser</strong></p></li>
<li><p>Password and Confirm Password: <strong>demo@pass123</strong></p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image56.png" title="New Server blade" alt="The fields in the New Server blade display with the previously defined settings." /><figcaption>The fields in the New Server blade display with the previously defined settings.</figcaption>
</figure></li>
<li><p>Once the values are accepted in the <strong>New server</strong> blade, click <strong>Select</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image20.png" title="Select button" alt="Screenshot of the Select button." /></p></li>
<li><p>On the <strong>Create secondary</strong> blade, click <strong>OK</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image57.png" title="OK button" alt="Screenshot of the OK button." /></p></li>
<li><p>After the Geo-Replication has finished provisioning, click <strong>More services &gt; SQL databases</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image52.png" title="Azure Portal" alt="In the Azure Portal, on the left side More services is selected. Under Databases, SQL databases displays." /></p></li>
<li><p>Click the name of the Secondary SQL Database you just created.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image58.png" title="Database list" alt="In the list of Databases, the ContosoSportsDB secondary replicatoin role is selected." /></p></li>
<li><p>On the <strong>SQL Database</strong> blade, click the <strong>Show database connection strings</strong> link.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image59.png" title="SQL database blade" alt="On the SQL database blade, on the left Overview is selected. On the right, under Essentials, the Connection strings (show database connection strings) link is circled." /></p></li>
<li><p>On the <strong>Database connection strings</strong> blade, select and copy the <strong>ADO.NET</strong> connection string, and save it in Notepad for use later.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image60.png" title="Database connection strings blade" alt="On the Database connection strings blade, ADO.NET tab, the connection string is circled." /></p></li>
<li><p>Click the SQL Database Server name link.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image61.png" title="SQL database blade, Essentials section" alt="On the SQL database blade in the Essentials section, the Server name (contososqlserver2.database.windows.net) link is circled." /></p></li>
<li><p>On the <strong>SQL Server</strong> blade, under <strong>Firewall</strong>, click <strong>Show firewall settings</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image62.png" title="SQL Server blade, Essentials section" alt="On the SQL Server blade, on the left Overview is selected. On the right, under Essentials, the Firewall (Show firewall settings) link is circled." /></p></li>
<li><p>On the <strong>Firewall Settings</strong> blade, specify a new rule named <strong>ALL</strong>, with START IP <strong>0.0.0.0</strong>, and END IP <strong>255.255.255.255</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image27.png" title="New rule section" alt="On the Firewall Settings blade, in the New rule section, a new rule has been created with the previously defined settings." /></p></li>
<li><p>Click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image63.png" title="Save button" alt="On the Firewall Settings blade, the Save button is circled." /><figcaption>On the Firewall Settings blade, the Save button is circled.</figcaption>
</figure></li>
<li><p>On the <strong>Success!</strong> Dialog box, click <strong>OK</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image29.png" title="Success dialog box" alt="The Success dialog box message explains that the server firewall rules were successfully updated." /></p></li>
<li><p>Close all configuration blades.</p></li>
</ol>
<h4 id="subtask-2-failover-secondary-sql-database-optional">Subtask 2: Failover secondary SQL database – OPTIONAL</h4>
<p>Since the Replication and Failover process can take anywhere from 10 – 30 minutes to complete, you have the choice to skip Subtask 2 through 5, and skip directly to Task 3. However, if you have the time, it is recommended that you complete these steps.</p>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management Portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>Click <strong>More services &gt; SQL databases</strong>, and click the name of the SQL Database you created previously.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image52.png" title="Azure Portal" alt="In the Azure Portal, on the left More services is selected. On the right, under Databases, SQL databases displays." /></p></li>
<li><p>On the <strong>Settings</strong> blade, click <strong>Geo-Replication</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image64.png" title="Settings section" alt="On the Settings blade, under Settings, Geo-Replication is selected." /></p></li>
<li><p>On the <strong>Geo-Replication</strong> blade, select the Secondary database.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image65.png" title="Geo-Replication blade" alt="The Geo-Replication blade has a map of the world with locations marked on it. Under the map, Primary is set to West US, which on the map has a blue checkmark. Under Secondaries, East US is circled, and on the map displays with a green checkmark. A line connects the West Coast (blue) and East Coast (green) checkmarks." /></p></li>
<li><p>Click the <strong>Failover</strong> button.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image66.png" title="Secondary database blade" alt="the Failover button is circled on the Secondary database blade." /></p></li>
<li><p>On the <strong>Failover</strong> prompt, click <strong>Yes</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image67.png" title="Failover prompt" alt="On the East US Secondary database blade, in response to the questing asking if you are sure you want to proceed, the Yes button is circled." /></p></li>
</ol>
<p>The Failover may take a few minutes to complete. You can continue with the next Subtask modifying the Web App to point to the Secondary SQL Database while the Failover is pending.</p>
<h4 id="subtask-3-test-e-commerce-web-app-after-failover">Subtask 3: Test e-commerce Web App after Failover</h4>
<ol type="1">
<li><p>Once completed, in the Azure Portal, click on <strong>SQL databases</strong>, and select the <strong>ContosoSportsDB</strong> secondary.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image68.png" title="SQL databases blade" alt="On the SQL databases blade, under Name, the ContosoSportsDB Secondary replication role is circled." /></p></li>
<li><p>Next, click on <strong>Show database connection strings</strong>, and copy it off thereby replacing the user and password. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image69.png" title="SQL database blade" alt="On the SQL database blade,on the left Overview is selected. On the right, under Essentials, the Connection strings (Show database connection strings) link is circled." /></p></li>
<li><p>From the Azure portal, click on resource groups, and select contososports.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image37.png" title="Azure Portal" alt="In the Azure Portal, on the left, Resource groups is circled. On the right, under Name, contososports is selected." /></p></li>
<li><p>Click on the <strong>Web App</strong> just created in a previous step.</p></li>
<li><p>On the <strong>App Service</strong> blade, scroll down in the left pane, and click on <strong>Application settings</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image38.png" title="App Service blade" alt="On the App Service blade, under Settings, Application settings is circled." /></p></li>
<li><p>Scroll down, and locate the <strong>Connection strings</strong> section.</p></li>
<li><p>Update the <strong>ContosoSportsLeague</strong> Connection String to the value of the Connection String for the <strong>Secondary SQL Database</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image70.png" title="App Service blade" alt="On the App Service blade, in the Connection strings section, the ContosoSportsLeague connection string is circled." /></p></li>
</ol>
<p>Ensure you replace the string placeholder values <strong>{your_username}</strong> <strong>{your_password_here}</strong> with the username and password you respectively setup during creation (demouser AND demo@pass123). <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image43.png" title="String placeholder values" alt="The password string placeholder value displays: Password={your_password_here};" /></p>
<ol start="8" type="1">
<li><p>Click <strong>Save</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image44.png" title="App Service blade Save button" alt="On the App Service blade, the Save button is circled." /></p></li>
<li><p>On the <strong>App Service</strong> blade, click on <strong>Overview</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image71.png" title="App Service blade" alt="On the App Service blade, Overview is selected." /></p></li>
<li><p>On the <strong>Overview</strong> pane, click on the <strong>URL</strong> for the Web App to open it in a new browser tab.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image72.png" title="App Service blade Essentials section" alt="On the App Service blade, in the Essentials section, the URL (http;//contososportsweb4azurewebsites.net) link is circled." /></p></li>
<li><p>After the e-commerce Web App loads in Internet Explorer, click on <strong>STORE</strong> in the top navigation bar of the website.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image73.png" title="Contoso sports league website navigation bar" alt="On the Contoso sports league website navigation bar, the Store button is circled." /></p></li>
<li><p>Verify the product list from the database displays.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image74.png" title="Contoso store webpage" alt="Screenshot of the Contoso store webpage. Under Team Apparel, a Contoso hat, tank top, and hoodie display." /></p></li>
</ol>
<h4 id="subtask-4-revert-failover-back-to-primary-database">Subtask 4: Revert Failover back to Primary database</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management Portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>Click <strong>More services &gt; SQL databases</strong>, and click the name of the SQL Database you created previously.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image52.png" title="Azure Portal" alt="In the Azure Portal menu on the left, More services is selected. On the right, under Databases, SQL databases displays." /></p></li>
<li><p>On the <strong>Settings</strong> blade, click <strong>Geo-Replication</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image64.png" title="Settings section" alt="In the Settings section, Geo-Replication is selected." /></p></li>
<li><p>On the <strong>Geo-Replication</strong> blade, select the Secondary database.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image75.png" title="Geo-Replication blade" alt="The Geo-Replication blade has a map of the world with locations marked on it. Under the map, Primary is set to East US, which on the map has a blue checkmark. Under Secondaries, West US is circled, and on the map displays with a green checkmark. A line connects the East US (blue) and West US (green) checkmarks." /></p></li>
<li><p>Click the <strong>Failover</strong> button.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image76.png" title="Secondary Database blade" alt="The Failover button in the Secondary Database blade is circled." /></p></li>
<li><p>On the <strong>Failover</strong> prompt, click <strong>Yes</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image77.png" title="Failover prompt" alt="On the West US Secondary database blade, in response to the questing asking if you are sure you want to proceed, the Yes button is circled." /></p></li>
</ol>
<p>The Failover may take a few minutes to complete. You can continue with the next Subtask modifying the Web App to point back to the Primary SQL Database while the Failover is pending.</p>
<h4 id="subtask-5-test-e-commerce-web-app-after-reverting-failover">Subtask 5: Test e-commerce Web App after reverting Failover</h4>
<ol type="1">
<li><p>In the Azure Portal, click on <strong>Resource Groups</strong> <strong>&gt;</strong> <strong>contososports</strong> resource group.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image37.png" title="Azure Portal" alt="In the left menu of the Azure Portal, Resource groups is selected. On the right, underResource groups, contososports is selected." /></p></li>
<li><p>Click on the <strong>Web App</strong> just created in a previous step.</p></li>
<li><p>On the <strong>App Service</strong> blade, scroll down in the left pane, and click on <strong>Application settings</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image38.png" title="App Service blade" alt="In the App Service blade Settings section, Application settings is circled." /></p></li>
<li><p>Scroll down, and locate the <strong>Connection strings</strong> section.</p></li>
<li><p>Update the <strong>ContosoSportsLeague</strong> Connection String to the value of the Connection String for the <strong>Primary SQL Database</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image70.png" title="App Service blade" alt="In the App Service blade Connection strings section, the ContosoSportsLeague connection string is circled." /></p></li>
</ol>
<p>Ensure you replace the string placeholder values <strong>{your_username}</strong> <strong>{your_password_here}</strong> with the username and password you respectively setup during creation (demouser AND demo@pass123). <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image43.png" title="String placeholder value" alt="The password string placeholder value displays: Password={your_password_here};" /></p>
<ol start="6" type="1">
<li><p>Click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image44.png" title="App Service blade" alt="The Save button is circled on the App Service blade." /><figcaption>The Save button is circled on the App Service blade.</figcaption>
</figure></li>
<li><p>On the <strong>App Service</strong> blade, click on <strong>Overview</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image71.png" title="App Service blade" alt="Overview is selected on the App Service blade." /></p></li>
<li><p>On the <strong>Overview</strong> pane, click on the <strong>URL</strong> for the Web App to open it in a new browser tab.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image72.png" title="App Service blade, Essentials section" alt="In the App Service blade Essentials section, the URL (http:/contososportsweb4.azurewebsites.net) link is circled." /></p></li>
<li><p>After the e-commerce Web App loads in Internet Explorer, click on <strong>STORE</strong> in the top navigation bar of the website.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image73.png" title="Contoso sports league website navigation bar" alt="On the Contoso sports league website navigation bar, the Store button is circled." /></p></li>
<li><p>Verify the product list from the database displays.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image74.png" title="Contoso store webpage" alt="Screenshot of the Contoso store webpage. Under Team Apparel, a Contoso hat, tank top, and hoodie display." /></p></li>
</ol>
<h3 id="task-3-deploying-the-call-center-admin-website">Task 3: Deploying the call center admin website</h3>
<p>In this exercise, you will provision a website via the Azure Web App template using the Microsoft Azure Portal. You will then edit the necessary configuration files in the Starter Project and deploy the call center admin website.</p>
<h4 id="subtask-1-provision-the-call-center-admin-web-app">Subtask 1: Provision the call center admin Web App</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>Click <strong>New</strong> <strong>&gt;</strong> <strong>Web + mobile</strong> <strong>&gt;</strong> <strong>Web App</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image78.png" title="Azure Portal" alt="In the left menu of the Azure Portal, the New button is selected. In middle section, under Marketplace, Web + mobile is selected. In the right, Web + mobile section, under Featured apps, Web App is selected." /></p></li>
<li><p>Specify a <strong>unique URL</strong> for the Web App, and ensure the <strong>same App Service Plan</strong> and <strong>resource group</strong> you have used throughout the lab are selected.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image79.png" title="Web App blade" alt="On the Web App blade, the App name field is set to contososportsadmin4." /><figcaption>On the Web App blade, the App name field is set to contososportsadmin4.</figcaption>
</figure></li>
<li><p>Click on <strong>App Service plan/Location</strong>, and select the <strong>ContosoSportsPlan</strong> used by the front-end Web App.</p></li>
<li><p>After the values are accepted, click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image32.png" title="Create button" alt="Screenshot of the Create button." /><figcaption>Screenshot of the Create button.</figcaption>
</figure></li>
</ol>
<h4 id="subtask-2-update-the-configuration-in-the-starter-project">Subtask 2: Update the configuration in the starter project</h4>
<ol type="1">
<li><p>Navigate to the <strong>App Service</strong> blade for the Call Center Admin App just provisioned.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image80.png" title="App Service blade" alt="The App Service blade displays." /></p></li>
<li><p>On the <strong>App Service</strong> blade, click on <strong>Application settings</strong> in the left pane.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image81.png" title="Settings section" alt="In the Settings section of the App Service blade, Application settings is selected." /><figcaption>In the Settings section of the App Service blade, Application settings is selected.</figcaption>
</figure></li>
<li><p>Scroll down, and locate the <strong>Connection strings</strong> section.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image82.png" title="App Service Blade" alt="The Connection strings section is circled on the App Service blade." /><figcaption>The Connection strings section is circled on the App Service blade.</figcaption>
</figure></li>
<li><p>Add a new <strong>Connection string</strong> with the following values:</p>
<ol type="a">
<li><p>Name: <strong>ContosoSportsLeague</strong></p></li>
<li><p>Value: <strong>enter the Connection String for the SQL Database that was created</strong></p></li>
<li><p>Type: <strong>SQL Database</strong></p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image83.png" title="Connection Strings fields" alt="The Connection Strings fields display the previously defined values." /><figcaption>The Connection Strings fields display the previously defined values.</figcaption>
</figure></li>
</ol>
<p>Ensure you replace the string placeholder values <strong>{your_username}</strong> <strong>{your_password_here}</strong> with the username and password you respectively setup during creation (demouser AND demo@pass123). <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image43.png" title="String placeholder values" alt="The password string placeholder value displays: Password={your_password_here};" /></p>
<ol start="5" type="1">
<li><p>Click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image84.png" title="App Service blade" alt="the Save button is circled on the App Service blade." /><figcaption>the Save button is circled on the App Service blade.</figcaption>
</figure></li>
</ol>
<h4 id="subtask-3-deploy-the-call-center-admin-web-app-from-visual-studio">Subtask 3: Deploy the call center admin Web App from Visual Studio</h4>
<ol type="1">
<li><p>Navigate to the <strong>Contoso.Apps.SportsLeague.Admin</strong> project located in the <strong>Web</strong> folder using the <strong>Solution Explorer</strong> in Visual Studio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image85.png" title="Solution Explorer" alt="In Solution Explorer, under Solution Contoso.Apps.SportsLeague, The Web folder is expanded, and Contoso.Apps.SportsLeague.Admin is selected." /><figcaption>In Solution Explorer, under Solution Contoso.Apps.SportsLeague, The Web folder is expanded, and Contoso.Apps.SportsLeague.Admin is selected.</figcaption>
</figure></li>
<li><p>Right-click the <strong>Contoso.Apps.SportsLeague.Admin</strong> project, and click <strong>Publish</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image86.png" title="Right-Click menu" alt="In Solution Explorer, the right-click menu for Contoso.Apps.SportsLeague.Admin displays, and Publish is selected." /><figcaption>In Solution Explorer, the right-click menu for Contoso.Apps.SportsLeague.Admin displays, and Publish is selected.</figcaption>
</figure></li>
<li><p>Choose <strong>Microsoft Azure App Service</strong> as the publish target, and choose <strong>Select Existing</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image87.png" title="Publish tab" alt="On the Publish tab, Microsoft Azure App Service is selected. Below that, the radio button is selected for Select Existing." /><figcaption>On the Publish tab, Microsoft Azure App Service is selected. Below that, the radio button is selected for Select Existing.</figcaption>
</figure></li>
<li><p>Select the <strong>Web App</strong> for the Call Center Admin App.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image88.png" title="App Service section" alt="In the App Service section, in the tree view at the bottom, the contososports folder is expanded, and contososportsadmin4 is selected." /><figcaption>In the App Service section, in the tree view at the bottom, the contososports folder is expanded, and contososportsadmin4 is selected.</figcaption>
</figure></li>
<li><p>Click <strong>OK</strong>, and click <strong>Publish</strong> to deploy the site.</p></li>
<li><p>The website should load / display the following:</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image89.png" title="Contoso website" alt="The Contoso website displays the Contoso Sports League Admin webpage, which says that orders that display below are sorted by date, and you can click on an order to see its details. However, at this time, there is no data available under Completed Orders." /><figcaption>The Contoso website displays the Contoso Sports League Admin webpage, which says that orders that display below are sorted by date, and you can click on an order to see its details. However, at this time, there is no data available under Completed Orders.</figcaption>
</figure></li>
</ol>
<h3 id="task-4-deploying-the-payment-gateway">Task 4: Deploying the payment gateway</h3>
<p>In this exercise, the attendee will provision an Azure API app template using the Microsoft Azure Portal. The attendee will then deploy the payment gateway API to the API app.</p>
<h4 id="subtask-1-provision-the-payment-gateway-api-app">Subtask 1: Provision the payment gateway API app</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management Portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>Click <strong>+New</strong>, type <strong>API App</strong> into the Search the marketplace box, and press <strong>Enter</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image90.png" title="Azure Portal" alt="In the Azure Portal left menu, New is selected. In the New blade, the search field is set to API App." /><figcaption>In the Azure Portal left menu, New is selected. In the New blade, the search field is set to API App.</figcaption>
</figure></li>
<li><p>Click on <strong>API App</strong> in the search results list.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image91.png" title="Everything blade" alt="In the Everything blade Search results, API App is circled." /></p></li>
<li><p>Click on <strong>Create</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image92.png" title="API App section" alt="In the API App section, the Create button is circled." /></p></li>
<li><p>On the new <strong>API App</strong> blade, specify a unique name for the App Name, and ensure the previously used Resource Group and App Service Plan are selected.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image93.png" title="API App blade" alt="On the API App blade, the App name field is set to PaymentsAPIO, and is circled." /></p></li>
<li><p>Click on <strong>App Service plan/Location</strong>, and select the same App Service Plan used for the other Web App services.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image94.png" title="API App blade, App Service plan blade" alt="On the API App blade, App Service plan/Location ContosoSportsPlan (West US) is selected. On the App Service plan blade, ContosoSportsPlan(S1) West US is selected." /></p></li>
<li><p>After the values are accepted, click <strong>Create</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image32.png" title="Create button" alt="Screenshot of the Create button." /></p></li>
</ol>
<h4 id="subtask-2-deploy-the-contoso.apps.paymentgateway-project-in-visual-studio">Subtask 2: Deploy the Contoso.Apps.PaymentGateway project in Visual Studio</h4>
<ol type="1">
<li><p>Navigate to the <strong>Contoso.Apps.PaymentGateway</strong> project located in the <strong>APIs</strong> folder using the <strong>Solution Explorer</strong> in Visual Studio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image95.png" title="Solution Explorer" alt="In Solution Explorer, under Solution Contoso.Apps.SportsLeague, the API folder is expanded, and Contoso.Apps.PaymentGateway is selected." /><figcaption>In Solution Explorer, under Solution Contoso.Apps.SportsLeague, the API folder is expanded, and Contoso.Apps.PaymentGateway is selected.</figcaption>
</figure></li>
<li><p>Right-click the <strong>Contoso.Apps.PaymentGateway</strong> project, and click <strong>Publish</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image96.png" title="Solution Explorer" alt="In Solution Explorer, Contoso.Apps.PaymentGateway is selected, and in its right-click menu, Publish is selected." /><figcaption>In Solution Explorer, Contoso.Apps.PaymentGateway is selected, and in its right-click menu, Publish is selected.</figcaption>
</figure></li>
<li><p>On the <strong>Publish Web</strong> dialog box, click <strong>Microsoft Azure App Service</strong>, and choose <strong>Select Existing</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image97.png" title="Publish web dialog box" alt="In the Publish web dialog box, Microsoft Azure App Service is selected, as is the radio button for Select Existing." /><figcaption>In the Publish web dialog box, Microsoft Azure App Service is selected, as is the radio button for Select Existing.</figcaption>
</figure></li>
<li><p>Select the Payment Gateway API app created earlier, click <strong>OK</strong> <strong>&gt;</strong> <strong>Publish</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image98.png" title="App Service section" alt="In the App Service section, the contososports folder is expanded, and PaymentsAPIO is selected." /><figcaption>In the App Service section, the contososports folder is expanded, and PaymentsAPIO is selected.</figcaption>
</figure></li>
<li><p>In the Visual Studio <strong>Output</strong> view, you will see a status indicating the Web App was published successfully.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image99.png" title="Visual Studio output" alt="The Visual Studio output shows that the web app was published successfully." /><figcaption>The Visual Studio output shows that the web app was published successfully.</figcaption>
</figure></li>
<li><p>Record the value of the deployed <strong>API App URL</strong> for later use.</p></li>
</ol>
<h3 id="task-5-deploying-the-offers-web-api">Task 5: Deploying the offers Web API</h3>
<p>In this exercise, the attendee will provision an Azure API app template using the Microsoft Azure Portal. The attendee will then deploy the offers Web API.</p>
<h4 id="subtask-1-provision-the-offers-web-api-app">Subtask 1: Provision the offers Web API app</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management Portal (<a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>).</p></li>
<li><p>Click <strong>+New</strong>, type <strong>API App</strong> into the Search the marketplace box, and <strong>press Enter</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image90.png" title="Azure Portal" alt="In the Azure Portal left menu, New is selected. On the right, under New, API App is typed in the Search box." /><figcaption>In the Azure Portal left menu, New is selected. On the right, under New, API App is typed in the Search box.</figcaption>
</figure></li>
<li><p>Click on <strong>API App</strong> in the search results list.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image91.png" title="Everything blade" alt="In the Everything blade, under Name, API App is selected." /></p></li>
<li><p>Click on <strong>Create</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image92.png" title="API App section" alt="In the API App section, the Create button is circled." /></p></li>
<li><p>On the new <strong>API App</strong> blade, specify a unique name for the App Service Name, and ensure the previously used Resource Group and App Service Plan are selected.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image100.png" title="API App blade" alt="In the API App blade, OffersAPI4 is typed in the App name field." /><figcaption>In the API App blade, OffersAPI4 is typed in the App name field.</figcaption>
</figure></li>
<li><p>After the values are accepted, click <strong>Create</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image32.png" title="Create button" alt="Screenshot of the Create button." /></p></li>
<li><p>When the Web App template has completed provisioning, open the new API App by clicking <strong>More services</strong> <strong>&gt;</strong> <strong>App Services &gt;</strong> <strong>Offers API</strong> (just created).</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image101.png" title="Azure Portal, More Services" alt="In the Azure Portal, on the left More services is selected, and on the right under Web + Mobile, App Services displays." /><figcaption>In the Azure Portal, on the left More services is selected, and on the right under Web + Mobile, App Services displays.</figcaption>
</figure></li>
</ol>
<h4 id="subtask-2-configure-cross-origin-resource-sharing-cors">Subtask 2: Configure cross-origin resource sharing (CORS)</h4>
<ol type="1">
<li><p>On the <strong>App Service</strong> blade, scroll down, and click on <strong>CORS</strong> within the API section of the left pane.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image102.png" title="App Service blade" alt="In the App Service blade, under API, CORS is selected." /><figcaption>In the App Service blade, under API, CORS is selected.</figcaption>
</figure></li>
<li><p>In the <strong>ALLOWED ORIGINS</strong> text box, specify, and click <strong>Save</strong>.</p></li>
</ol>
<h4 id="subtask-3-update-the-configuration-in-the-starter-project-1">Subtask 3: Update the configuration in the starter project</h4>
<ol type="1">
<li><p>On the <strong>App Service</strong> blade for the Offers API, click on <strong>Application settings<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image103.png" title="App Service blade" alt="In the App Service blade, under Settings, Application settings is selected." /> </strong></p></li>
<li><p>Scroll down, and locate the <strong>Connection strings</strong> section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image104.png" title="App Service blade" alt="In the App Service blade, the Connection strings section displays with No results." /></p></li>
<li><p>Add a new <strong>Connection string</strong> with the following values:</p>
<ol type="a">
<li><p>Name: <strong>ContosoSportsLeague</strong></p></li>
<li><p>Value: <strong>enter the Connection String for the SQL Database that was created</strong></p></li>
<li><p>Type: **SQL Database<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image105.png" title="Connection strings section" alt="The Connection strings section now has a new string with the previously defined settings." /></p></li>
</ol></li>
</ol>
<p>Ensure you replace the string placeholder values <strong>{your_username}</strong> <strong>{your_password_here}</strong> with the username and password you respectively setup during creation (demouser AND demo@pass123). <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image43.png" title="String placeholder value" alt="The password string placeholder value displays: Password={your_password_here};" /></p>
<ol start="4" type="1">
<li><p>Click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image106.png" title="Save button" alt="The Save button is selected in the App Service blade." /><figcaption>The Save button is selected in the App Service blade.</figcaption>
</figure></li>
</ol>
<h4 id="subtask-4-deploy-the-contoso.apps.sportsleague.offers-project-in-visual-studio">Subtask 4: Deploy the Contoso.Apps.SportsLeague.Offers project in Visual Studio</h4>
<ol type="1">
<li><p>Navigate to the <strong>Contoso.Apps.SportsLeague.Offers</strong> project located in the <strong>APIs</strong> folder using the <strong>Solution Explorer</strong> in Visual Studio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image107.png" title="Solution Explorer" alt="In Solution Explorer, under Solution Contoso.Apps.SportsLeague, the API folder is expanded, and Contoso.Apps.SportsLeague.Offer is selected." /><figcaption>In Solution Explorer, under Solution Contoso.Apps.SportsLeague, the API folder is expanded, and Contoso.Apps.SportsLeague.Offer is selected.</figcaption>
</figure></li>
<li><p>Right-click the <strong>Contoso.Apps.SportsLeague.Offers</strong> project, and select <strong>Publish</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image108.png" title="Solution Explorer" alt="In Solution Explorer, from the Contoso.Apps.SportsLeague.Admin right-click menu, Publish is selected." /><figcaption>In Solution Explorer, from the Contoso.Apps.SportsLeague.Admin right-click menu, Publish is selected.</figcaption>
</figure></li>
<li><p>On the <strong>Publish Web</strong> dialog box, click <strong>Microsoft Azure App Service</strong>, and choose <strong>Select Existing</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image109.png" title="Publish tab" alt="On the Publish tab, the Microsoft Azure App Service tile is selected, and under it, the radio button for Select Existing is selected." /></p></li>
<li><p>Select the Offers API app created earlier, and click <strong>OK</strong> <strong>&gt;</strong> <strong>Publish</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image110.png" title="App Service section" alt="In the App Service section, the contososports folder is expanded, and OffersAPI4 is selected." /><figcaption>In the App Service section, the contososports folder is expanded, and OffersAPI4 is selected.</figcaption>
</figure></li>
<li><p>In the Visual Studio <strong>Output</strong> view, you will see a status the API app was published successfully.</p></li>
<li><p>Record the value of the deployed API app URL for later use.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image111.png" title="Visual Studio Output" alt="The Visual Studio Output indicates that the web app was published successfully, and that the URL is http://offersapi0.azurewebsites.net/." /></p></li>
</ol>
<h3 id="task-6-update-and-deploy-the-e-commerce-website">Task 6: Update and deploy the e-commerce website</h3>
<h4 id="subtask-1-update-the-application-settings-for-the-web-app-that-hosts-the-contoso.apps.sportsleague.web-project">Subtask 1: Update the Application Settings for the Web App that hosts the Contoso.Apps.SportsLeague.Web project</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management Portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>Click on <strong>Resource groups</strong> <strong>&gt;</strong> <strong>contososports</strong> resource group.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image112.png" title="Azure Portal" alt="In the Azure Portal left menu, Resource groups is selected. On the right, underResource groups, under Name, contososports is selected." /></p></li>
<li><p>Click on the <strong>App Service Web App</strong> for the front-end Web Application.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image113.png" title="Resource Group blade" alt="In the Resource Group blade on the right, under Name, contososportsweb4 is selected." /></p></li>
<li><p>On the <strong>App Service</strong> blade, scroll down, and click on <strong>Application settings</strong> in the left pane.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image114.png" title="App Service blade" alt="In the App Service blade, under settings, Application settings is selected." /><figcaption>In the App Service blade, under settings, Application settings is selected.</figcaption>
</figure></li>
<li><p>Scroll down, and locate the <strong>App settings</strong> section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image115.png" title="App settings section" alt="The App settings section of the App Service blade displays with AzureQueueConnectionString selected." /></p></li>
<li><p>Add a new <strong>App Setting</strong> with the following values:</p>
<ol type="a">
<li><p>Key: <strong>paymentsAPIUrl</strong></p></li>
<li><p>Value: enter the <strong>HTTPS</strong> URL for the Payments API App with <strong>/api/nvp</strong> appended to the end. Ex: https://paymentsapi0.azurewebsites.net/api/nvp<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image116.png" title="App settings" alt="In the App settings section of the App Service blade, the previously defined app setting values are selected." /></p></li>
</ol></li>
<li><p>Add a new <strong>App Setting</strong> with the following values:</p>
<ol start="3" type="a">
<li><p>Key: <strong>offersAPIUrl</strong></p></li>
<li><p>Value: enter the <strong>HTTPS</strong> URL for the Offers API App with <strong>/api/get</strong> appended to the end. Ex: https://offersapi4.azurewebsites.net/api/get<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image117.png" title="App settings section" alt="In the App settings section of the App Service blade, the previously defined app setting values are selected." /></p></li>
</ol></li>
<li><p>Click on <strong>Save</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image118.png" title="App Service blade" alt="The Save button is circled on the App Service blade." /></p></li>
</ol>
<p><strong>Note:</strong> Ensure both of the API URLs are using <strong>SSL</strong> (https://), or you will see a CORS errors.</p>
<h4 id="subtask-2-validate-app-settings-are-correct">Subtask 2: Validate App Settings are correct</h4>
<ol type="1">
<li><p>On the <strong>App Service</strong> blade, click on <strong>Overview</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image119.png" title="App Service blade" alt="Overview is selected on the left side of the App Service blade." /></p></li>
<li><p>In the <strong>Overview</strong> pane, click on the <strong>URL</strong> for the Web App to open it in a new browser tab.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image120.png" title="App Service blade" alt="On the right side of the App Service blade, under Essentials, the URL (http://contososportsweb4.azurewebsites.net) link is circled." /></p></li>
<li><p>On the homepage, you should see the latest offers populated from the Offers API.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image121.png" title="Contoso Sports League webpage" alt="On the Contoso Sports League webpage, Today&#39;s offers display: Baseball socks, Road bike, and baseball mitt." /><figcaption>On the Contoso Sports League webpage, Today's offers display: Baseball socks, Road bike, and baseball mitt.</figcaption>
</figure></li>
<li><p>Submit several test orders to ensure all pieces of the site are functional.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image122.png" title="Contoso Sports League webpage" alt="On the Contoso Sports League webpage, the message Order Completed displays." /><figcaption>On the Contoso Sports League webpage, the message Order Completed displays.</figcaption>
</figure></li>
</ol>
<p><strong>Leader Note:</strong> If the attendee is still experiencing CORS errors ensure the URLs to the Web App in Azure local host are exact.</p>
<h2 id="exercise-2-identity-and-security">Exercise 2: Identity and security</h2>
<p>Duration: 75 Minutes</p>
<p>The Contoso call center admin application will only be accessible by users of the Contoso Active Directory environment. You have been asked to create a new Azure AD Tenant and secure the application so only users from the tenant can log on.</p>
<h3 id="task-1-enable-azure-ad-premium-trial">Task 1: Enable Azure AD Premium Trial</h3>
<p>Note: this task is <strong>optional</strong>, and it is valid only if you are a global administrator on the Azure AD tenant associated with your subscription.</p>
<ol type="1">
<li><p>Navigate to the Azure Management portal, <a href="http://portal.azure.com/">http://portal.azure.com</a>, using a new tab or instance.</p></li>
<li><p>Click on <strong>More services</strong> followed by <strong>Azure Active Directory</strong> under the SECURITY + IDENTITY section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image123.png" title="Azure Portal" alt="In the Azure Portal, on the left More services is selected. On the right, under Security + Identity, Azure Active Directory is selected." /></p></li>
<li><p>On the <strong>Azure Active Directory</strong> blade, locate and click on the <strong>Company branding</strong> option.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image124.png" title="Azure Active Directory blade" alt="In the Azure Active Directory blade, Company branding is selected." /></p></li>
<li><p>Click on the option to <strong>Get a free Premium trial</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image125.png" title="Azure Active Directory blade" alt="On the left side of the Azure Active Directory blade, Company branding is selected. On the right side, the Get a free Premium trial link is selected." /></p></li>
</ol>
<p>If you already have a Premium Azure Active Directory, skip to Task 2.</p>
<ol start="5" type="1">
<li><p>On the <strong>Activate</strong> blade, click on the <strong>Free Trial</strong> link within the AZURE AD PREMIUM box.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image126.png" title="Activate blade" alt="The Free trial link is selected on the Activate blade." /></p></li>
<li><p>On the <strong>Active Azure AD Premium trial</strong> blade, click the <strong>Activate</strong> button.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image127.png" title="Active Azure AD Premium trial blade" alt="On the Active Azure AD Premium trial blade, the Activate button is circled." /></p></li>
<li><p>Close the <strong>Azure Active Directory</strong> blades.</p></li>
</ol>
<h3 id="task-2-create-a-new-contoso-user">Task 2: Create a new Contoso user</h3>
<p>Note: this task is <strong>optional</strong>, and it is valid only if you are a global administrator on the Azure AD tenant associated with your subscription.</p>
<ol type="1">
<li><p>Navigate to the Azure Management portal, <a href="http://portal.azure.com/">http://portal.azure.com</a>, using a new tab or instance.</p></li>
<li><p>Click on <strong>More services</strong> <strong>&gt;</strong> <strong>Azure Active Directory</strong> under the SECURITY + IDENTITY section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image123.png" title="Azure Portal" alt="On the left side of the Azure Portal, More services is selected. On the right side, under Security + Identity, Azure Active Directory is selected." /></p></li>
<li><p>On the <strong>Azure Active Directory</strong> blade, click on <strong>Domain</strong> names.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image128.png" title="Azure Active Directory blade" alt="Domain names is selected on the Azure Active Directory blade." /></p></li>
<li><p>Copy the <strong>Domain Name</strong> for your Azure AD Tenant. It will be in the format: <em>[your tenant].onmicrosoft.com</em> This will be used for creating the new user’s Username.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image129.png" title="Domain name" alt="Under Name, the Domain Name is selected." /></p></li>
<li><p>On the <strong>Azure Active Directory</strong> blade, click on <strong>Users and groups</strong> followed by <strong>All users</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image130.png" title="Azure Active Directory blade" alt="On the left side of the Azure Active Directory blade, under Manage, Users and Groups is selected. On the right side, under Manage, All users is selected." /></p></li>
<li><p>Click on <strong>+Add</strong> to add a new user.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image131.png" title="Azure Active Directory blade" alt="The Add button is circled on the Azure Active Directory blade." /></p></li>
<li><p>On the <strong>User</strong> blade, specify a user’s <strong>Name</strong> and <strong>Username</strong>. Specify the <strong>Username</strong> to be at the domain name for your Azure AD Tenant. For example: <em>tbaker@[your tenant].onmicrosoft.com</em><br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image132.png" title="User blade" alt="On the User blade, the two previously defined fields (Name and User name) are circled." /></p></li>
<li><p>Click on the <strong>Show Password</strong> checkbox, and make a note of the Password for use later.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image133.png" title="Password section" alt="The Show Password checkbox is selected." /></p></li>
<li><p>Click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image134.png" title="Create button" alt="Screenshot of the Create button." /><figcaption>Screenshot of the Create button.</figcaption>
</figure></li>
</ol>
<h3 id="task-3-configure-access-control-for-the-call-center-administration-web-application">Task 3: Configure access control for the call center administration Web Application</h3>
<p>Note: This task is <strong>optional</strong>, and it is valid only if you have the right to create applications in your Azure AD Tenant.</p>
<h4 id="subtask-1-enable-azure-ad-authentication">Subtask 1: Enable Azure AD Authentication</h4>
<ol type="1">
<li><p>On the left navigation of the Azure Portal, select <strong>App Services</strong> (or click <strong>More services</strong> <strong>&gt;</strong> <strong>App Services</strong>).</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image135.png" title="App Services button" alt="Screenshot of the App Services button." /><figcaption>Screenshot of the App Services button.</figcaption>
</figure></li>
<li><p>On the <strong>Web Apps</strong> page, select the <strong>call center administration Web App</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image136.png" title="App Services blade" alt="In the App Services blade, under Name, contososportsadmin4 is selected." /><figcaption>In the App Services blade, under Name, contososportsadmin4 is selected.</figcaption>
</figure></li>
<li><p>Click the <strong>Authentication / Authorization</strong> tile.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image137.png" title="App Service blade" alt="On the App Service blade, under Settings, Authentication / Authorization is selected." /><figcaption>On the App Service blade, under Settings, Authentication / Authorization is selected.</figcaption>
</figure></li>
<li><p>Change <strong>App Service Authentication</strong> to <strong>On</strong>, and change the dropdown to <strong>Log in with Azure Active Directory</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image138.png" title="Authentication / Authorization section" alt="The Authentication / Authorization section displays with App Service Authentication button set to On, and Log in with Azure Active Directory selected in the Action to take when request is not authenticated drop-down list box." /><figcaption>The Authentication / Authorization section displays with App Service Authentication button set to On, and Log in with Azure Active Directory selected in the Action to take when request is not authenticated drop-down list box.</figcaption>
</figure></li>
<li><p>Click on the <strong>Azure Active Directory</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image139.png" title="Authentication Providers section" alt="In the Authentication Providers section, Azure Active Directory (Not Configured) is selected." /></p></li>
<li><p>On the <strong>Azure Active Directory Settings</strong> blade, change <strong>Management mode</strong> to <strong>Express</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image140.png" title="Azure Active Directory Settings blade" alt="At the bottom of the Azure Active Directory Settings blade, Management mode is set to Express." /><figcaption>At the bottom of the Azure Active Directory Settings blade, Management mode is set to Express.</figcaption>
</figure></li>
<li><p>Click <strong>OK</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image141.png" title="OK button" alt="Screenshot of the OK button." /></p></li>
<li><p>Change the <strong>Action to take when request is not authenticated</strong> option to <strong>Login with Azure Active Directory</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image142.png" title="Action to take field" alt="The Action to take when request is not authenticated field is set to Log in with Azure Authentication." /><figcaption>The Action to take when request is not authenticated field is set to Log in with Azure Authentication.</figcaption>
</figure></li>
<li><p>In the <strong>Authentication / Authorization</strong> blade, click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image143.png" title="App Service blade" alt="The Save button is circled in the App Service blade." /><figcaption>The Save button is circled in the App Service blade.</figcaption>
</figure></li>
</ol>
<h4 id="subtask-2-verify-the-call-center-administration-website-uses-the-access-control-logon">Subtask 2: Verify the call center administration website uses the access control logon</h4>
<ol type="1">
<li><p>Close your browser (or use an alternative), and launch a browser is InPrivate or Incognito mode. Navigate to the <strong>call center administration</strong> website.</p></li>
<li><p>The browser will redirect to the non-branded Access Control logon URL. You can log on with your Microsoft account or the <strong>Contoso test user</strong> you created earlier.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image144.png" title="Browser window" alt="The contososportsadmin4 Access control logon webpage displays in a private / incognito window." /><figcaption>The contososportsadmin4 Access control logon webpage displays in a private / incognito window.</figcaption>
</figure></li>
<li><p>After you log on and <strong>accept the consent</strong>, your browser will be redirected to the Contoso Sports League Admin webpage.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image145.png" title="Contoso Sports League Admin webpage" alt="The Contoso Sports League Admin webpage displays with one Completed Order." /><figcaption>The Contoso Sports League Admin webpage displays with one Completed Order.</figcaption>
</figure></li>
<li><p>Verify in the upper-right corner you see the link <strong>Logged In</strong>. If it is not configured, you will see <strong>Sign in</strong>.</p>
<p><img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image146.png" title="Logged in message" alt="Screenshot of the Logged In message." /> <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image147.png" title="Sign in link" alt="Screenshot of the Sign In link." /></p></li>
</ol>
<h3 id="task-4-apply-custom-branding-for-the-azure-active-directory-logon-page">Task 4: Apply custom branding for the Azure Active Directory logon page</h3>
<p>Note: this task is <strong>optional</strong>, and it is valid only if you are a global administrator on the Azure AD tenant associated with your subscription, and you completed the Enabling Azure AD Premium exercise.</p>
<ol type="1">
<li><p>Navigate to the Azure Management portal, <a href="http://portal.azure.com/">http://portal.azure.com</a>, using a new tab or instance.</p></li>
<li><p>Click on <strong>More services</strong> <strong>&gt;</strong> <strong>Azure Active Directory</strong> under the SECURITY + IDENTITY section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image123.png" title="Azure Portal" alt="On the left side of the Azure Portal, More services is selected. On the right side, under Security + Identity, Azure Active Directory is selected." /></p></li>
<li><p>On the <strong>Azure Active Directory</strong> blade, click on <strong>Company branding</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image148.png" title="Azure Active Directory blade" alt="On the Azure Active Directory blade, Company branding is selected." /></p></li>
<li><p>Click on the <strong>Configure company branding now</strong> link.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image149.png" title="Company branding section" alt="The Configure company branding link is selected." /></p></li>
<li><p>On the <strong>Configure company branding</strong> blade, select the <strong>default_signin_illustration.jpg</strong> image file from <strong>C:\hackathon</strong> for the <strong>Sign-in page image</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image150.png" title="Configure company branding blade" alt="The Configure company branding blade displays the default sign in picture of the Contoso sports league text, and a person on a bicycle. Below that, the Select a file field and browse icon is selected." /></p></li>
<li><p>Select the <strong>logo-60-280.png</strong> image file from <strong>C:\hackathon</strong> for the <strong>Banner image</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image151.png" title="Contoso sports league banner" alt="The Contoso sports league banner text displays." /></p>
<p>Click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image152.png" title="Configure company branding blade" alt="The Save button is circled on the Configure company branding blade." /><figcaption>The Save button is circled on the Configure company branding blade.</figcaption>
</figure></li>
</ol>
<h3 id="task-5-verify-the-branding-has-been-successfully-applied-to-the-azure-active-directory-logon-page">Task 5: Verify the branding has been successfully applied to the Azure Active Directory logon page</h3>
<ol type="1">
<li><p>Close any previously authenticated browser sessions to the call center administration website, reopen using InPrivate or Incognito mode, and navigate to the <strong>call center administration</strong> website.</p></li>
<li><p>The browser will redirect to the branded access control logon URL.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image153.png" title="Call center administration website" alt="The Call center administration Sign in webpage displays in an InPrivate / Incognito browser" /><figcaption>The Call center administration Sign in webpage displays in an InPrivate / Incognito browser</figcaption>
</figure></li>
<li><p>After you log on, your browser will be redirected to the Contoso Sports League Admin webpage.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image145.png" title="Contoso Sports League Admin webpage" alt="The Contoso Sports League Admin webpage displays with one completed order." /><figcaption>The Contoso Sports League Admin webpage displays with one completed order.</figcaption>
</figure></li>
<li><p>Verify in the upper-right corner you see the link <strong>Logged in</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image146.png" title="Logged in message" alt="Screenshot of the Logged in message." /><figcaption>Screenshot of the Logged in message.</figcaption>
</figure></li>
<li><p>If you run the app using localhost, ensure connection strings for all of the web.config files in the solution have the placeholders removed with actual values. Search on web.config in the solution explorer to come up with the list.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image154.png" title="Solution Explorer" alt="In Solution Explorer, the following path is expanded: API\Contoso.Apps.PaymentGateway\Areas\HelpPage\Views. In the Views folder, Web.config is selected. In addition, the Web.config file is highlighted in several other folders." /><figcaption>In Solution Explorer, the following path is expanded: API\Contoso.Apps.PaymentGateway\Areas\HelpPage\Views. In the Views folder, Web.config is selected. In addition, the Web.config file is highlighted in several other folders.</figcaption>
</figure></li>
</ol>
<h2 id="exercise-3-enable-azure-b2c-for-customer-site">Exercise 3: Enable Azure B2C for customer site</h2>
<p>Duration: 75 minutes</p>
<p>In this exercise, you will configure an Azure AD Business to Consumer (B2C) instance to enable authentication and policies for sign-in, sign-out and profile policies for the Contoso E-Commerce site.</p>
<h3 id="task-1-create-a-new-directory">Task 1: Create a new directory</h3>
<ol type="1">
<li><p>Log in to the Azure portal by using your existing Azure subscription or by starting a free trial. At the left bottom of the screen, click <strong>New</strong> <strong>&gt;</strong> <strong>Azure Active Directory B2C</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image155.png" title="Azure Portal" alt="In the Azure Portal, under New, in the search field is active directory B2C." /><figcaption>In the Azure Portal, under New, in the search field is active directory B2C.</figcaption>
</figure>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image156.png" title="Everything blade" alt="In the Everything blade, the active directory B2C text is in the Search field, and under Results, Azure Active Directory B2C displays." /><figcaption>In the Everything blade, the active directory B2C text is in the Search field, and under Results, Azure Active Directory B2C displays.</figcaption>
</figure></li>
<li><p>Enter for the name, <strong>ContosoB2C</strong> and a unique domain name and region. Click <strong>Create a new Azure AD B2C Tenant</strong>, and it will take a minute to complete. Click the link to manage your new B2C Directory.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image157.png" title="Azure Portal" alt="In the Azure Portal, under Create new B2C Tenant or Link to existing Tenant, Create a new Azure AD B2C Tenant is selected. On the right, the word &quot;here,&quot; which is a link, is circled in the Click here to manage your new directory message." /><figcaption>In the Azure Portal, under Create new B2C Tenant or Link to existing Tenant, Create a new Azure AD B2C Tenant is selected. On the right, the word &quot;here,&quot; which is a link, is circled in the Click here to manage your new directory message.</figcaption>
</figure></li>
<li><p>Click on the orange No Subscription message for instructions on how to link to an active subscription.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image158.png" title="Azure Portal" alt="In the Azure Portal, on the left, the &quot;No subscription linked to this B2C tenant or the Subscription needs your attention&quot; message is selected. On the right, under Subscription reminder, the three steps to link the B2C tenant to an Azure subscription are circled." /><figcaption>In the Azure Portal, on the left, the &quot;No subscription linked to this B2C tenant or the Subscription needs your attention&quot; message is selected. On the right, under Subscription reminder, the three steps to link the B2C tenant to an Azure subscription are circled.</figcaption>
</figure></li>
</ol>
<p>Note: Essentially, you will need to switch back to your previous Azure AD tenant, and then launch the Azure AD B2C creation wizard again.</p>
<ol start="4" type="1">
<li><p>Click on <strong>Link an existing Azure AD B2C Tenant to my Azure subscription,</strong> and select the Tenant you just created in the dropdown list and existing resource group. Press <strong>Create</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image159.png" title="Create new B2C Tenant or Link to existing Tenant" alt="In the Create new B2C Tenant or Link to existing Tenant blade, on the left, Link an existing Azure AD B2C Tenant to my Azure subscription is selected. On the right, in the Azure AD B2C Resource blade, the Azure AD B2C Tenant drop-down field is contosob2cdemo123.onmicrosoft.com. The Resource group is using the existing contososports." /></p></li>
<li><p>Open the new Azure AD B2C tenant.</p></li>
<li><p>Click on <strong>All Settings &gt; Applications &gt; +Add</strong>.</p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image160.png" title="Azure AD B2C Settings window" alt="In the Azure AD B2C Settings window, on the left, All Settings is selected. In the middle, under Settings, under Manage, Applications is selected. On the right, under Applications, the Add button is selected." /><figcaption>In the Azure AD B2C Settings window, on the left, All Settings is selected. In the middle, under Settings, under Manage, Applications is selected. On the right, under Applications, the Add button is selected.</figcaption>
</figure>
<h3 id="task-2-add-a-new-application">Task 2: Add a new application</h3>
<ol type="1">
<li><p>Specify the following configuration options for the Web App:</p>
<ul>
<li><p>Name: Contoso B2C Application</p></li>
<li><p>Reply URL: https://[your web url].azurewebsites.net &lt;- this should be the HTTPS URL to the Contoso E-Commerce Site.</p></li>
<li><p>Include Web App / web API: Yes</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image161.png" title="New application" alt="The New application fields are set to the previously defined values." /><figcaption>The New application fields are set to the previously defined values.</figcaption>
</figure></li>
</ul></li>
<li><p>Click <strong>Create</strong>.</p></li>
<li><p>Click the application you just created, and copy down the globally unique <strong>Application ID</strong> you will use later in your code.</p></li>
</ol>
<h3 id="task-3-create-policies-sign-up">Task 3: Create Policies, Sign up</h3>
<ol type="1">
<li><p>Open your Azure AD B2C Tenant in the Azure management portal.</p></li>
<li><p>To enable sign-up on your application, you will need to create a sign-up policy. This policy describes the experiences consumers will go through during sign-up and the contents of tokens the application will receive on successful sign-ups. Click <strong>Sign-up or sign-in policies</strong> as well as <strong>+Add</strong> at the top of the blade.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image162.png" title="Azure Portal" alt="In the Azure Portal, on the left, under Policies, Sign-up or sign-in policies is selected. On the right, the Add button is circled." /><figcaption>In the Azure Portal, on the left, under Policies, Sign-up or sign-in policies is selected. On the right, the Add button is circled.</figcaption>
</figure></li>
<li><p>The <strong>Name</strong> determines the sign-up policy name used by your application. For example, enter &quot;SiUp.&quot;</p></li>
<li><p>Click <strong>Identity providers</strong>, and select &quot;Email signup.&quot; Optionally, you can also select social identity providers (if previously configured for the tenant). Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image163.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade, Identity providers is selected. In the Select identity providers blade, Email signup is selected." /><figcaption>In the Add policy blade, Identity providers is selected. In the Select identity providers blade, Email signup is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Sign-up attributes</strong>. Here, you choose attributes you want to collect from the consumer during sign-up. For example, select &quot;Country/Region,&quot; &quot;Display Name&quot; and &quot;Postal Code.&quot; Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image164.png" title="Add policy and Select sign-up attributes blades" alt="In the Add policy blade, Sign-up attributes, with the message &quot;3 selected&quot; is selected. In the Select sign-up attributes blade, the following strings are selected: Country / Region, Display Name, and Postal Code." /><figcaption>In the Add policy blade, Sign-up attributes, with the message &quot;3 selected&quot; is selected. In the Select sign-up attributes blade, the following strings are selected: Country / Region, Display Name, and Postal Code.</figcaption>
</figure></li>
<li><p>Click <strong>Application claims</strong>. Here, you choose claims you want returned in the tokens sent back to your application after a successful sign-up experience. For example, select &quot;Display Name,&quot; &quot;Identity Provider,&quot; &quot;Postal Code,&quot; &quot;User is new&quot; and &quot;User's Object ID.&quot; Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image165.png" title="Add policy and Select application claims blades" alt="In the Add policy blade, Application claims with the message &quot;5 Selected&quot; is selected. In the Select application claims blade, the following five strings are selected: Display Name, Identity Provider, Postal Code, User is new, and User&#39;s Object ID." /><figcaption>In the Add policy blade, Application claims with the message &quot;5 Selected&quot; is selected. In the Select application claims blade, the following five strings are selected: Display Name, Identity Provider, Postal Code, User is new, and User's Object ID.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong>. Observe the policy just created appears as &quot;<strong>B2C_1_SiUp</strong>&quot; (the <strong>B2C_1_</strong> fragment is automatically added) in the <strong>Sign-up policies</strong> blade.</p></li>
<li><p>Open the policy by clicking &quot;<strong>B2C_1_SiUp</strong>.&quot;</p></li>
<li><p>Select <strong>&quot;Contoso B2C app&quot;</strong> in the <strong>Applications</strong> drop-down.</p></li>
<li><p>Click <strong>Run now</strong>. A new browser tab opens, and you can run through the consumer experience of signing up for your application.</p></li>
</ol>
<h3 id="task-4-create-a-sign-in-policy">Task 4: Create a sign-in policy</h3>
<p>To enable sign-in on your application, you will need to create a sign-in policy. This policy describes the experiences consumers will go through during sign-in and the contents of tokens the application will receive on successful sign-ins.</p>
<ol type="1">
<li><p>Click <strong>Sign-in policies</strong>.</p>
<p><img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image166.png" title="Policies section" alt="In the Policies section, Sign-in policies is selected." />s</p></li>
<li><p>Click <strong>+Add</strong> at the top of the blade.</p></li>
<li><p>The <strong>Name</strong> determines the sign-in policy name used by your application. For example, enter &quot;<strong>SiIn</strong>&quot; &lt;the 3<sup>rd</sup> letter is an upper case i&gt;.</p></li>
<li><p>Click <strong>Identity providers</strong> and select &quot;<strong>Local Account SignIn</strong>.&quot; Optionally, you can also select social identity providers, if already configured. Click <strong>OK</strong>.</p></li>
</ol>
<blockquote>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image167.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade, Identity providers with the message &quot;1 Selected&quot; is selected. In the Select identity providers blade, Local Account SignIn is selected." /><figcaption>In the Add policy blade, Identity providers with the message &quot;1 Selected&quot; is selected. In the Select identity providers blade, Local Account SignIn is selected.</figcaption>
</figure>
</blockquote>
<ol start="5" type="1">
<li><p>Click <strong>Application claims</strong>. Here you choose claims that you want returned in the tokens sent back to your application after a successful sign-in experience. For example, select &quot;Display Name,&quot; &quot;Identity Provider,&quot; &quot;Postal Code,&quot; and &quot;User's Object ID.&quot; Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image168.png" title="Add policy and Select application claims blades" alt="In the Add policy blade, Application claims (4 Selected) is selected. In the Select application claims blade, the following five application claims are selected: Display Name, Identity Provider, Postal Code, and User&#39;s Object ID." /><figcaption>In the Add policy blade, Application claims (4 Selected) is selected. In the Select application claims blade, the following five application claims are selected: Display Name, Identity Provider, Postal Code, and User's Object ID.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong>. Observe the policy just created appears as &quot;<strong>B2C_1_SiIn</strong>&quot; (the <strong>B2C_1_</strong> fragment is automatically added) in the <strong>Sign-in policies</strong> blade.</p></li>
<li><p>Open the policy by clicking &quot;<strong>B2C_1_SiIn</strong>.&quot;</p></li>
<li><p>Select &quot;Contoso B2C app&quot; in the <strong>Applications</strong> drop-down.</p></li>
<li><p>Click <strong>Run now</strong>. A new browser tab opens, and you can run through the consumer experience of signing into your application.</p></li>
</ol>
<h3 id="task-5-create-a-profile-editing-policy">Task 5: Create a profile editing policy</h3>
<p>To enable profile editing on your application, you will need to create a profile editing policy. This policy describes the experiences that consumers will go through during profile editing and the contents of tokens that the application will receive on successful completion.</p>
<ol type="1">
<li><p>Click <strong>Profile editing policies</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image169.png" title="Policies section" alt="In the Policies section, Profile editing policies is selected." /><figcaption>In the Policies section, Profile editing policies is selected.</figcaption>
</figure></li>
<li><p>Click <strong>+Add</strong> at the top of the blade.</p></li>
<li><p>The Name determines the profile editing policy name used by your application. For example, enter &quot;SiPe.&quot;</p></li>
<li><p>Click Identity providers, and select &quot;<strong>Local Account SignIn</strong>.&quot; Optionally, you can also select social identity providers, if already configured. Click <strong>OK</strong>.</p></li>
</ol>
<blockquote>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image170.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade, Identity providers (1 Selected) is selected. In the Select identity providers blade, Local Account SignIn is selected." /><figcaption>In the Add policy blade, Identity providers (1 Selected) is selected. In the Select identity providers blade, Local Account SignIn is selected.</figcaption>
</figure>
</blockquote>
<ol start="5" type="1">
<li><p>Click <strong>Profile attributes</strong>. Here, you choose attributes the consumer can view and edit. For example, select &quot;Country/Region,&quot; &quot;Display Name,&quot; “Job Title,&quot; &quot;Postal Code,&quot;”State/Province,&quot; and “Street Address.” Click <strong>OK</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image171.png" title="Add policy and Select identity providers blades" alt="In the Add policy blade,Profile attributes (6 Selected) is selected. In the Profile attributes blade, the following six profile attributes are selected: Country / Region, Display Name, Job Title, Postal Code, State / Province, and Street Address." /><figcaption>In the Add policy blade,Profile attributes (6 Selected) is selected. In the Profile attributes blade, the following six profile attributes are selected: Country / Region, Display Name, Job Title, Postal Code, State / Province, and Street Address.</figcaption>
</figure></li>
<li><p>Click <strong>Application claims</strong>. Here, you choose claims you want returned in the tokens sent back to your application after a successful profile editing experience. For example, select &quot;Display Name&quot; and &quot;Postal Code.&quot; Click <strong>OK</strong></p></li>
<li><p>Click <strong>Create</strong>. Observe the policy just created appears as &quot;<strong>B2C_1_SiPe</strong>&quot; (the <strong>B2C_1_</strong> fragment is automatically added) in the <strong>Profile editing policies</strong> blade.</p></li>
<li><p>Open the policy by clicking &quot;<strong>B2C_1_SiPe</strong>.&quot;</p></li>
<li><p>Select &quot;Contoso B2C app&quot; in the <strong>Applications</strong> drop-down.</p></li>
<li><p>Click <strong>Run now</strong>. A new browser tab opens, and you can run through the profile editing consumer experience in your application.</p></li>
</ol>
<h3 id="task-6-modify-the-contoso.app.sportsleague.web">Task 6: Modify the Contoso.App.SportsLeague.Web</h3>
<ol type="1">
<li><p>Within Visual Studio, click on <strong>View -&gt; Other Windows -&gt; Package Manager Console</strong>. Execute the following commands to install these the required NuGet Packages.</p>
<pre><code>Install-Package Microsoft.Owin.Security.OpenIdConnect -Version 3.0.1
Install-Package Microsoft.Owin.Security.Cookies -Version 3.0.1
Install-Package Microsoft.Owin.Host.SystemWeb -Version 3.0.1
Install-Package Microsoft.IdentityModel.Protocol.Extensions -Version 1.0.4.403061554</code></pre></li>
<li><p>Next, using the Azure Management Portal, open the Contoso E-Commerce Site, and click on App Settings.</p></li>
<li><p>Add the following settings:</p>
<ul>
<li><p>ida:Tenant - [your Azure AD B2C name].onmicrosoft.com</p></li>
<li><p>ida:ClientId – [the client/app ID from your app]</p></li>
<li><p>ida:RedirectUri - https://[your web url].azurewebsites.net</p></li>
<li><p>ida:SignupPolicyId – B2C_1_SiUp</p></li>
<li><p>ida:SignInPolicyId – B2C_1_SiIn &lt;the 3<sup>rd</sup> letter is an upper case i&gt;</p></li>
<li><p>ida:UserProfilePolicyId – B2C_1_SiPe</p></li>
<li><p>ida:AadInstance - https://login.microsoftonline.com/{0}/v2.0/.well-known/openid-configuration?p={1}</p></li>
</ul>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image172.png" title="App settings" alt="In the App settings section, the previously mentioned settings are circled." /><figcaption>In the App settings section, the previously mentioned settings are circled.</figcaption>
</figure></li>
<li><p>Click <strong>Save</strong> when you are complete.</p></li>
<li><p>Within Visual Studio, <strong>right</strong> click on the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and click <strong>Add -&gt; New Item.</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image173.png" title="Solution Explorer" alt="In Solution Explorer, the Web folder is expanded, and Contoso.Apps.SportsLeague.Web is selected. From its right-click menu, Add is selected, and from its menu, New item is selected." /><figcaption>In Solution Explorer, the Web folder is expanded, and Contoso.Apps.SportsLeague.Web is selected. From its right-click menu, Add is selected, and from its menu, New item is selected.</figcaption>
</figure></li>
<li><p>In the Search Installed Templates search box search for OWIN. Click the OWIN Startup class, change the name to <strong>Startup.cs,</strong> and then click <strong>Add</strong>.</p></li>
<li><p>In the new class, insert the word partial in between public and class to make this a partial class.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image174.png" title="New class section" alt="In the New class section, the word &quot;partial&quot; is circled in the line, &quot;public partial class Startup&quot;." /><figcaption>In the New class section, the word &quot;partial&quot; is circled in the line, &quot;public partial class Startup&quot;.</figcaption>
</figure></li>
<li><p>Add the following code between the brackets of the Configuration method.</p>
<pre><code>ConfigureAuth(app);</code></pre>
<pre><code>// Startup.cs

public partial class Startup

{

public void Configuration(IAppBuilder app)

{

ConfigureAuth(app);

}

}</code></pre></li>
</ol>
<p>Note: The OWIN middleware will invoke the Configuration(...) method when your app starts.</p>
<ol start="9" type="1">
<li><p>Right click on the <strong>App_Start</strong> folder, and click <strong>Add -&gt; Class</strong>.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image175.png" title="Solution Explorer" alt="In Solution Explorer, on the App Start folder&#39;s right-click menu, Add is selected, and from its menu, Class is selected." /></p></li>
<li><p>Select <strong>Visual C# and Class,</strong> and name the new file <strong>Startup.Auth.cs</strong>.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image176.png" title="Installed and Sort by fields" alt="In the Installed field, Visual C# is selected. In the Sort by field, Class is selected." /></p></li>
<li><p>Replace the entire contents of Startup.Auth.cs with the following code:</p>
<pre><code>// App\_Start\\Startup.Auth.cs

using System;

using Owin;

using Microsoft.Owin.Security;

using Microsoft.Owin.Security.Cookies;

using Microsoft.Owin.Security.OpenIdConnect;

using System.Threading.Tasks;

using Microsoft.Owin.Security.Notifications;

using Microsoft.IdentityModel.Protocols;

using System.Configuration;

using System.IdentityModel.Tokens;

using System.Web.Helpers;

using System.IdentityModel.Claims;

namespace Contoso.Apps.SportsLeague.Web

{

public partial class Startup

{

// App config settings

private static string clientId = ConfigurationManager.AppSettings\[\&quot;ida:ClientId\&quot;\];

private static string aadInstance = ConfigurationManager.AppSettings\[\&quot;ida:AadInstance\&quot;\];

private static string tenant = ConfigurationManager.AppSettings\[\&quot;ida:Tenant\&quot;\];

private static string redirectUri = ConfigurationManager.AppSettings\[\&quot;ida:RedirectUri\&quot;\];

// B2C policy identifiers

public static string SignUpPolicyId = ConfigurationManager.AppSettings\[\&quot;ida:SignUpPolicyId\&quot;\];

public static string SignInPolicyId = ConfigurationManager.AppSettings\[\&quot;ida:SignInPolicyId\&quot;\];

public static string ProfilePolicyId = ConfigurationManager.AppSettings\[\&quot;ida:UserProfilePolicyId\&quot;\];

public void ConfigureAuth(IAppBuilder app)

{

app.SetDefaultSignInAsAuthenticationType(CookieAuthenticationDefaults.AuthenticationType);

app.UseCookieAuthentication(new CookieAuthenticationOptions());

// Configure OpenID Connect middleware for each policy

app.UseOpenIdConnectAuthentication(CreateOptionsFromPolicy(SignUpPolicyId));

app.UseOpenIdConnectAuthentication(CreateOptionsFromPolicy(ProfilePolicyId));

app.UseOpenIdConnectAuthentication(CreateOptionsFromPolicy(SignInPolicyId));

AntiForgeryConfig.UniqueClaimTypeIdentifier = ClaimTypes.NameIdentifier;

}

// Used for avoiding yellow-screen-of-death

private Task AuthenticationFailed(AuthenticationFailedNotification\&lt;OpenIdConnectMessage, OpenIdConnectAuthenticationOptions\&gt; notification)

{

notification.HandleResponse();

if (notification.Exception.Message == \&quot;access\_denied\&quot;)

{

notification.Response.Redirect(\&quot;/\&quot;);

}

else

{

notification.Response.Redirect(\&quot;/Home/Error?message=\&quot; + notification.Exception.Message);

}

return Task.FromResult(0);

}

private OpenIdConnectAuthenticationOptions CreateOptionsFromPolicy(string policy)

{

return new OpenIdConnectAuthenticationOptions

{

// For each policy, give OWIN the policy-specific metadata address, and

// set the authentication type to the id of the policy

MetadataAddress = String.Format(aadInstance, tenant, policy),

AuthenticationType = policy,

// These are standard OpenID Connect parameters, with values pulled from web.config

ClientId = clientId,

RedirectUri = redirectUri,

PostLogoutRedirectUri = redirectUri,

Notifications = new OpenIdConnectAuthenticationNotifications

{

AuthenticationFailed = AuthenticationFailed,

},

Scope = \&quot;openid\&quot;,

ResponseType = \&quot;id\_token\&quot;,

// This piece is optional - it is used for displaying the user\&#39;s name in the navigation bar.

TokenValidationParameters = new TokenValidationParameters

{

NameClaimType = \&quot;name\&quot;,

},

};

}

}

}</code></pre></li>
</ol>
<p>Note: The parameters you provide in OpenIdConnectAuthenticationOptions serve as coordinates for your app to communicate with Azure AD. You also need to set up cookie authentication. The OpenID Connect middleware uses cookies to maintain user sessions, among other things.</p>
<h3 id="task-7-send-authentication-requests-to-azure-ad">Task 7: Send authentication requests to Azure AD</h3>
<p>Your app is now properly configured to communicate with Azure AD B2C by using the OpenID Connect authentication protocol. OWIN has taken care of all of the details of crafting authentication messages, validating tokens from Azure AD, and maintaining user session. All that remains is to initiate each user's flow.</p>
<ol type="1">
<li><p>Right click on the <strong>Controllers</strong> folder, and click <strong>Add</strong> -&gt; <strong>Controller</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image177.png" title="Solution Explorer" alt="In Solution Explorer, in the right-click menu for the Controllers folder, Add is selected, and from its menu, Controller is selected." /></p></li>
<li><p>Select <strong>MVC 5 Controller – Empty, and click Add.</strong> Replace <strong>Default</strong> with <strong>Account</strong> for the controller name.<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image178.png" title="Add Scaffold window" alt="On the left of the Add Scaffold window, Installed / Controller is selected. In the center of the window, MVC 5 Controller - Empty is selected." /></p></li>
<li><p>Add the following using statement to the top of the controller:</p>
<pre><code>using Microsoft.Owin.Security;</code></pre></li>
<li><p>Replace the default controller method Index</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image179.png" title="Default controller method Index" alt="The Default controller method Index is circled." /><figcaption>The Default controller method Index is circled.</figcaption>
</figure>
<p>With the following code:</p>
<pre><code>// Controllers\\AccountController.cs

public void SignIn()

{

if (!Request.IsAuthenticated)

{

// To execute a policy, you simply need to trigger an OWIN challenge.

// You can indicate which policy to use by specifying the policy id as the AuthenticationType

HttpContext.GetOwinContext().Authentication.Challenge(

new AuthenticationProperties () { RedirectUri = \&quot;/\&quot; }, Startup.SignInPolicyId);

}

}

public void SignUp()

{

if (!Request.IsAuthenticated)

{

HttpContext.GetOwinContext().Authentication.Challenge(

new AuthenticationProperties() { RedirectUri = \&quot;/\&quot; }, Startup.SignUpPolicyId);

}

}

public void Profile()

{

if (Request.IsAuthenticated)

{

HttpContext.GetOwinContext().Authentication.Challenge(

new AuthenticationProperties() { RedirectUri = \&quot;/\&quot; }, Startup.ProfilePolicyId);

}

}</code></pre></li>
<li><p>You can also use OWIN to sign out the user from the app. Add the following method to the account controller (<strong>Controllers\AccountController.cs</strong>):</p>
<pre><code>C\# Copy</code></pre>
<pre><code>// Controllers\\AccountController.cs

public void SignOut()

{

// To sign out the user, you should issue an OpenIDConnect sign out request

if (Request.IsAuthenticated)

{

IEnumerable\&lt;AuthenticationDescription\&gt; authTypes = HttpContext.GetOwinContext().Authentication.GetAuthenticationTypes();

HttpContext.GetOwinContext().Authentication.SignOut(authTypes.Select(t =\&gt; t.AuthenticationType).ToArray());

Request.GetOwinContext().Authentication.GetAuthenticationTypes();

}

}</code></pre></li>
</ol>
<h3 id="task-8-display-user-information">Task 8: Display user information</h3>
<p>When you authenticate users by using OpenID Connect, Azure AD returns an ID token to the app that contains <strong>claims</strong>. These are assertions about the user. You can use claims to personalize your app. You can access user claims in your controllers via the ClaimsPrincipal.Current security principal object.</p>
<ol type="1">
<li><p>Open the <strong>Controllers\HomeController.cs file</strong> and add the following using statements at the end of the other using statements.</p>
<pre><code>using System.Linq;

using System.Security.Claims;</code></pre></li>
<li><p>Open the <strong>Controllers\HomeController.cs</strong> file and add the following method:</p>
<pre><code>\[Authorize\]

public ActionResult Claims()

{

Claim displayName = ClaimsPrincipal.Current.FindFirst(ClaimsPrincipal.Current.Identities.First().NameClaimType);

ViewBag.DisplayName = displayName != null ? displayName.Value : string.Empty;

return View();

}</code></pre></li>
<li><p>You can access any claim that your application receives in the same way. A list of all the claims the app receives is available for you on the <strong>Claims</strong> page. Right click on <strong>Views -&gt; Home,</strong> click <strong>Add -&gt; MVC 5 View Page (Razor)</strong> and name it <strong>Claims.</strong> <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image180.png" title="Solution Explorer" alt="In Solution Explorer, on the right-click menu for Views\Home, Add is selected, and from its menu, MVC 5 View Page (Razor) is selected." /></p></li>
<li><p>Open the <strong>Claims.cshtml</strong> file and replace the code with the following:</p>
<pre><code>\@using System.Security.Claims

@{

ViewBag.Title = \&quot;Claims\&quot;;

}

\&lt;h2\&gt;\@ViewBag.Title\&lt;/h2\&gt;

\&lt;h4\&gt;Claims Present in the Claims Identity: \@ViewBag.DisplayName\&lt;/h4\&gt;

\&lt;table class=\&quot;table-hover claim-table\&quot;\&gt;

\&lt;tr\&gt;

\&lt;th class=\&quot;claim-type claim-data claim-head\&quot;\&gt;Claim Type\&lt;/th\&gt;

\&lt;th class=\&quot;claim-data claim-head\&quot;\&gt;Claim Value\&lt;/th\&gt;

\&lt;/tr\&gt;

\@foreach (Claim claim in ClaimsPrincipal.Current.Claims)

{

\&lt;tr\&gt;

\&lt;td class=\&quot;claim-type claim-data\&quot;\&gt;\@claim.Type\&lt;/td\&gt;

\&lt;td class=\&quot;claim-data\&quot;\&gt;\@claim.Value\&lt;/td\&gt;

\&lt;/tr\&gt;

}

\&lt;/table\&gt;</code></pre></li>
<li><p>Right click on the <strong>Views -&gt; Shared</strong> folder, click <strong>Add</strong>, and add a new <strong>MVC 5 Partial Page (Razor)</strong>. Specify <strong>_LoginPartial</strong> for the name.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image181.png" title="Solution Explorer" alt="In Solution Explorer, on the right-click menu for Views\Shared, Add is selected, and from its menu, MVC 5 Partial Page (Razor) is selected." /><figcaption>In Solution Explorer, on the right-click menu for Views\Shared, Add is selected, and from its menu, MVC 5 Partial Page (Razor) is selected.</figcaption>
</figure></li>
<li><p>Add the following code to the razor partial view to provide a sign-in and sign-out link as well as a link to edit the user’s profile.</p>
<pre><code>\@if (Request.IsAuthenticated)

{

\&lt;text\&gt;

\&lt;ul class=\&quot;nav navbar-nav navbar-right\&quot;\&gt;

\&lt;li\&gt;

\&lt;a id=\&quot;profile-link\&quot;\&gt;\@User.Identity.Name\&lt;/a\&gt;

\&lt;div id=\&quot;profile-options\&quot; class=\&quot;nav navbar-nav navbar-right\&quot;\&gt;

\&lt;ul class=\&quot;profile-links\&quot;\&gt;

\&lt;li class=\&quot;profile-link\&quot;\&gt;

\@Html.ActionLink(\&quot;Edit Profile\&quot;, \&quot;Profile\&quot;, \&quot;Account\&quot;)

\&lt;/li\&gt;

\&lt;/ul\&gt;

\&lt;/div\&gt;

\&lt;/li\&gt;

\&lt;li\&gt;

\@Html.ActionLink(\&quot;Sign out\&quot;, \&quot;SignOut\&quot;, \&quot;Account\&quot;)

\&lt;/li\&gt;

\&lt;/ul\&gt;

\&lt;/text\&gt;

}

else

{

\&lt;ul class=\&quot;nav navbar-nav navbar-right\&quot;\&gt;

\&lt;li\&gt;\@Html.ActionLink(\&quot;Sign up\&quot;, \&quot;SignUp\&quot;, \&quot;Account\&quot;, routeValues: null, htmlAttributes: new { id = \&quot;signUpLink\&quot; })\&lt;/li\&gt;

\&lt;li\&gt;\@Html.ActionLink(\&quot;Sign in\&quot;, \&quot;SignIn\&quot;, \&quot;Account\&quot;, routeValues: null, htmlAttributes: new { id = \&quot;loginLink\&quot; })\&lt;/li\&gt;

\&lt;/ul\&gt;

}</code></pre></li>
<li><p>Open Views\Shared\_Layout.cshtml in Visual Studio. Locate the header-top div. and add the two lines highlighted.</p>
<pre><code>\&lt;div class=\&quot;header-top\&quot;\&gt;

\&lt;div class=\&quot;container\&quot;\&gt;

\&lt;div class=\&quot;row\&quot;\&gt;

\&lt;div class=\&quot;header-top-left\&quot;\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-twitter\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-facebook\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-linkedin\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;a href=\&quot;\#\&quot;\&gt;\&lt;i class=\&quot;fa fa-instagram\&quot;\&gt;\&lt;/i\&gt;\&lt;/a\&gt;

\&lt;/div\&gt;

\&lt;div class=\&quot;header-top-right\&quot;\&gt;

\&lt;a href=\&quot;\#\&quot; class=\&quot;top-wrap\&quot;\&gt;\&lt;span class=\&quot;icon-phone\&quot;\&gt;Call today: \&lt;/span\&gt; (555) 555-8000\&lt;/a\&gt;

\@Html.ActionLink(\&quot;Claims\&quot;, \&quot;Claims\&quot;, \&quot;Home\&quot;)

\&lt;/div\&gt;

\@Html.Partial(\&quot;\_LoginPartial\&quot;)

\&lt;/div\&gt;

\&lt;/div\&gt;

\&lt;/div\&gt;</code></pre></li>
</ol>
<h3 id="task-9-run-the-sample-app">Task 9: Run the sample app</h3>
<ol type="1">
<li>Right click on the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and click <strong>Publish</strong>. Follow the steps to deploy the updated application to the Microsoft Azure Web App.</li>
</ol>
<p>Launch a browser outside of Visual Studio for testing if the page loads in Visual Studio.</p>
<ol start="2" type="1">
<li><p>Test out Sign up. Next, test Sign out.</p></li>
<li><p>When you click on Claims and are not signed in, it will bring you to the sign-in page and then display the claim information. Sign in, and test Edit Profile.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image182.png" title="Contoso website" alt="On the Contoso website, the following links are circled: Claims, Sign up, and Sign in." /><figcaption>On the Contoso website, the following links are circled: Claims, Sign up, and Sign in.</figcaption>
</figure>
<p>Claims information page<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image183.png" title="Contoso website, Claims information page" alt="On the Contoso website, the following links are circled: Russell, Sign out, and Edit Profile." /></p></li>
</ol>
<h2 id="exercise-4-enabling-telemetry-with-application-insights">Exercise 4: Enabling Telemetry with Application Insights</h2>
<p>To configure the application for logging and diagnostics, you have been asked to configure Microsoft Azure Application Insights and add some custom telemetry.</p>
<p>Note: You may need to create an Application Insights Resource in Azure portal depending on your subscription rights. After it is created, you can configure it and add to the project using the tasks below. To create a new Application Insights resource.</p>
<ol type="1">
<li><p>Click <strong>Create</strong> a resource. <strong>Search</strong> the marketplace for Application Insights. <strong>Select</strong> Application Insights.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image184.png" title="Screenshot of creating a resource" alt="In this screenshot a new application insights instance is created using the Azure portal." /><figcaption>In this screenshot a new application insights instance is created using the Azure portal.</figcaption>
</figure></li>
<li><p>Click the <strong>Create</strong> button.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image185.png" title="Application insights resource" alt="A screenshot that provides an overview of Application Insights and a button to click Create." /><figcaption>A screenshot that provides an overview of Application Insights and a button to click Create.</figcaption>
</figure></li>
<li><p>Enter the name as <strong>Contoso.Apps.SportsLeague.Web.</strong> Choose the existing resource group of <strong>contoso</strong>. Location should be the same location as your resource group.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image186.png" title="Application insights creation dialog" alt="A dialog that shows the properties of the application insights resource" /><figcaption>A dialog that shows the properties of the application insights resource</figcaption>
</figure></li>
</ol>
<h3 id="task-1-configure-the-application-for-telemetry">Task 1: Configure the application for telemetry</h3>
<h4 id="subtask-1-add-application-insights-telemetry-to-the-e-commerce-website-project">Subtask 1: Add Application Insights Telemetry to the e-commerce website project</h4>
<ol type="1">
<li><p>Open the Solution <strong>Contoso.Apps.SportsLeague</strong> in Visual Studio.</p></li>
<li><p>Navigate to the <strong>Contoso.Apps.SportsLeague.Web</strong> project located in the <strong>Web</strong> folder using the <strong>Solution Explorer</strong> in Visual Studio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image187.png" title="Solution Explorer" alt="In Solution Explorer, the Web folder is expanded, and Contoso.Apps.SportsLeague.Web is selected." /><figcaption>In Solution Explorer, the Web folder is expanded, and Contoso.Apps.SportsLeague.Web is selected.</figcaption>
</figure></li>
<li><p>Right-click the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and select <strong>Add | Application Insights Telemetry..</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image188.png" title="Solution Explorer" alt="In Solution Explorer, on the Web folder&#39;s right-click menu, Add is selected, and from its menu, Application Insight Telemetry is selected." /></p></li>
<li><p>Expand the <strong>Sending telemetry to</strong> section.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image189.png" title="Application Insights tab" alt="On the Application Insights tab, under Resource Settings, the expand arrow is circled for the Sending telemetry to section." /></p></li>
<li><p>Click on the <strong>Configure settings…</strong> button.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image190.png" title="Sending telemetry to section" alt="In the Sending telemetry to section, the link to Configure settings is circled." /><figcaption>In the Sending telemetry to section, the link to Configure settings is circled.</figcaption>
</figure></li>
<li><p>In the <strong>Application Insights Configuration</strong> dialog box, change the <strong>Resource Group</strong> to the <strong>contososports</strong> resource group used to host the Web App, and choose the New Application Insights Resource. Next, click <strong>OK</strong>, followed by <strong>Update Resource</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image191.png" title="Application Insights Configuration dialog box" alt="In the Application Insights Configuration dialog box, the Resource Group contososports is selected. In the Application Insights Resource drop-down list box, Contoso.Apps.SportsLeague.Web is selected." /><figcaption>In the Application Insights Configuration dialog box, the Resource Group contososports is selected. In the Application Insights Resource drop-down list box, Contoso.Apps.SportsLeague.Web is selected.</figcaption>
</figure></li>
<li><p>Press <strong>Finish</strong> on the Application Insights window.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image192.png" title="Application Insights window" alt="The Finish button is circled in the Application Insights window." /></p></li>
<li><p>Once it completes, it displays the following Output and opens a new browser window</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image193.png" title="Output" alt="Screenshot of Output." /><figcaption>Screenshot of Output.</figcaption>
</figure></li>
<li><p>Open the file <strong>\Helpers\TelemetryHelper.cs</strong> located in the <strong>Contoso.Apps.SportsLeague.Web</strong> project.</p></li>
<li><p>Add the following using statement to the top of the file:</p>
<pre><code>using Microsoft.ApplicationInsights;</code></pre></li>
<li><p>Add the following code to the <strong>TrackException</strong> method to instantiate the telemetry client and track exceptions.</p>
<pre><code>var client = new TelemetryClient();

client.TrackException(new Microsoft.ApplicationInsights.DataContracts.ExceptionTelemetry(exc));</code></pre></li>
<li><p>Add the following code to the <strong>TrackEvent</strong> method to instantiate the telemetry client and track event data.</p>
<pre><code>var client = new TelemetryClient();

client.TrackEvent(eventName, properties);</code></pre></li>
<li><p>Save the <strong>TelemetryHelper.cs</strong> file.</p></li>
</ol>
<h4 id="subtask-2-enable-client-side-telemetry">Subtask 2: Enable client side telemetry</h4>
<ol type="1">
<li><p>Open the Azure Management Portal (<a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>). Click <strong>More services</strong> followed by <strong>Application Insights</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image194.png" title="Azure Portal" alt="On the left of the Azure Portal, More services is selected. On the right, under Monitoring and Management, Application Insights is selected." /><figcaption>On the left of the Azure Portal, More services is selected. On the right, under Monitoring and Management, Application Insights is selected.</figcaption>
</figure></li>
<li><p>Click the Application Insights instance associated with the Contoso E-Commerce Site.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image195.png" title="Name section" alt="Under Name, Contoso.Apps.SportsLeague.Web displays." /><figcaption>Under Name, Contoso.Apps.SportsLeague.Web displays.</figcaption>
</figure></li>
<li><p>In CONFIGURE menu click on <strong>Getting Started</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image196.png" title="Configure menu" alt="From the Configure menu, Getting started is selected." /><figcaption>From the Configure menu, Getting started is selected.</figcaption>
</figure></li>
<li><p>Next, click the <strong>MONITOR AND DIAGNOSE CLIENT SIDE APPLICATION</strong> arrow. This will open the <strong>Client application monitoring and diagnosis</strong> blade.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image197.png" title="MONITOR AND DIAGNOSE CLIENT SIDE APPLICATION" alt="Screenshot of the MONITOR AND DIAGNOSE CLIENT SIDE APPLICATION arrow." /></p></li>
<li><p>Select and copy the full contents of the JavaScript on the <strong>Client application monitoring and diagnosis</strong> blade.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image198.png" title="Client application monitoring and diagnosis blade" alt="Under Guidance in the Client application monitoring and diagnosis blade, JavaScript displays." /><figcaption>Under Guidance in the Client application monitoring and diagnosis blade, JavaScript displays.</figcaption>
</figure></li>
<li><p>Navigate to the <strong>Contoso.Apps.SportsLeague.Web</strong> project located in the <strong>Web</strong> folder using the <strong>Solution Explorer</strong> in Visual Studio.</p></li>
<li><p>Open <strong>Views &gt; Shared &gt; _Layout.cshtml</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image199.png" title="Solution Explorer" alt="In Solution Explorer, under Views\Shared, Layout.cshtml is selected." /><figcaption>In Solution Explorer, under Views\Shared, Layout.cshtml is selected.</figcaption>
</figure></li>
<li><p>Paste in the code before the <strong>&lt;/head&gt;</strong> tag.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image200.png" title="Layout.cshtml tab" alt="In Layout.cshtml, code displays, and several lines are selected." /><figcaption>In Layout.cshtml, code displays, and several lines are selected.</figcaption>
</figure></li>
<li><p>Save the <strong>_Layout.cshtml</strong> file.</p></li>
</ol>
<h4 id="subtask-3-deploy-the-e-commerce-web-app-from-visual-studio">Subtask 3: Deploy the e-commerce Web App from Visual Studio</h4>
<ol type="1">
<li><p>Navigate to the <strong>Contoso.Apps.SportsLeague.Web</strong> project located in the <strong>Web</strong> folder using the <strong>Solution Explorer</strong> in Visual Studio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image201.png" title="Solution Explorer" alt="In Solution Explorer, under the Web folder, Contoso.Apps.SportsLeague.Web is selected." /><figcaption>In Solution Explorer, under the Web folder, Contoso.Apps.SportsLeague.Web is selected.</figcaption>
</figure></li>
<li><p>Right-click the <strong>Contoso.Apps.SportsLeague.Web</strong> project, and select <strong>Publish</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image202.png" title="Solution Explorer" alt="From the Contoso.Apps.SportsLeague.Web right-click menu, Publish is selected." /></p></li>
<li><p>Click <strong>Publish</strong> again when the Publish dialog appears.</p></li>
</ol>
<p>Launch a browser <strong>outside of Visual Studio</strong> for testing if the page is loaded in Visual Studio.</p>
<ol start="4" type="1">
<li>Click a few links on the published E-Commerce website, and submit several orders to generate some sample telemetry.</li>
</ol>
<h3 id="task-2-creating-the-web-performance-test-and-load-test">Task 2: Creating the web performance test and load test</h3>
<h4 id="subtask-1-create-the-load-test">Subtask 1: Create the load test</h4>
<ol type="1">
<li><p>Open the Azure Management Portal (<a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>). Click <strong>More services</strong> followed by <strong>Application Insights</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image203.png" title="Azure Portal" alt="On the left side of the Azure Portal, More services is selected. On the right side, under Developer Tools, Application Insights is selected." /><figcaption>On the left side of the Azure Portal, More services is selected. On the right side, under Developer Tools, Application Insights is selected.</figcaption>
</figure></li>
<li><p>Click the Application Insights instance associated with the Contoso E-Commerce Site.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image204.png" title="Name section" alt="In the Name section, Contoso.Apps.SportsLeague.Web is selected." /><figcaption>In the Name section, Contoso.Apps.SportsLeague.Web is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Performance Testing</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image205.png" title="Configure menu" alt="On the Configure menu, Performance Testing is selected." /><figcaption>On the Configure menu, Performance Testing is selected.</figcaption>
</figure></li>
<li><p>Click the Set Account button to associate/create a Visual Studio Team Services account.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image206.png" title="Application Insights blade" alt="On the Application Insights blade, Set Account is selected." /><figcaption>On the Application Insights blade, Set Account is selected.</figcaption>
</figure></li>
<li><p>On the Account tile, click <strong>Or Create New</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image207.png" title="Account tile" alt="On the Account tile, the Or Create New link is circled." /><figcaption>On the Account tile, the Or Create New link is circled.</figcaption>
</figure></li>
<li><p>Specify a unique name for the account and select a region. Note the region may differ from the region you have deployed your resources.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image208.png" title="Account Settings blade" alt="On the Account Settings blade, under Team Services Account, ContosoSportsTesting04 is selected." /><figcaption>On the Account Settings blade, under Team Services Account, ContosoSportsTesting04 is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Subscription</strong>, and select <strong>your Subscription</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image209.png" title="Subscription option" alt="The Subscription option displays." /></p></li>
<li><p>Click <strong>Select location</strong>. Next, select a Location.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image210.png" title="Select location option" alt="The Select location option displays." /></p></li>
<li><p>Then, click <strong>OK</strong>.</p></li>
</ol>
<p>The VSTS account creation will take a minute to complete.</p>
<ol start="10" type="1">
<li><p>Click <strong>New</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image211.png" title="Application Insights blade" alt="On the Application Insights blade, the New button is circled." /><figcaption>On the Application Insights blade, the New button is circled.</figcaption>
</figure></li>
<li><p>Click on <strong>Configure Test Using</strong>. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image212.png" title="Configure Test Using option" alt="The Configure Test Using option displays." /></p></li>
<li><p>Specify the <strong>URL</strong> to the Contoso E-Commerce site, and click <strong>Done</strong><br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image213.png" title="Configure test using" alt="In the Configure test using blade, the https://contososportsweb3.azurewebsites URL is selected." /></p></li>
<li><p>Name the test <strong>ContosoSportsTest</strong>, and click the <strong>Run test</strong> button. <img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image214.png" title="New performance test blade" alt="On the New performance test blade, under Name, ContosoSportsTest is selected. At the bottom, the Run test button is selected." /></p></li>
<li><p>Wait until the load test has completed.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image215.png" title="Recent runs section" alt="In the Recent runs section, the load test for ContosoSportsTest has a state of Completed." /><figcaption>In the Recent runs section, the load test for ContosoSportsTest has a state of Completed.</figcaption>
</figure></li>
</ol>
<h4 id="subtask-2-view-the-application-insights-logs">Subtask 2: View the Application Insights logs</h4>
<ol type="1">
<li><p>Using a new tab or instance of your browser, navigate to the Azure Management portal <a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>.</p></li>
<li><p>On the left menu area, click <strong>More services</strong>.</p></li>
<li><p>On the <strong>More services</strong> blade, select <strong>Application Insights</strong>.</p></li>
<li><p>On the <strong>Application Insights</strong> blade, select the Application Insights configuration you created for the e-commerce website.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image216.png" title="Application Insights configuration option" alt="The Application Insights configuration option Contoso.Apps.SportsLeague.Web is selected." /><figcaption>The Application Insights configuration option Contoso.Apps.SportsLeague.Web is selected.</figcaption>
</figure></li>
<li><p>View the performance timeline to see the overall number of requests and page load time.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image217.png" title="Health graph" alt="The Health graph displays the performance overview timeline of overall requests and response times." /><figcaption>The Health graph displays the performance overview timeline of overall requests and response times.</figcaption>
</figure></li>
<li><p>Under <strong>Usage Preview</strong>. Check out the Events Button.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image218.png" title="The Usage Preview section" alt="A screenshot using the Events button under the Usage Preview section" /><figcaption>A screenshot using the Events button under the Usage Preview section</figcaption>
</figure></li>
<li><p>After several minutes, you should see several Custom events from your previous order testing. This is reported through the TelemetryClient’s TrackEvent method.</p></li>
</ol>
<p>Note: If you do not see data here, come back later after the lab is complete.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image219.png" title="Custom events section" alt="In the Custom events section, OrderCompleted is 3, and SuccessfulPaymentAuth is 3." /><figcaption>In the Custom events section, OrderCompleted is 3, and SuccessfulPaymentAuth is 3.</figcaption>
</figure>
<ol start="8" type="1">
<li><p>Drilling into the OrderCompleted events provides you with more detail about the specific order.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image220.png" title="OrderCompleted blade" alt="Screenshot of the OrderCompleted blade." /><figcaption>Screenshot of the OrderCompleted blade.</figcaption>
</figure></li>
</ol>
<h2 id="exercise-5-automating-backend-processes-with-azure-functions-and-logic-apps">Exercise 5: Automating backend processes with Azure Functions and Logic Apps</h2>
<p>Contoso wants to automate the process of generating receipts in PDF format and alerting users when their orders have been processed using Azure Logic App and Functions. To run custom snippets of C# or node.js in logic apps, you can create custom functions through Azure Functions. <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-overview">Azure Functions</a> offers server-free computing in Microsoft Azure and are useful for performing these tasks:</p>
<ul>
<li><p>Advanced formatting or compute of fields in logic apps</p></li>
<li><p>Perform calculations in a workflow.</p></li>
<li><p>Extend the logic app functionality with functions that are supported in C# or node.js</p></li>
</ul>
<h3 id="task-1-create-an-azure-function-to-generate-pdf-receipts">Task 1: Create an Azure Function to Generate PDF Receipts</h3>
<ol type="1">
<li><p>Click the New button found on the upper left-hand corner of the Azure portal and then click <strong>Compute &gt; Function App</strong>, select your Subscription, type a unique App name that identifies your function app, then specify the following settings:</p>
<ul>
<li><p><a href="https://docs.microsoft.com/en-us/azure/azure-resource-manager/resource-group-overview"><strong>Resource Group</strong></a>: Use the existing resource group for <strong>contososports</strong>.</p></li>
<li><p><a href="https://docs.microsoft.com/en-us/azure/app-service/azure-web-sites-web-hosting-plans-in-depth-overview"><strong>Hosting plan</strong></a>, which can be one of these plans:</p>
<ul>
<li><p><strong>Consumption plan</strong>: The default plan type for Azure Functions. When you choose a consumption plan, you must also choose the <strong>Location</strong>.</p></li>
<li><p><strong>App Service plan</strong>: An App Service plan requires you to create an <strong>App Service plan/location</strong> or select an existing one. These settings determine the <a href="https://azure.microsoft.com/pricing/details/app-service/">location, features, cost, and compute resources</a> associated with your app.</p></li>
</ul></li>
<li><p><strong>Storage account</strong>: Each function app requires a storage account. Choose the existing storage account by clicking Select Existing and choosing the storage account in the contososports resource group.</p></li>
</ul>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image221.png" title="Azure Portal" alt="On the left side of the OrderCompleted blade, the New button is selected. In the middle, under New, Compute is selected. On the right, under Compute, Function App is selected." /><figcaption>On the left side of the OrderCompleted blade, the New button is selected. In the middle, under New, Compute is selected. On the right, under Compute, Function App is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Create</strong> to provision and deploy the new function app.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image222.png" title="Function App section" alt="Under Function App, the App name field is set to ContosoFunctionApp, and at the bottom the Create button is selected." /><figcaption>Under Function App, the App name field is set to ContosoFunctionApp, and at the bottom the Create button is selected.</figcaption>
</figure></li>
<li><p>Open the Function App you just created. Click the <strong>+ beside Functions</strong>, scroll down, and select <strong>Custom function</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image223.png" title="Function Apps" alt="In Function Apps, on the left side Function is selected. On the right, at the bottom, the Custom function link is selected." /><figcaption>In Function Apps, on the left side Function is selected. On the right, at the bottom, the Custom function link is selected.</figcaption>
</figure></li>
<li><p>Select <strong>GenericWebHook</strong>-<strong>CSharp</strong> with a Name of <strong>ContosoMakePDF</strong>, and press <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image224.png" title="Azure Portal" alt="In the Azure Portal, under Choose a template below, the GenericWebHook-CSharp tile is selected. Below, the Name your function field is ContosoMakePDF, and the Create button is selected." /><figcaption>In the Azure Portal, under Choose a template below, the GenericWebHook-CSharp tile is selected. Below, the Name your function field is ContosoMakePDF, and the Create button is selected.</figcaption>
</figure></li>
<li><p>Expand the View files area on the right of the code window and then click <strong>Upload</strong>.</p>
<p><img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image225.png" title="View files expand arrow" alt="Screenshot of the View files expand arrow." /><img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image226.png" title="Upload button" alt="Screenshot of the Upload button." /></p></li>
<li><p>Upload the following files in the (Contoso Sports League\Contoso.CreatePDFReport) folder beneath: C:\Hackathon.</p>
<ul>
<li><p>ViewModels.csx</p></li>
<li><p>CreatePdfReport.csx</p></li>
<li><p>run.csx</p></li>
<li><p>sample.dat</p></li>
<li><p>StorageMethods.csx</p></li>
<li><p>Project.json</p></li>
</ul>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image227.png" title="Files" alt="The previously mentioned files display." /><figcaption>The previously mentioned files display.</figcaption>
</figure></li>
<li><p>Click on run.csx, to refresh the code editor.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image228.png" title="Code Editor" alt="In the Code Editor, on the right, run.csx is selected." /><figcaption>In the Code Editor, on the right, run.csx is selected.</figcaption>
</figure></li>
<li><p>Open the Log windows on the bottom.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image229.png" title="Logs window" alt="The Expand button on the Logs window menu bar is selected." /><figcaption>The Expand button on the Logs window menu bar is selected.</figcaption>
</figure></li>
</ol>
<p>Note: You should see several messages about downloading dependent assemblies such as the Azure SDK and iText Sharp that were defined in the project.json file.</p>
<ol start="9" type="1">
<li><p>Select the name of your function app, and then click on <strong>Platform Features</strong> followed by <strong>Application settings.</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image230.png" title="Azure Portal" alt="In the Azure Portal, under Function Apps, ContosoFunctionApp is selected. Under General Settings, Application settings is selected. The Platform Features link is selected." /><figcaption>In the Azure Portal, under Function Apps, ContosoFunctionApp is selected. Under General Settings, Application settings is selected. The Platform Features link is selected.</figcaption>
</figure></li>
<li><p>Add a new entry called <strong>contososportsstorage</strong>, and paste the value of the connection string noted in an earlier exercise. Click <strong>Save</strong> after adding the value.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image231.png" title="App settings section" alt="In teh App settings section, contososportsstorage is selected." /><figcaption>In teh App settings section, contososportsstorage is selected.</figcaption>
</figure></li>
</ol>
<p>Note: You can find the value by opening the storage account, and clicking the Access Keys tile.</p>
<ol start="11" type="1">
<li><p>Open the <strong>sample.dat</strong> file, and select as well as copy (Ctrl+C) the test data.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image232.png" title="Sample.dat file" alt="The Sample.dat file displays." /><figcaption>The Sample.dat file displays.</figcaption>
</figure></li>
<li><p>Select the <strong>Run.csx</strong> file, click on the <strong>Test</strong> tab, and replace the contents by pasting (CTRL-V) in the Test tab Request Body.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image233.png" title="Run.csx file, Test tab request body" alt="Screenshot of the run.csx file, and the Test tab request body." /><figcaption>Screenshot of the run.csx file, and the Test tab request body.</figcaption>
</figure></li>
<li><p>Select the <strong>View Files</strong> tab, select <strong>Run.csx</strong>, and click run.</p></li>
<li><p>You should see messages in the Logs window stating the Webhook was triggered, and the PDF was generated / saving it the storage account. Also, you should see that actual message text in the Output Window.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image234.png" title="Run.csx file, Test tab request body" alt="In the run.csx file, under Logs, messages stating the Webhook was triggered and the PDF was generated are circled. In the Test tab request body, under Output, the message text is circled." /><figcaption>In the run.csx file, under Logs, messages stating the Webhook was triggered and the PDF was generated are circled. In the Test tab request body, under Output, the message text is circled.</figcaption>
</figure></li>
<li><p>To see the PDF indeed landed in the receipts container in blob storage, download the Microsoft Storage Explorer at <a href="http://storageexplorer.com/">http://storageexplorer.com</a>. Use Microsoft Storage explorer to verify the PDF landed on the Blob Container for receipts. You may need to refresh and/or select another folder, and arrive back to the receipts folder to see the PDF.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image235.png" title="Storage Explorer" alt="In Storage Explorer, on the left, the following path is expanded: Storage Accounts\contososportsstorage01\Blub containers. Under Blob Containers, receipts is circled. On the right, on the receipts tab, ContosoSportsLeague-Store-Receipts-38.pdf is circled." /><figcaption>In Storage Explorer, on the left, the following path is expanded: Storage Accounts\contososportsstorage01\Blub containers. Under Blob Containers, receipts is circled. On the right, on the receipts tab, ContosoSportsLeague-Store-Receipts-38.pdf is circled.</figcaption>
</figure></li>
</ol>
<h3 id="task-2-create-an-azure-logic-app-to-process-orders">Task 2: Create an Azure Logic App to Process Orders</h3>
<p>Without writing any code, you can automate business processes more easily and quickly when you create and run workflows with Azure Logic Apps. Logic Apps provide a way to simplify and implement scalable integrations and workflows in the cloud. It provides a visual designer to model and automate your process as a series of steps known as a workflow. There are <a href="https://docs.microsoft.com/en-us/azure/connectors/apis-list">many connectors</a> across the cloud and on-premises to quickly integrate across services and protocols.</p>
<p>The advantages of using Logic Apps include the following:</p>
<ul>
<li><p>Saving time by designing complex processes using easy to understand design tools</p></li>
<li><p>Implementing patterns and workflows seamlessly, that would otherwise be difficult to implement in code</p></li>
<li><p>Getting started quickly from templates</p></li>
<li><p>Customizing your logic app with your own custom APIs, code, and actions</p></li>
<li><p>Connect and synchronize disparate systems across on-premises and the cloud</p></li>
<li><p>Build off of BizTalk server, API Management, Azure Functions, and Azure Service Bus with first-class integration support</p></li>
</ul>
<ol type="1">
<li><p>Next, let us create a Logic App that will trigger when an item is added to the receiptgenerator queue. In the Azure Management Portal, click the <strong>+</strong> button<strong>,</strong> search for <strong>Logic App</strong>, click the returned Logic App result, and click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image236.png" title="Azure Portal" alt="In the Azure Portal, under Marketplace, Everything is selected. Under Everything, Logic App is in the search field. Under Name, Logic App is circled." /><figcaption>In the Azure Portal, under Marketplace, Everything is selected. Under Everything, Logic App is in the search field. Under Name, Logic App is circled.</figcaption>
</figure></li>
<li><p>Fill out the name as <strong>ContosoLogicApplication</strong> along with your subscription, and use the existing resource group <strong>contososports</strong>. Choose the <strong>same region</strong> as your Web App and storage account. Click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image237.png" title="Create logic app blade" alt="In the Create logic app blade, ContosoLogicApplication is in the Name field. Under Resource group, the Use existing radio button is selected, and contososports is the name." /><figcaption>In the Create logic app blade, ContosoLogicApplication is in the Name field. Under Resource group, the Use existing radio button is selected, and contososports is the name.</figcaption>
</figure></li>
<li><p>Open up the logic app after it is deployed by clicking more services and search on logic.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image238.png" title="Azure Portal" alt="In the Azure Portal, logic is in the search field, and under that, Logic apps is selected." /><figcaption>In the Azure Portal, logic is in the search field, and under that, Logic apps is selected.</figcaption>
</figure></li>
<li><p>Click on the <strong>Logic App Designer</strong> link.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image239.png" title="Logic app blade" alt="In the Logic app blade, under Development tools, Logic App Designer is selected." /><figcaption>In the Logic app blade, under Development tools, Logic App Designer is selected.</figcaption>
</figure></li>
<li><p>In the Logic Apps Designer, select <strong>Blank Logic App</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image240.png" title="Logic Apps Designer" alt="In the Logic Apps Designer, the Blank Logic App tile is selected." /><figcaption>In the Logic Apps Designer, the Blank Logic App tile is selected.</figcaption>
</figure></li>
<li><p>Select <strong>Azure Queues.</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image241.png" title="Services section" alt="In the Services section, the Azure Queues tile is selected." /><figcaption>In the Services section, the Azure Queues tile is selected.</figcaption>
</figure></li>
<li><p>Select <strong>Azure Queues – When there are messages in a queue</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image242.png" title="Search all triggers section" alt="In the Search all triggers section, Azure Queues - When there are messages in a queue is selected." /><figcaption>In the Search all triggers section, Azure Queues - When there are messages in a queue is selected.</figcaption>
</figure></li>
<li><p>Specify <strong>ContosoStorage</strong> as the connection name, select the Contoso storage account from the list, and click <strong>Create</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image243.png" title="When there are messages in a queue" alt="In When there are messages in a queue, the Connection Name is ContosoStorage, and under Storage Account, contosostorage123321 is selected." /><figcaption>In When there are messages in a queue, the Connection Name is ContosoStorage, and under Storage Account, contosostorage123321 is selected.</figcaption>
</figure></li>
<li><p>Select the <strong>receiptgenerator</strong> queue from the drop-down, click <strong>New Step</strong>, and <strong>Add an Action</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image244.png" title="Queue name" alt="Under When there are messages in a queue, the Queue name is set to receiptgenerator. At the bottom, the New Step and Add in action buttons are selected." /><figcaption>Under When there are messages in a queue, the Queue name is set to receiptgenerator. At the bottom, the New Step and Add in action buttons are selected.</figcaption>
</figure></li>
<li><p>Select <strong>Azure Functions</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image245.png" title="Choose an action" alt="In the Choose an action section, under Services ,the Azure Functions tile is selected." /><figcaption>In the Choose an action section, under Services ,the Azure Functions tile is selected.</figcaption>
</figure></li>
<li><p>Click <strong>Azure Functions – Choose an Azure function</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image246.png" title="Azure Functions" alt="Under Azure Functions, on the Actions tab, Azure Functions - Choose an Azure function is selected." /><figcaption>Under Azure Functions, on the Actions tab, Azure Functions - Choose an Azure function is selected.</figcaption>
</figure></li>
<li><p>Select the Azure function created earlier followed by selecting the <strong>ContosoMakePDF</strong> function.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image247.png" title="Azure Functions" alt="Under Under Azure Functions, under Actions, Azure Functions - ContosoMakePDF is selected." /><figcaption>Under Under Azure Functions, under Actions, Azure Functions - ContosoMakePDF is selected.</figcaption>
</figure></li>
<li><p>Type this in the Request Body <strong>{“Order”:</strong> [pick MessageText from list on right] <strong>}</strong>. Make sure the syntax is json format. Sometimes the “:” will go to the right side of MessageText by mistake. Keep it on the left. It should look like this:</p>
<p><img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image248.png" title="ContosoMakePDF" alt="Under ContosoMakePDF, the previous JSON code is typed in the Request Body." /><br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image249.png" title="ContosoMakePDF" alt="Under ContosoMakePDF, the previous JSON code is typed in the Request Body, and below this, in Insert parameters from previous steps, Message text is selected." /></p></li>
<li><p>Click <strong>Save</strong> to save the Logic App.</p></li>
<li><p>There is one modification we need to make in the code. Click on the CodeView button.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image250.png" title="Logic App" alt="In the Logic App, the CodeView button is selected from the top menu." /><figcaption>In the Logic App, the CodeView button is selected from the top menu.</figcaption>
</figure></li>
<li><p>Find the line of code in the body for the Order item that reads the MessageText value from the queue, and add the base64 function around it to ensure it encoded before passing it off to the Azure function. It should look like the following:</p>
<pre><code>\&quot;Order\&quot;: \&quot;@{base64(triggerBody()?\[\&#39;MessageText\&#39;\])}\&quot;</code></pre>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image251.png" title="Order item code" alt="In the Order item code, the following line of code is circled: &quot;Order&quot;: &quot;@{base64(triggerBody()?[&#39;MessageText&#39;])}&quot;" /><figcaption>In the Order item code, the following line of code is circled: &quot;Order&quot;: &quot;@{base64(triggerBody()?['MessageText'])}&quot;</figcaption>
</figure></li>
<li><p>Run the logic app. It should process the orders you have submitted previously to test PDF generation. Using Azure Storage Explorer or Visual Studio Cloud Explorer you can navigate to the storage account and open the receipts container to see the created PDFs.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image252.png" title="Azure Storage Explorer" alt="In Azure Storage Explorer, on the left, the following tree view is expanded: Storage Accounts\contososportsstorage01r\Blob Containers. Under Blob Containers, receipts is selected. On the right, the ContosoSportsLeague-Store-Receipt-72.pdf is selected." /><figcaption>In Azure Storage Explorer, on the left, the following tree view is expanded: Storage Accounts\contososportsstorage01r\Blob Containers. Under Blob Containers, receipts is selected. On the right, the ContosoSportsLeague-Store-Receipt-72.pdf is selected.</figcaption>
</figure></li>
<li><p>Double click it to see the Purchase receipt.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image253.png" title="Purchase Receipt" alt="A Purchase Receipt displays." /><figcaption>A Purchase Receipt displays.</figcaption>
</figure></li>
<li><p>Now, add two more steps to the flow for updating the database and removing the message from the queue after it has been processed. Switch back to the designer, click <strong>+ New Step</strong> and select <strong>Add an Action</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image254.png" title="Designer" alt="In Designer, the New Step link is circled. Under New step, the Add an action tile is circled." /><figcaption>In Designer, the New Step link is circled. Under New step, the Add an action tile is circled.</figcaption>
</figure></li>
<li><p>Select <strong>SQL Server</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image255.png" title="Services section" alt="In the Services section, under Services, SQL Server is selected." /><figcaption>In the Services section, under Services, SQL Server is selected.</figcaption>
</figure></li>
<li><p>Select <strong>SQL Server - Update row</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image256.png" title="SQL Server section" alt="In the SQL Server section, on the Actions tab, SQL Server - Update row is selected." /><figcaption>In the SQL Server section, on the Actions tab, SQL Server - Update row is selected.</figcaption>
</figure></li>
<li><p>Name the connection ContosoSportsDB, and select the primary ContosoSportsDB database for your solution. Under the user name and password used to create it, click <strong>Create.</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image257.png" title="Update row" alt="TheUpdate row section displays the previously defined settings." /><figcaption>TheUpdate row section displays the previously defined settings.</figcaption>
</figure></li>
<li><p>From the drop-down select the name of the table, <strong>Orders</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image258.png" title="Update row section" alt="In the Update row section, under Table name, Orders is selected." /><figcaption>In the Update row section, under Table name, Orders is selected.</figcaption>
</figure></li>
<li><p>Press <strong>save</strong> and ignore the error. Navigate to the code view.</p></li>
<li><p>Replace these lines:</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image259.png" title="Code view" alt="Screenshot of code to be replaced." /><figcaption>Screenshot of code to be replaced.</figcaption>
</figure>
<p>With these:</p>
<pre><code>\&quot;OrderDate\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;OrderDate\&#39;\]}\&quot;,

\&quot;FirstName\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;FirstName\&#39;\]}\&quot;,

\&quot;LastName\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;LastName\&#39;\]}\&quot;,

\&quot;Address\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Address\&#39;\]}\&quot;,

\&quot;City\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;City\&#39;\]}\&quot;,

\&quot;State\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;State\&#39;\]}\&quot;,

\&quot;PostalCode\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;PostalCode\&#39;\]}\&quot;,

\&quot;Country\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Country\&#39;\]}\&quot;,

\&quot;Phone\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Phone\&#39;\]}\&quot;,

\&quot;SMSOptIn\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;SMSOptIn\&#39;\]}\&quot;,

\&quot;SMSStatus\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;SMSStatus\&#39;\]}\&quot;,

\&quot;Email\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Email\&#39;\]}\&quot;,

\&quot;ReceiptUrl\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;ReceiptUrl\&#39;\]}\&quot;,

\&quot;Total\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;Total\&#39;\]}\&quot;,

\&quot;PaymentTransactionId\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;PaymentTransactionId\&#39;\]}\&quot;,

\&quot;HasBeenShipped\&quot;: \&quot;@{body(\&#39;ContosoMakePDF\&#39;)\[\&#39;HasBeenShipped\&#39;\]}\&quot;</code></pre></li>
<li><p>And modify the path variable to include the index key or OrderId to be as follows:</p>
<pre><code>\&quot;path\&quot;: \&quot;/datasets/default/tables/@{encodeURIComponent(encodeURIComponent(\&#39;\[dbo\].\[Orders\]\&#39;))}/items/@{encodeURIComponent(encodeURIComponent(body(\&#39;ContosoMakePDF\&#39;)\[\&#39;OrderId\&#39;\]))}\&quot;</code></pre>
<p>The code should now look as follows for the update_row method:</p></li>
</ol>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image260.png" title="Code" alt="Screenshot of replacement code." /><figcaption>Screenshot of replacement code.</figcaption>
</figure>
<ol start="27" type="1">
<li><p><strong>Save</strong> and return to the designer.</p></li>
<li><p>Your updated designer view should look like this:</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image261.png" title="Update row section" alt="The Update row section displays the purchase fields." /><figcaption>The Update row section displays the purchase fields.</figcaption>
</figure></li>
<li><p>Finally, let us add one more step to remove the message from the queue. Press <strong>+New Step</strong> and <strong>Add an Action</strong>. Type in Queue in the search box, and select Azure Queues – Delete message.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image262.png" title="Choose an action section" alt="In the Choose an action section, queue is typed in the search field. Under Services, Azure Queues is selected. On the Actions tab, Azure Queues - Delete message is selected." /><figcaption>In the Choose an action section, queue is typed in the search field. Under Services, Azure Queues is selected. On the Actions tab, Azure Queues - Delete message is selected.</figcaption>
</figure></li>
<li><p>Select the <strong>receiptgenerator</strong> queue from the list.</p></li>
<li><p>Select <strong>Message Id</strong> <strong>&gt;</strong> <strong>Pop Receipt</strong> from the list, and click <strong>Save</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image263.png" title="Update row section" alt="In the Update row section, on the left in the Delete message fields, Message ID and Pop receipt are selected. On the right, under When there are messages in a queue, Message ID and Pop receipt are selected." /><figcaption>In the Update row section, on the left in the Delete message fields, Message ID and Pop receipt are selected. On the right, under When there are messages in a queue, Message ID and Pop receipt are selected.</figcaption>
</figure></li>
<li><p>Click Run on the Logic App Desinger, and then run the Contoso sports Web App and check out an Item.</p></li>
<li><p>Run the admin website app, and select the last Details link in the list.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image264.png" title="Details link" alt="Screenshot of the Details link." /></p></li>
<li><p>You should now see a Download receipt link because the database has been updated.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image265.png" title="Order Details window" alt="In the Order Details window, the Download receipt link is circled." /><figcaption>In the Order Details window, the Download receipt link is circled.</figcaption>
</figure></li>
<li><p>Click on the Download receipt link to see the receipt.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image266.png" title="Receipt" alt="Screenshot of the Receipt." /><figcaption>Screenshot of the Receipt.</figcaption>
</figure></li>
<li><p>Return to the Logic app and you should see all green check marks for each step. If not, click the yellow status icon to find out details.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image267.png" title="Logic app" alt="In the Logic app, all steps have green checkmarks." /><figcaption>In the Logic app, all steps have green checkmarks.</figcaption>
</figure></li>
</ol>
<h3 id="task-3-use-twilio-to-send-sms-order-notifications">Task 3: Use Twilio to send SMS Order Notifications</h3>
<h4 id="subtask-1-configure-your-twilio-trial-account">Subtask 1: Configure your Twilio trial account</h4>
<ol type="1">
<li><p>If you do not have a Twilio account, sign up for one for free at the following URL:??<br />
<a href="https://www.twilio.com/try-twilio"><strong>https://www.twilio.com/try-twilio</strong></a>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image268.png" title="Twilio account Sign up webpage" alt="Screenshot of the Twilio account Sign up for free webpage." /><figcaption>Screenshot of the Twilio account Sign up for free webpage.</figcaption>
</figure></li>
<li><p>When you sign up for a free Twilio trial, you will be asked to verify your personal phone number. This is an important security step that is mandatory for trying Twilio.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image269.png" title="Verification prompt" alt="On the Verification prompt, the &quot;We need to verify you&#39;re a human&quot; message displays. Under that is a phone number field, and a Verify via SMS button." /><figcaption>On the Verification prompt, the &quot;We need to verify you're a human&quot; message displays. Under that is a phone number field, and a Verify via SMS button.</figcaption>
</figure></li>
<li><p>Click <strong>All Products &amp; Services</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image270.png" title="Console" alt="In the Console, under Home, the All Products and Services (ellipses) button is selected." /></p></li>
<li><p>Click on <strong>Phone Numbers</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image271.png" title="Console" alt="On the Console, under Numbers, Phone Numbers is selected." /></p></li>
<li><p>Click <strong>Get Started</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image272.png" title="Console" alt="On the Console, under Phone Nunbers, the Get Started button is selected." /></p></li>
<li><p>Click the <strong>Get your first Twilio phone number</strong> button.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image273.png" title="Get Started with Phone Numbers prompt" alt="On the Get Started with Phone Numbers prompt, the Get your first Twilio phone number button displays." /></p></li>
<li><p>Record the <strong>Phone Number</strong>, click the <strong>Choose this Number</strong> button on the <strong>Your first Twilio Phone Number</strong> prompt, and click <strong>Done.</strong><br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image274.png" title="Your first Twilio Phone Number prompt" alt="On the Your first Twilio Phone Number prompt, the number is obscured." /></p></li>
<li><p>Click on <strong>Home</strong>, record the <strong>Account SID</strong> and <strong>Auth Token</strong> for use when configuring the Twilio Connector.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image275.png" title="Console" alt="On the Console, on the left, the Home button is selected. On the right, under Account Summary, Account SID and Auth Token are circled." /></p></li>
</ol>
<h4 id="subtask-2-create-a-new-logic-app">Subtask 2: Create a new logic app</h4>
<ol type="1">
<li><p>Open <strong>SQL Server Management Studio</strong> and connect to the SQL Database for the <strong>ContosoSportsDB</strong> database.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image276.png" title="Object Explorer" alt="In Object Explorer, ContosoSportsDBserver1234.database is selected." /></p></li>
<li><p>Under the <strong>ContosoSportsDB</strong> database, expand <strong>Programmability</strong>, right-click on <strong>Stored Procedures</strong>, click <strong>New</strong>, followed by <strong>Stored Procedure…</strong><br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image277.png" title="Object Explorer" alt="In Object Explorer, the following path is expanded: ContosoSportsDBserver1234.database\Databases\ContosoSportsDB\Programmability\Stored Procedures. From the right-click menu for the Stored Procedures, New / Stored Procedure is selected." /></p></li>
<li><p>Replace the Stored Procedure Template code with the following:</p>
<pre><code>CREATE PROCEDURE \[dbo\].\[GetUnprocessedOrders\]

AS

declare \@returnCode int

SELECT \@returnCode = COUNT(\*) FROM \[dbo\].\[Orders\] WHERE PaymentTransactionId is not null AND PaymentTransactionId \&lt;\&gt; \&#39;\&#39; AND Phone is not null AND Phone \&lt;\&gt; \&#39;\&#39; AND SMSOptIn = \&#39;1\&#39; AND SMSStatus is null

return \@returnCode

GO</code></pre></li>
<li><p>Click on <strong>Execute</strong> in the toolbar, or press the F5 key.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image278.png" title="Execute button" alt="Screenshot of the Execute button." /></p></li>
<li><p>Delete the SQL script for the Stored Procedure from the code editor, and replace it with the following:</p>
<pre><code>CREATE PROCEDURE \[dbo\].\[ProcessOrders\]

AS

SELECT \* FROM \[dbo\].\[Orders\] WHERE PaymentTransactionId is not null AND PaymentTransactionId \&lt;\&gt; \&#39;\&#39; AND Phone is not null AND Phone \&lt;\&gt; \&#39;\&#39; AND SMSOptIn = \&#39;1\&#39; AND SMSStatus is null;

UPDATE \[dbo\].\[Orders\] SET SMSStatus = \&#39;sent\&#39; WHERE PaymentTransactionId is not null AND PaymentTransactionId \&lt;\&gt; \&#39;\&#39; AND Phone is not null AND Phone \&lt;\&gt; \&#39;\&#39; AND SMSOptIn = \&#39;1\&#39; AND SMSStatus is null;</code></pre></li>
<li><p>Click on <strong>Execute</strong> in the toolbar, or press the F5 key.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image278.png" title="Execute button" alt="Screenshot of the Execute button." /></p></li>
<li><p>Open the Azure Management Portal (<a href="http://portal.azure.com" class="uri">http://portal.azure.com</a>), and click <strong>+New</strong> <strong>&gt; Web + Mobile &gt; Logic App</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image279.png" title="Azure Portal" alt="On the left side of the Azure Portal, the New button is selected. In the middle, under New, under Marketplace, Web + Mobile is selected. On the right, under Web + Mobile, Logic App is selected." /><figcaption>On the left side of the Azure Portal, the New button is selected. In the middle, under New, under Marketplace, Web + Mobile is selected. On the right, under Web + Mobile, Logic App is selected.</figcaption>
</figure></li>
<li><p>On the <strong>Create logic app</strong> blade, assign a value for <strong>Name</strong>, and set the Resource Group to <strong>contososports</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image280.png" title="Create logic app blade" alt="In the Create logic app blade, the Name field is set to contososportssms. Under Resource group, Use existing is selected, and contososports is selected." /><figcaption>In the Create logic app blade, the Name field is set to contososportssms. Under Resource group, Use existing is selected, and contososports is selected.</figcaption>
</figure></li>
<li><p>Open the Logic App by clicking <strong>More services -&gt; Logic Apps</strong>, and click on the Logic App just created.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image281.png" title="Azure Portal" alt="In the Azure Portal on the left, More services is selected, and Logic Apps displays on the right." /><figcaption>In the Azure Portal on the left, More services is selected, and Logic Apps displays on the right.</figcaption>
</figure></li>
<li><p>Select the <strong>Blank LogicApp</strong> Template.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image282.png" title="Logic Apps Designer" alt="In the Logic Apps Designer, the Blank Logic App tile is selected." /></p></li>
<li><p>On the <strong>Logic Apps Designer</strong>, click <strong>Schedule</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image283.png" title="Logic Apps Designer" alt="In the Logic Apps Designer, the Schedule tile is selected." /><figcaption>In the Logic Apps Designer, the Schedule tile is selected.</figcaption>
</figure></li>
<li><p>Set the <strong>FREQUENCY</strong> to <strong>MINUTE</strong>, and <strong>INTERVAL</strong> to 1.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image284.png" title="Recurrence section" alt="Under Recurrence, the Frequency field is Minute, and the Interval field is 1." /><figcaption>Under Recurrence, the Frequency field is Minute, and the Interval field is 1.</figcaption>
</figure></li>
<li><p>Click the <strong>New Step</strong> followed by <strong>Add an action</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image285.png" title="Recurrence section" alt="Under Recurrence, the New step button and Add an action buttons are selected." /><figcaption>Under Recurrence, the New step button and Add an action buttons are selected.</figcaption>
</figure></li>
<li><p>Type <strong>SQL Server</strong> into the filter box, and click the SQL <strong>Server – Execute stored procedure</strong> action.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image286.png" title="Choose an action section" alt="Under Choose an action, sql server is typed in the search field. On the Actions tab, SQL Server (Execute stored procedure) is selected." /><figcaption>Under Choose an action, sql server is typed in the search field. On the Actions tab, SQL Server (Execute stored procedure) is selected.</figcaption>
</figure></li>
<li><p>The first time you add a SQL action, you will be prompted for the connection information. Name the connection <strong>ContosoDB</strong>, input the server and database details used earlier, and click <strong>Create</strong>.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image287.png" title="SQL Server - Execute stored procedure section" alt="In the SQL Server - Execute stored procedure section, the Connection Name is contosoDB. Server and database details are the same as used earlier." /></p></li>
<li><p>Select the <strong>[dbo].[GetUnprocessedOrders]</strong> stored procedure from the drop-down on the Procedure Name field.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image288.png" title="Execute stored procedure section" alt="In the Execute stored procedure section, the Procedure name is [dbo].[GetUnprocessedOrders]." /><figcaption>In the Execute stored procedure section, the Procedure name is [dbo].[GetUnprocessedOrders].</figcaption>
</figure></li>
<li><p>Click on <strong>New Step</strong>, and click the <strong>Add a condition</strong> link.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image289.png" title="Buttons" alt="The New step and Add a condition buttons are selected." /><figcaption>The New step and Add a condition buttons are selected.</figcaption>
</figure></li>
<li><p>Specify <strong>ReturnCode</strong> for the OBJECT NAME, set the RELATIONSHIP to <strong>is greater than</strong>, and set the VALUE to <strong>0</strong>.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image290.png" title="Condition section" alt="Under Condition, Object Name is ReturnCode, Relationship is is greater than, and Value is 0." /><figcaption>Under Condition, Object Name is ReturnCode, Relationship is is greater than, and Value is 0.</figcaption>
</figure></li>
<li><p>Click the <strong>Add an action</strong> link on the <strong>If yes</strong> condition.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image291.png" title="If yes section" alt="Under If yes, do nothing, the Add an action button is selected." /><figcaption>Under If yes, do nothing, the Add an action button is selected.</figcaption>
</figure></li>
<li><p>Type <strong>SQL Server</strong> into the filter box, and click the <strong>SQL Server – Execute stored procedure</strong> action.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image292.png" title="If yes section" alt="Under If Yes, SQL Server - Execute stored procedure is circled." /><figcaption>Under If Yes, SQL Server - Execute stored procedure is circled.</figcaption>
</figure></li>
<li><p>Select the <strong>ProcessOrders</strong> stored procedure in the Procedure name dropdown.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image293.png" title="If yes section" alt="Under If Yes, Execute stored procedure 2 is selected, and the Procedure name is [dbo].[ProcessOrders]." /><figcaption>Under If Yes, Execute stored procedure 2 is selected, and the Procedure name is [dbo].[ProcessOrders].</figcaption>
</figure></li>
<li><p>Click the <strong>Add an action</strong> link.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image294.png" title="Add an action button" alt="The Add an action button is selected." /><figcaption>The Add an action button is selected.</figcaption>
</figure></li>
<li><p>Type <strong>Twilio</strong> in the filter box, and click the <strong>Twilio – Send Text Message (SMS)</strong> connector.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image295.png" title="Show Microsoft managed APIs" alt="Under Show Microsoft managed APIs, the Search box is set to Twilio, and below, Twilio - Send Text Message (SMS) is selected." /><figcaption>Under Show Microsoft managed APIs, the Search box is set to Twilio, and below, Twilio - Send Text Message (SMS) is selected.</figcaption>
</figure></li>
<li><p>Set the Connection Name to Twilio, specify your Twilio <strong>Account SID</strong> and <strong>Authentication Token</strong>, then click the <strong>Create</strong> button.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image296.png" title="Twilio - Send Text Message (SMS)" alt="In the Twilio - Send Text Message (SMS) section, fields are set to the previously defined settings." /><figcaption>In the Twilio - Send Text Message (SMS) section, fields are set to the previously defined settings.</figcaption>
</figure></li>
<li><p>Using the drop-down, select your Twilio number for the <strong>FROM PHONE NUMBER</strong> field. Specify a place holder phone number in the <strong>TO PHONE NUMBER</strong>, and a <strong>TEXT</strong> message.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image297.png" title="Send Text Message (SMS)" alt="Under Send Text Message (SMS), the From Phone Number and To Phone Number fields are circled, and in the Text field is the message, Hello, your order has shipped!" /></p></li>
<li><p>On the Logic App toolbar click the <strong>Code View</strong> button.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image298.png" title="Logic App toolbar" alt="The code view button is selected on the Logic App toolbar." /><figcaption>The code view button is selected on the Logic App toolbar.</figcaption>
</figure></li>
<li><p>Find the <strong>Send_Text_Message_(SMS)</strong> action, and modify the body property of the Twilio action:</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image299.png" title="Code view" alt="The Code view displays the text message, and the from and to phone numbers." /><figcaption>The Code view displays the text message, and the from and to phone numbers.</figcaption>
</figure>
<p>Add the following code between Hello and the comma.</p>
<p><strong>@{item()['FirstName']}</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image300.png" title="Code view" alt="The Code view now displays the added code in the text message." /><figcaption>The Code view now displays the added code in the text message.</figcaption>
</figure></li>
<li><p>Modify the <strong>to</strong> property to pull the phone number from the item.</p>
<p><strong>@{item()['Phone']}</strong></p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image301.png" title="Code view" alt="The to phone number code now displays the updated line of code." /><figcaption>The to phone number code now displays the updated line of code.</figcaption>
</figure></li>
<li><p>Immediately before the <strong>Send_Text_Message_(SMS)</strong>, create a new line, and add the following code:</p>
<pre><code>\&quot;forEach\_email\&quot;: {

\&quot;type\&quot;: \&quot;Foreach\&quot;,

\&quot;foreach\&quot;: \&quot;\@body(\&#39;Execute\_stored\_procedure\_2\&#39;)\[\&#39;ResultSets\&#39;\]\[\&#39;Table1\&#39;\]\&quot;,

\&quot;actions\&quot;: {</code></pre></li>
<li><p>Remove the <strong>runAfter</strong> block from the <strong>Send_Text_Message_(SMS)</strong> action.<br />
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image302.png" title="Code view" alt="The runAfter block of code displays." /></p></li>
<li><p>Locate the closing bracket of the <strong>Send_Text_Message_(SMS)</strong> action, create a new line after it, and add the following code:</p>
<pre><code>},

\&quot;runAfter\&quot;: {

\&quot;Execute\_stored\_procedure\_2\&quot;: \[

\&quot;Succeeded\&quot;

\]

}

}</code></pre></li>
<li><p>After the code for the <strong>Send_Text_Message_(SMS)</strong> has been modified to be contained within the <strong>forEach_email</strong> action, it should look like the following:</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image303.png" title="Code view" alt="The Code view displays the code from &quot;Foreach&quot; to &quot;Execute stored procedure.&quot;" /><figcaption>The Code view displays the code from &quot;Foreach&quot; to &quot;Execute stored procedure.&quot;</figcaption>
</figure></li>
<li><p>Click <strong>Save</strong> on the toolbar to enable the logic app.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image304.png" title="Logic Apps Designer toolbar" alt="On the Logic Apps Designer toolbar, the Save button is selected." /><figcaption>On the Logic Apps Designer toolbar, the Save button is selected.</figcaption>
</figure></li>
<li><p>Your workflow should look like below, and you should receive a text for each order you have placed.</p>
<figure>
<img src="images/Hands-onlabstep-by-step-Moderncloudappsimages/media/image305.png" title="Workflow diagram" alt="The Workflow diagram begins with Recurrence, then flows to Execute stored procedure, then to Condition. The Condition fields are as follows: Object Name, ReturnCode; Relationship, is greater than; Value, 0. Below the Workflow diagram is an If Yes box, with a workflow that begins wtih Execute stored procedure 2, and flows to forEach email. There is also an If No, Do Nothing box." /><figcaption>The Workflow diagram begins with Recurrence, then flows to Execute stored procedure, then to Condition. The Condition fields are as follows: Object Name, ReturnCode; Relationship, is greater than; Value, 0. Below the Workflow diagram is an If Yes box, with a workflow that begins wtih Execute stored procedure 2, and flows to forEach email. There is also an If No, Do Nothing box.</figcaption>
</figure></li>
</ol>
<h2 id="after-the-hands-on-lab">After the hands-on lab</h2>
<p>Duration: 10 minutes</p>
<h3 id="task-1-delete-resources">Task 1: Delete resources</h3>
<ol type="1">
<li>Since the HOL is now complete, go ahead and delete all of the Resource Groups that were created for this HOL. You will no longer need those resources and it will be beneficial to clean up your Azure Subscription.</li>
</ol>
<p>You should follow all steps provided <em>after</em> attending the hands-on lab.</p>
</body>
</html>
